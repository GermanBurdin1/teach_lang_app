<div class="training-container">
  <!-- Header -->
  <div class="training-header">
    <h1 class="page-title">
      <i class="fas fa-dumbbell"></i>
      Exercices d'Entraînement
    </h1>
    <p class="page-subtitle">Outils d'entraînement pour vos étudiants</p>
  </div>

  <!-- Training Sub-tabs -->
  <div class="training-tabs">
    <button 
      class="training-tab-btn"
      [class.active]="activeTrainingTab === 'audio'"
      (click)="setActiveTrainingTab('audio')">
      <i class="fas fa-headphones"></i>
      Écoute
    </button>
    <button 
      class="training-tab-btn"
      [class.active]="activeTrainingTab === 'reading'"
      (click)="setActiveTrainingTab('reading')">
      <i class="fas fa-book-open"></i>
      Lecture
    </button>
    <button 
      class="training-tab-btn"
      [class.active]="activeTrainingTab === 'writing'"
      (click)="setActiveTrainingTab('writing')">
      <i class="fas fa-pen"></i>
      Écriture
    </button>
    <button 
      class="training-tab-btn"
      [class.active]="activeTrainingTab === 'speaking'"
      (click)="setActiveTrainingTab('speaking')">
      <i class="fas fa-microphone"></i>
      Expression orale
    </button>
    <button 
      class="training-tab-btn"
      [class.active]="activeTrainingTab === 'grammar'"
      (click)="setActiveTrainingTab('grammar')">
      <i class="fas fa-language"></i>
      Grammaire
    </button>
  </div>

  <!-- Training Content -->
  <div class="training-content">
    <!-- Grammar Tab Content -->
    <div *ngIf="activeTrainingTab === 'grammar'" class="grammar-content">
      <!-- Part of Speech Content View -->
      <div *ngIf="selectedPartOfSpeech" class="part-of-speech-content">
        <button mat-button class="back-button" (click)="goBackToStructure()">
          <mat-icon>arrow_back</mat-icon>
          Retour à la structure
        </button>
        
        <h2 class="part-content-title">
          <mat-icon>{{ selectedPartOfSpeech.icon }}</mat-icon>
          {{ selectedPartOfSpeech.title }}
        </h2>

        <!-- Articles Content -->
        <div *ngIf="selectedPartOfSpeech.id === 'article'" class="pattern-cards-list">
          <!-- Description des Pattern Cards -->
          <div *ngIf="!showPatternCardsList" class="pattern-cards-description">
            <div class="description-content">
              <mat-icon class="description-icon">info</mat-icon>
              <h3>Exercices avec Pattern Cards</h3>
              <p>
                Les <strong>Pattern Cards</strong> sont des exercices interactifs qui vous permettent de pratiquer 
                la grammaire française de manière structurée. Chaque carte contient un modèle (pattern) avec des 
                espaces à remplir, vous aidant à comprendre et à maîtriser les règles grammaticales.
              </p>
              <p>
                <strong>Comment ça fonctionne :</strong>
              </p>
              <ul>
                <li>Chaque pattern card présente un modèle de phrase avec des éléments manquants</li>
                <li>Vous devez compléter les espaces vides en suivant les règles grammaticales</li>
                <li>Les exercices sont classés par niveau de difficulté (débutant, intermédiaire, avancé)</li>
                <li>Vous pouvez voir des exemples et des explications pour mieux comprendre</li>
              </ul>
              <button mat-raised-button color="primary" (click)="showPatternCards()" class="start-button">
                <mat-icon>play_arrow</mat-icon>
                Voir les exercices disponibles
              </button>
            </div>
          </div>

          <!-- Speed Challenge / Quick Quiz -->
          <div *ngIf="isSpeedChallengeActive" class="speed-challenge-container">
            <div class="speed-challenge-header">
              <div class="challenge-stats">
                <div class="stat-item">
                  <mat-icon>score</mat-icon>
                  <span class="stat-value">{{ score }}</span>
                  <span class="stat-label">Points</span>
                </div>
                <div class="stat-item">
                  <mat-icon>local_fire_department</mat-icon>
                  <span class="stat-value">{{ streak }}</span>
                  <span class="stat-label">Série</span>
                </div>
                <div class="stat-item">
                  <mat-icon>bolt</mat-icon>
                  <span class="stat-value">x{{ combo.toFixed(1) }}</span>
                  <span class="stat-label">Combo</span>
                </div>
                <div class="stat-item">
                  <mat-icon>timer</mat-icon>
                  <span class="stat-value">{{ timeLeft }}s</span>
                  <span class="stat-label">Temps</span>
                </div>
              </div>
              <button mat-icon-button (click)="stopSpeedChallenge()" class="close-challenge-btn">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <div class="progress-bar-container">
              <div class="progress-bar" [style.width.%]="(currentQuestionIndex / speedChallengeCards.length) * 100"></div>
              <span class="progress-text">Question {{ currentQuestionIndex + 1 }} / {{ speedChallengeCards.length }}</span>
            </div>

            <div class="question-container" *ngIf="currentQuestion">
              <div class="question-card" [class.correct]="showResult && isCorrect" [class.incorrect]="showResult && !isCorrect">
                <h3 class="question-text">{{ currentQuestion.question }}</h3>
                
                <div class="answer-options">
                  <button 
                    *ngFor="let option of currentQuestion.options" 
                    mat-raised-button
                    [class.selected]="selectedAnswer === option"
                    [class.correct-answer]="showResult && option === currentQuestion.correctAnswer"
                    [class.wrong-answer]="showResult && selectedAnswer === option && option !== currentQuestion.correctAnswer"
                    [disabled]="showResult"
                    (click)="selectAnswer(option)"
                    class="answer-button">
                    {{ option }}
                  </button>
                </div>

                <div *ngIf="showResult" class="result-feedback">
                  <div *ngIf="isCorrect" class="feedback correct-feedback">
                    <mat-icon>check_circle</mat-icon>
                    <span>Correct! +{{ (100 * combo + Math.floor(timeLeft * 10) + (streak > 1 ? (streak - 1) * 50 : 0)).toFixed(0) }} points</span>
                  </div>
                  <div *ngIf="!isCorrect" class="feedback incorrect-feedback">
                    <mat-icon>cancel</mat-icon>
                    <span>Incorrect. La bonne réponse est: <strong>{{ currentQuestion.correctAnswer }}</strong></span>
                  </div>
                  <div *ngIf="currentQuestion.example" class="example-hint">
                    <strong>Exemple:</strong> {{ currentQuestion.example }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Results Screen -->
            <div *ngIf="showResultsScreen" class="results-screen">
              <h2>Résultats du Défi</h2>
              <div class="results-stats">
                <div class="result-stat">
                  <mat-icon>score</mat-icon>
                  <span class="result-value">{{ score }}</span>
                  <span class="result-label">Points totaux</span>
                </div>
                <div class="result-stat">
                  <mat-icon>check_circle</mat-icon>
                  <span class="result-value">{{ correctAnswers }}</span>
                  <span class="result-label">Réponses correctes</span>
                </div>
                <div class="result-stat">
                  <mat-icon>cancel</mat-icon>
                  <span class="result-value">{{ wrongAnswers }}</span>
                  <span class="result-label">Réponses incorrectes</span>
                </div>
                <div class="result-stat">
                  <mat-icon>percent</mat-icon>
                  <span class="result-value">{{ getAccuracyPercentage() }}%</span>
                  <span class="result-label">Précision</span>
                </div>
              </div>
              <div class="results-actions">
                <button mat-raised-button color="primary" (click)="startSpeedChallenge(filteredPatternCards)">
                  <mat-icon>refresh</mat-icon>
                  Rejouer
                </button>
                <button mat-button (click)="stopSpeedChallenge()">
                  Retour aux exercices
                </button>
              </div>
            </div>
          </div>

          <!-- Liste des Pattern Cards -->
          <div *ngIf="showPatternCardsList && !isSpeedChallengeActive">
            <!-- Filtre par difficulté -->
            <div class="difficulty-filter" *ngIf="patternCards.length > 0">
              <mat-form-field appearance="outline">
                <mat-label>Filtrer par niveau</mat-label>
                <mat-select [value]="selectedDifficulty" (selectionChange)="selectedDifficulty = $event.value; onDifficultyChange()">
                  <mat-option value="all">Tous les niveaux</mat-option>
                  <mat-option value="beginner">Débutant</mat-option>
                  <mat-option value="intermediate">Intermédiaire</mat-option>
                  <mat-option value="advanced">Avancé</mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <div *ngIf="loadingPatternCards" class="loading-state">
              <p>Chargement des exercices...</p>
            </div>
            
            <div *ngIf="!loadingPatternCards && filteredPatternCards.length === 0" class="empty-state">
              <mat-icon>info</mat-icon>
              <p>Aucun exercice disponible pour ce niveau</p>
            </div>

            <!-- Кнопка для запуска Speed Challenge для всех карточек -->
            <div *ngIf="!loadingPatternCards && filteredPatternCards.length > 0" class="speed-challenge-banner">
              <div class="banner-content">
                <mat-icon class="banner-icon">flash_on</mat-icon>
                <div class="banner-text">
                  <h4>Défi Rapide</h4>
                  <p>Testez vos connaissances avec {{ filteredPatternCards.length }} exercices en mode rapide!</p>
                </div>
                <button mat-raised-button color="accent" (click)="startSpeedChallenge(filteredPatternCards)">
                  <mat-icon>play_arrow</mat-icon>
                  Commencer le défi
                </button>
              </div>
            </div>

            <div *ngIf="!loadingPatternCards && filteredPatternCards.length > 0" class="pattern-cards-grid">
              <div class="pattern-card-item" *ngFor="let card of filteredPatternCards">
                <div class="card-header">
                  <h3>{{ card.constructorTitle || card.pattern }}</h3>
                  <div class="card-author" *ngIf="card.authorName">
                    <mat-icon>person</mat-icon>
                    <span>{{ card.authorName }}</span>
                  </div>
                </div>
                <div class="card-content">
                  <p class="pattern-text"><strong>Pattern:</strong> {{ card.pattern }}</p>
                  <p class="example-text"><strong>Exemple:</strong> {{ card.example }}</p>
                  <div class="card-meta" *ngIf="card.difficulty">
                    <span class="difficulty-badge" [class]="'difficulty-' + card.difficulty">
                      {{ card.difficulty === 'beginner' ? 'Débutant' : card.difficulty === 'intermediate' ? 'Intermédiaire' : 'Avancé' }}
                    </span>
                  </div>
                </div>
                <div class="card-actions">
                  <button mat-button color="primary" (click)="startExercise(card)">
                    <mat-icon>play_arrow</mat-icon>
                    Commencer
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Other Parts of Speech Content -->
        <div *ngIf="selectedPartOfSpeech.id !== 'article'" class="coming-soon-content">
          <mat-icon>construction</mat-icon>
          <h3>Fonctionnalité en développement</h3>
          <p>Les exercices pour {{ selectedPartOfSpeech.title }} seront bientôt disponibles</p>
        </div>
      </div>

      <!-- Grammar Structure View -->
      <div *ngIf="!selectedPartOfSpeech" class="grammar-structure">
        <div class="grammar-category" *ngFor="let category of grammarStructure">
          <div class="category-header" (click)="toggleCategory(category.id)">
            <mat-icon class="expand-icon" [class.expanded]="isExpanded(category.id)">
              {{ isExpanded(category.id) ? 'expand_more' : 'chevron_right' }}
            </mat-icon>
            <mat-icon class="category-icon">{{ category.icon }}</mat-icon>
            <span class="category-title">{{ category.title }}</span>
          </div>
          
          <!-- Level 2: Children of first level -->
          <div class="category-children" *ngIf="isExpanded(category.id) && category.children">
            <div class="grammar-category level-2" *ngFor="let child of category.children">
              <div class="category-header" (click)="toggleCategory(child.id)">
                <mat-icon class="expand-icon" [class.expanded]="isExpanded(child.id)">
                  {{ isExpanded(child.id) ? 'expand_more' : 'chevron_right' }}
                </mat-icon>
                <mat-icon class="category-icon">{{ child.icon }}</mat-icon>
                <span class="category-title">{{ child.title }}</span>
              </div>
              
              <!-- Level 3: Children of second level -->
              <div class="category-children" *ngIf="isExpanded(child.id) && child.children">
                <div class="grammar-category level-3" *ngFor="let subChild of child.children">
                  <div class="category-header" (click)="toggleCategory(subChild.id)">
                    <mat-icon class="expand-icon" [class.expanded]="isExpanded(subChild.id)">
                      {{ isExpanded(subChild.id) ? 'expand_more' : 'chevron_right' }}
                    </mat-icon>
                    <mat-icon class="category-icon">{{ subChild.icon }}</mat-icon>
                    <span class="category-title">{{ subChild.title }}</span>
                  </div>
                  
                  <!-- Level 4: Final level (parts of speech) -->
                  <div class="category-children" *ngIf="isExpanded(subChild.id) && subChild.children">
                    <div class="part-of-speech-item" *ngFor="let partOfSpeech of subChild.children" (click)="selectPartOfSpeech(partOfSpeech)">
                      <mat-icon class="part-icon">{{ partOfSpeech.icon }}</mat-icon>
                      <span class="part-title">{{ partOfSpeech.title }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Other tabs content -->
    <div *ngIf="activeTrainingTab !== 'grammar'" class="coming-soon">
      <i class="fas fa-tools"></i>
      <h3>Fonctionnalité en développement</h3>
      <p>Les exercices d'entraînement seront bientôt disponibles</p>
    </div>
  </div>
</div>

