<div class="dashboard-layout">
  <app-sidebar></app-sidebar>

  <div class="dashboard-content">
    <div class="create-wrapper">
      <header class="create-header" *ngIf="typeConfig">
        <div>
          <p class="eyebrow">Création de constructeur</p>
          <h1>{{ typeConfig.title }}</h1>
          <p class="subtitle">
            {{ typeConfig.description }}
          </p>
        </div>
        <div class="actions">
          <button mat-stroked-button color="primary" type="button" (click)="goBack($event)">
            <mat-icon>arrow_back</mat-icon>
            Retour
          </button>
        </div>
      </header>

      <section class="create-content mat-elevation-z2" *ngIf="typeConfig">
        <!-- Drill-grid Creator -->
        <div class="drill-grid-creator" *ngIf="constructorType === 'drill_grid'">
          <div class="creator-header">
            <h3>Créer votre drill-grid</h3>
            <button mat-stroked-button color="primary" (click)="toggleMyDrillGrids()">
              <mat-icon>folder</mat-icon>
              Consulter mes drill-grids ({{ savedDrillGrids.length }})
            </button>
          </div>

          <!-- Saved Drill-grids List -->
          <div class="saved-grids-list" *ngIf="showMyDrillGrids">
            <h4>Mes drill-grids sauvegardées</h4>
            
            <!-- Tabs for filtering -->
            <mat-tab-group [(selectedIndex)]="drillGridTabIndex" (selectedIndexChange)="onTabChange($event)">
              <mat-tab>
                <ng-template mat-tab-label>
                  Toutes ({{ savedDrillGrids.length }})
                </ng-template>
                <div class="grids-grid">
                  <div class="saved-grid-card" *ngFor="let grid of filteredDrillGrids" [class.homework-grid]="grid.type === 'homework'">
                    <div class="grid-card-header">
                      <div class="grid-name-edit">
                        <input matInput [(ngModel)]="grid.editName" [placeholder]="grid.name" class="grid-name-input">
                        <button mat-icon-button color="primary" (click)="saveGridName(grid)" [disabled]="!grid.editName || !grid.editName.trim()">
                          <mat-icon>save</mat-icon>
                        </button>
                      </div>
                      <mat-chip [class]="grid.type === 'info' ? 'info-chip' : 'homework-chip'">
                        {{ grid.type === 'info' ? 'Information' : 'Devoir' }}
                      </mat-chip>
                    </div>
                    <div class="grid-card-actions">
                      <button 
                        mat-icon-button 
                        color="primary" 
                        (click)="loadDrillGrid(grid)" 
                        title="Modifier">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button color="primary" (click)="viewDrillGrid(grid)" title="Voir">
                        <mat-icon>visibility</mat-icon>
                      </button>
                      <button mat-icon-button color="accent" (click)="duplicateDrillGrid(grid)" title="Dupliquer">
                        <mat-icon>content_copy</mat-icon>
                      </button>
                      <button 
                        mat-icon-button 
                        color="warn" 
                        (click)="deleteDrillGrid(grid.id)" 
                        title="Supprimer">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                    <p class="grid-info">{{ grid.rows.length }} lignes × {{ grid.columns.length }} colonnes</p>
                    <p class="grid-date">{{ grid.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>
                    <p class="grid-note" *ngIf="grid.type === 'info'">
                      <mat-icon class="info-icon">info</mat-icon>
                      Lecture seule - pour information
                    </p>
                    <p class="grid-note" *ngIf="grid.type === 'homework'">
                      <mat-icon class="homework-icon">assignment</mat-icon>
                      Devoir - modifiable
                    </p>
                  </div>
                </div>
                <div *ngIf="filteredDrillGrids.length === 0" class="no-grids">
                  <p>Aucune drill-grid sauvegardée</p>
                </div>
              </mat-tab>
              
              <mat-tab>
                <ng-template mat-tab-label>
                  Information ({{ infoDrillGrids.length }})
                </ng-template>
                <div class="grids-grid">
                  <div class="saved-grid-card" *ngFor="let grid of infoDrillGrids">
                    <div class="grid-card-header">
                      <div class="grid-name-edit">
                        <input matInput [(ngModel)]="grid.editName" [placeholder]="grid.name" class="grid-name-input">
                        <button mat-icon-button color="primary" (click)="saveGridName(grid)" [disabled]="!grid.editName || !grid.editName.trim()">
                          <mat-icon>save</mat-icon>
                        </button>
                      </div>
                      <mat-chip class="info-chip">Information</mat-chip>
                    </div>
                    <div class="grid-card-actions">
                      <button 
                        mat-icon-button 
                        color="primary" 
                        (click)="loadDrillGrid(grid)" 
                        title="Modifier">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button color="primary" (click)="viewDrillGrid(grid)" title="Voir">
                        <mat-icon>visibility</mat-icon>
                      </button>
                      <button mat-icon-button color="accent" (click)="duplicateDrillGrid(grid)" title="Dupliquer">
                        <mat-icon>content_copy</mat-icon>
                      </button>
                      <button 
                        mat-icon-button 
                        color="warn" 
                        (click)="deleteDrillGrid(grid.id)" 
                        title="Supprimer">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                    <p class="grid-info">{{ grid.rows.length }} lignes × {{ grid.columns.length }} colonnes</p>
                    <p class="grid-date">{{ grid.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>
                    <p class="grid-note">
                      <mat-icon class="info-icon">info</mat-icon>
                      Lecture seule - pour information
                    </p>
                  </div>
                </div>
                <div *ngIf="infoDrillGrids.length === 0" class="no-grids">
                  <p>Aucune drill-grid d'information</p>
                </div>
              </mat-tab>
              
              <mat-tab>
                <ng-template mat-tab-label>
                  Devoirs ({{ homeworkDrillGrids.length }})
                </ng-template>
                <div class="grids-grid">
                  <div class="saved-grid-card homework-grid" *ngFor="let grid of homeworkDrillGrids">
                    <div class="grid-card-header">
                      <div class="grid-name-edit">
                        <input matInput [(ngModel)]="grid.editName" [placeholder]="grid.name" class="grid-name-input">
                        <button mat-icon-button color="primary" (click)="saveGridName(grid)" [disabled]="!grid.editName || !grid.editName.trim()">
                          <mat-icon>save</mat-icon>
                        </button>
                      </div>
                      <mat-chip class="homework-chip">Devoir</mat-chip>
                    </div>
                    <div class="grid-card-actions">
                      <button mat-icon-button color="primary" (click)="loadDrillGrid(grid)" title="Modifier">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button color="accent" (click)="duplicateDrillGrid(grid)" title="Dupliquer">
                        <mat-icon>content_copy</mat-icon>
                      </button>
                      <button 
                        mat-icon-button 
                        color="warn" 
                        (click)="deleteDrillGrid(grid.id)" 
                        [disabled]="!isTeacher()"
                        title="Supprimer">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                    <p class="grid-info">{{ grid.rows.length }} lignes × {{ grid.columns.length }} colonnes</p>
                    <p class="grid-date">{{ grid.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>
                    <p class="grid-note">
                      <mat-icon class="homework-icon">assignment</mat-icon>
                      Devoir - modifiable
                    </p>
                  </div>
                </div>
                <div *ngIf="homeworkDrillGrids.length === 0" class="no-grids">
                  <p>Aucun devoir drill-grid</p>
                </div>
              </mat-tab>
            </mat-tab-group>
          </div>

          <!-- Режим просмотра drill-grid -->
          <div class="drill-grid-step" *ngIf="viewingDrillGrid">
            <h3>Voir la drill-grid: {{ viewingDrillGrid.name }}</h3>
            <div class="drill-grid-viewer">
              <div class="drill-grid-table">
                <!-- Header row -->
                <div class="drill-row">
                  <div class="drill-cell header-cell empty-header"></div>
                  <div class="drill-cell header-cell" *ngFor="let col of getGridColumnsArray(viewingDrillGrid)">
                    {{ col }}
                  </div>
                </div>
                <!-- Data rows -->
                <div class="drill-row" *ngFor="let row of getGridRowsArray(viewingDrillGrid); let rowIdx = index">
                  <div class="drill-cell header-cell">
                    {{ row }}
                  </div>
                  <div class="drill-cell view-cell" *ngFor="let col of getGridColumnsArray(viewingDrillGrid); let colIdx = index">
                    <div class="cell-content">
                      {{ getViewCellContent(viewingDrillGrid, rowIdx, colIdx) }}
                    </div>
                    <div class="cell-answer" *ngIf="getViewCellCorrectAnswer(viewingDrillGrid, rowIdx, colIdx)">
                      <mat-icon class="check-icon">check_circle</mat-icon>
                      Réponse: {{ getViewCellCorrectAnswer(viewingDrillGrid, rowIdx, colIdx) }}
                    </div>
                    <div class="cell-editable-badge" *ngIf="getViewCellEditable(viewingDrillGrid, rowIdx, colIdx)">
                      <mat-icon>edit</mat-icon>
                      Modifiable
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="view-actions">
              <button 
                mat-raised-button 
                color="primary" 
                (click)="loadDrillGrid(viewingDrillGrid)">
                <mat-icon>edit</mat-icon>
                Modifier
              </button>
              <button mat-raised-button (click)="viewingDrillGrid = null">
                Fermer
              </button>
            </div>
          </div>

          <!-- Step 1: Name the drill-grid -->
          <div class="drill-grid-step" *ngIf="!viewingDrillGrid">
            <h4>1. Nommer la drill-grid</h4>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Nom de la drill-grid</mat-label>
              <input matInput [(ngModel)]="drillGridName" placeholder="Ex: Conjugaison des verbes réguliers">
            </mat-form-field>
            
            <!-- Выбор purpose -->
            <div class="purpose-selector" *ngIf="(editingDrillGrid || drillGridRows.length > 0) && isTeacher()">
              <h5>Type de drill-grid:</h5>
              <mat-form-field appearance="outline">
                <mat-label>Purpose</mat-label>
                <mat-select [(ngModel)]="drillGridPurpose" (selectionChange)="changeDrillGridPurpose($event.value)">
                  <mat-option value="info">Information (lecture seule pour étudiants)</mat-option>
                  <mat-option value="homework">Devoir (modifiable par étudiant et professeur)</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <!-- Step 3: Choose course (optional) -->
          <div class="drill-grid-step">
            <h4>3. Choisir un cours (optionnel)</h4>
            <p class="step-description">Associez la drill-grid à un parcours existant quand vous le souhaitez.</p>
            <!-- Course selection will be added later -->
          </div>

          <!-- Step 2: Configure Matrix -->
          <div class="drill-grid-step">
            <div class="step-header-with-toggle">
              <h4>2. Configurer la matrice</h4>
              <div class="view-mode-toggle" *ngIf="drillGridRows.length > 0 && drillGridColumns.length > 0">
                <button 
                  mat-raised-button 
                  color="primary"
                  (click)="openMatrixModal('config')">
                  <mat-icon>edit</mat-icon>
                  Configuration
                </button>
                <button 
                  mat-raised-button 
                  color="primary"
                  (click)="openMatrixModal('preview')">
                  <mat-icon>visibility</mat-icon>
                  Aperçu final
                </button>
              </div>
            </div>
            
            <!-- Мини-превью таблицы -->
            <div class="matrix-mini-preview" *ngIf="drillGridRows.length > 0 && drillGridColumns.length > 0">
              <div class="mini-preview-header">
                <h5>Aperçu de la matrice</h5>
              </div>
              <div class="mini-preview-table-wrapper">
                <div class="mini-preview-table">
                  <!-- Header row -->
                  <div class="mini-preview-row">
                    <div class="mini-preview-cell mini-preview-header-cell" [ngStyle]="getMiniPreviewHeaderStyle()"></div>
                    <div class="mini-preview-cell mini-preview-header-cell" 
                         *ngFor="let col of drillGridColumns; let colIdx = index"
                         [ngStyle]="getMiniPreviewHeaderStyle()">
                      {{ col || 'Colonne ' + (colIdx + 1) }}
                    </div>
                  </div>
                  <!-- Data rows -->
                  <div class="mini-preview-row" *ngFor="let row of drillGridRows; let rowIdx = index">
                    <div class="mini-preview-cell mini-preview-header-cell" [ngStyle]="getMiniPreviewFirstColStyle()">
                      {{ row || 'Ligne ' + (rowIdx + 1) }}
                    </div>
                    <div class="mini-preview-cell" 
                         *ngFor="let col of drillGridColumns; let colIdx = index"
                         [ngStyle]="getMiniPreviewCellStyle(rowIdx, colIdx)">
                      {{ getCellValue(rowIdx, colIdx) || '...' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Matrix Configuration -->
            <div class="matrix-config">
              <div class="config-row">
                <button mat-raised-button color="primary" (click)="openMatrixModal('config')">
                  <mat-icon>settings</mat-icon>
                  Configurer la matrice
                </button>
                <p class="config-hint">
                  <mat-icon>info</mat-icon>
                  Cliquez sur "Configurer la matrice" pour définir le nombre de lignes et colonnes, ainsi que les styles
                </p>
              </div>
            </div>

            <!-- Matrix Editor Preview (мини-превью) -->
            <div class="matrix-editor-preview" *ngIf="drillGridRows.length > 0 && drillGridColumns.length > 0">
              <p class="preview-hint">
                <mat-icon>info</mat-icon>
                Cliquez sur "Configuration" ou "Aperçu final" pour ouvrir la matrice en plein écran
              </p>
            </div>

            <!-- Matrix Editor (старый код, можно удалить после тестирования) -->
            <div class="matrix-editor" *ngIf="false && drillGridRows.length > 0 && drillGridColumns.length > 0">
              <div class="drill-table-editable">
                <!-- Header row with column labels -->
                <div class="drill-header-row">
                  <div class="drill-cell header-cell corner-cell"></div>
                  <div class="drill-cell header-cell" *ngFor="let col of drillGridColumns; let colIdx = index">
                    <input 
                      type="text" 
                      [(ngModel)]="drillGridColumns[colIdx]" 
                      placeholder="Colonne {{ colIdx + 1 }}"
                      class="header-input">
                    <button 
                      mat-icon-button 
                      *ngIf="drillGridColumns.length > 1"
                      (click)="removeColumn(colIdx)"
                      class="remove-btn"
                      title="Supprimer la colonne">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                  <button mat-icon-button color="primary" (click)="addColumn()" class="add-btn" title="Ajouter une colonne">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>

                <!-- Data rows -->
                <div class="drill-row" *ngFor="let row of drillGridRows; let rowIdx = index">
                  <div class="drill-cell header-cell">
                    <input 
                      type="text" 
                      [(ngModel)]="drillGridRows[rowIdx]" 
                      placeholder="Ligne {{ rowIdx + 1 }}"
                      class="header-input">
                    <button 
                      mat-icon-button 
                      *ngIf="drillGridRows.length > 1"
                      (click)="removeRow(rowIdx)"
                      class="remove-btn"
                      title="Supprimer la ligne">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                  <div 
                    class="drill-cell editable-cell" 
                    [class.has-correct-answer]="getCellData(rowIdx, colIdx).correctAnswer"
                    [class.is-editable]="getCellData(rowIdx, colIdx).isEditable"
                    *ngFor="let col of drillGridColumns; let colIdx = index">
                    <div class="cell-input-wrapper">
                      <input 
                        type="text" 
                        [value]="getCellValue(rowIdx, colIdx)"
                        (input)="updateCell(rowIdx, colIdx, $any($event.target).value)"
                        placeholder="..."
                        class="cell-input"
                        [readonly]="false">
                      <div class="cell-controls">
                        <button 
                          mat-icon-button 
                          [color]="getCellData(rowIdx, colIdx).isEditable ? 'primary' : ''"
                          (click)="toggleCellEditable(rowIdx, colIdx)"
                          [title]="getCellData(rowIdx, colIdx).isEditable ? 'Rendre non modifiable' : 'Rendre modifiable'"
                          class="cell-control-btn">
                          <mat-icon>{{ getCellData(rowIdx, colIdx).isEditable ? 'lock_open' : 'lock' }}</mat-icon>
                        </button>
                        <button 
                          mat-icon-button 
                          [color]="getCellData(rowIdx, colIdx).correctAnswer ? 'accent' : ''"
                          (click)="openCorrectAnswerDialog(rowIdx, colIdx)"
                          title="Définir la réponse correcte"
                          class="cell-control-btn">
                          <mat-icon>check_circle</mat-icon>
                        </button>
                      </div>
                    </div>
                    <div class="cell-answer-display" *ngIf="getCellData(rowIdx, colIdx).correctAnswer">
                      <mat-icon class="check-icon">check</mat-icon>
                      {{ getCellData(rowIdx, colIdx).correctAnswer }}
                    </div>
                  </div>
                </div>

                <!-- Add row button -->
                <div class="add-row-container" *ngIf="matrixViewMode === 'config'">
                  <button mat-raised-button color="primary" (click)="addRow()">
                    <mat-icon>add</mat-icon>
                    Ajouter une ligne
                  </button>
                </div>
              </div>

              <!-- Save button -->
              <div class="save-container" *ngIf="matrixViewMode === 'config'">
                <button 
                  mat-raised-button 
                  color="accent" 
                  (click)="saveDrillGrid()" 
                  [disabled]="!drillGridName.trim()">
                  <mat-icon>save</mat-icon>
                  {{ editingDrillGrid ? 'Mettre à jour' : 'Sauvegarder' }} la drill-grid
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Пример структуры для Flowchart -->
        <div class="example-preview" *ngIf="constructorType === 'flowchart'">
          <h3 class="example-title">Exemple de structure Flowchart</h3>
          <div class="flowchart-example">
            <div class="flowchart-container">
              <div class="flowchart-node start-node">
                <div class="node-content">Début</div>
              </div>
              <div class="flowchart-arrow">↓</div>
              <div class="flowchart-node decision-node">
                <div class="node-content">Quel temps ?</div>
              </div>
              <div class="flowchart-branches">
                <div class="flowchart-branch">
                  <div class="branch-label">Présent</div>
                  <div class="flowchart-arrow">→</div>
                  <div class="flowchart-node action-node">
                    <div class="node-content">Utiliser la forme de base</div>
                  </div>
                </div>
                <div class="flowchart-branch">
                  <div class="branch-label">Passé</div>
                  <div class="flowchart-arrow">→</div>
                  <div class="flowchart-node action-node">
                    <div class="node-content">Ajouter "avoir" + participe</div>
                  </div>
                </div>
                <div class="flowchart-branch">
                  <div class="branch-label">Futur</div>
                  <div class="flowchart-arrow">→</div>
                  <div class="flowchart-node action-node">
                    <div class="node-content">Ajouter la terminaison future</div>
                  </div>
                </div>
              </div>
              <div class="flowchart-arrow">↓</div>
              <div class="flowchart-node result-node">
                <div class="node-content">Résultat</div>
              </div>
            </div>
            <p class="example-description">
              Guidez les étudiants à travers un processus de décision étape par étape pour choisir la bonne forme grammaticale.
            </p>
          </div>
        </div>

        <!-- Пример структуры для Pattern-card -->
        <div class="example-preview" *ngIf="constructorType === 'pattern_card'">
          <h3 class="example-title">Exemple de structure Pattern-card</h3>
          <div class="pattern-card-example">
            <div class="pattern-template">
              <div class="pattern-header">
                <span class="pattern-label">Modèle:</span>
                <span class="pattern-text">Je voudrais <span class="blank">[VERB]</span> <span class="blank">[OBJECT]</span></span>
              </div>
              <div class="pattern-example">
                <span class="pattern-label">Exemple:</span>
                <span class="pattern-text">Je voudrais <span class="filled">acheter</span> <span class="filled">un livre</span></span>
              </div>
            </div>
            <div class="pattern-blanks">
              <div class="blank-item">
                <span class="blank-id">[VERB]</span>
                <span class="blank-hint">→ acheter, lire, écrire...</span>
              </div>
              <div class="blank-item">
                <span class="blank-id">[OBJECT]</span>
                <span class="blank-hint">→ un livre, une voiture, un café...</span>
              </div>
            </div>
            <div class="pattern-stages">
              <div class="stage-item">
                <span class="stage-number">1</span>
                <span class="stage-text">Voir l'exemple complet</span>
              </div>
              <div class="stage-item">
                <span class="stage-number">2</span>
                <span class="stage-text">Remplir les emplacements</span>
              </div>
              <div class="stage-item">
                <span class="stage-number">3</span>
                <span class="stage-text">Créer ses propres phrases</span>
              </div>
            </div>
            <p class="example-description">
              Aidez les étudiants à automatiser des structures de phrases courantes en français à travers des exercices progressifs.
            </p>
          </div>
        </div>

        <!-- Placeholder для Mindmap (можно оставить как есть или добавить пример) -->
        <div class="form-placeholder" *ngIf="constructorType === 'mindmap'">
          <mat-icon>{{ typeConfig.icon }}</mat-icon>
          <h2>Zone de configuration en préparation</h2>
          <p>
            Ici vous pourrez sélectionner un cours, définir le titre, préciser la durée et préparer la structure de base de la mindmap.
          </p>
        </div>

        <div class="steps">
          <div class="step-card" *ngFor="let step of steps; let idx = index">
            <div class="step-index">0{{ idx + 1 }}</div>
            <h3>{{ step.title }}</h3>
            <p>{{ step.description }}</p>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>
