<div class="drill-grid-modal-container">
  <div class="modal-header">
    <h2>
      <mat-icon>{{ mode === 'config' ? 'edit' : 'visibility' }}</mat-icon>
      {{ mode === 'config' ? 'Configuration de la matrice' : 'Aperçu final' }}
    </h2>
    <button mat-icon-button (click)="close()" class="close-btn">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="modal-content">
    <!-- Режим предпросмотра -->
    <div class="preview-mode" *ngIf="mode === 'preview'">
      <div class="drill-grid-viewer">
        <div class="drill-grid-table">
          <!-- Header row -->
          <div class="drill-row">
            <div class="drill-cell header-cell empty-header" [ngStyle]="getHeaderStyle()"></div>
            <div class="drill-cell header-cell" *ngFor="let col of getGridColumnsArray(getCurrentMatrixForPreview())" [ngStyle]="getHeaderStyle()">
              {{ col }}
            </div>
          </div>
          <!-- Data rows -->
          <div class="drill-row" *ngFor="let row of getGridRowsArray(getCurrentMatrixForPreview()); let rowIdx = index">
            <div class="drill-cell header-cell" [ngStyle]="getFirstColStyle()">
              {{ row }}
            </div>
            <div class="drill-cell view-cell" *ngFor="let col of getGridColumnsArray(getCurrentMatrixForPreview()); let colIdx = index" [ngStyle]="getCellStyle(rowIdx, colIdx)">
              <div class="cell-content">
                {{ getViewCellContent(getCurrentMatrixForPreview(), rowIdx, colIdx) }}
              </div>
              <div class="cell-answer" *ngIf="getViewCellCorrectAnswer(getCurrentMatrixForPreview(), rowIdx, colIdx)">
                <mat-icon class="check-icon">check_circle</mat-icon>
                Réponse: {{ getViewCellCorrectAnswer(getCurrentMatrixForPreview(), rowIdx, colIdx) }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Режим конфигурации -->
    <div class="config-mode" *ngIf="mode === 'config'">
      <div class="style-panel">
        <h4 class="style-panel-title">
          <mat-icon>palette</mat-icon>
          Style de la table
        </h4>
        
        <mat-tab-group [(selectedIndex)]="selectedTabIndex" class="style-tabs">
          <!-- Tab: Заголовки (Headers) -->
          <mat-tab label="En-têtes">
            <mat-card class="style-card">
              <div class="style-section">
                <h5 class="section-title">
                  <mat-icon>title</mat-icon>
                  Style des en-têtes
                </h5>
                
                <div class="style-controls-grid">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Police</mat-label>
                    <mat-select [(ngModel)]="tableStyle.header.fontFamily">
                      <mat-option value="Inter">Inter</mat-option>
                      <mat-option value="Roboto">Roboto</mat-option>
                      <mat-option value="Arial">Arial</mat-option>
                      <mat-option value="Times New Roman">Times New Roman</mat-option>
                      <mat-option value="Georgia">Georgia</mat-option>
                      <mat-option value="Verdana">Verdana</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Taille de police</mat-label>
                    <input matInput type="number" [(ngModel)]="tableStyle.header.fontSize" min="10" max="40">
                    <span matSuffix>px</span>
                  </mat-form-field>

                  <div class="color-picker-group">
                    <label class="color-label">
                      <mat-icon>format_color_text</mat-icon>
                      Couleur du texte
                    </label>
                    <div class="color-input-wrapper">
                      <input type="color" [(ngModel)]="tableStyle.header.textColor" class="color-input">
                      <input type="text" [(ngModel)]="tableStyle.header.textColor" class="color-hex-input" placeholder="#111827">
                    </div>
                  </div>

                  <div class="color-picker-group">
                    <label class="color-label">
                      <mat-icon>format_color_fill</mat-icon>
                      Couleur de fond
                    </label>
                    <div class="color-input-wrapper">
                      <input type="color" [(ngModel)]="tableStyle.header.bgColor" class="color-input">
                      <input type="text" [(ngModel)]="tableStyle.header.bgColor" class="color-hex-input" placeholder="#f3f4f6">
                    </div>
                  </div>
                </div>

                <div class="formatting-buttons">
                  <button mat-stroked-button 
                          type="button" 
                          (click)="tableStyle.header.bold = !tableStyle.header.bold" 
                          [class.active]="tableStyle.header.bold"
                          class="format-btn">
                    <mat-icon>format_bold</mat-icon>
                    <span>Gras</span>
                  </button>
                  <button mat-stroked-button 
                          type="button" 
                          (click)="tableStyle.header.italic = !tableStyle.header.italic" 
                          [class.active]="tableStyle.header.italic"
                          class="format-btn">
                    <mat-icon>format_italic</mat-icon>
                    <span>Italique</span>
                  </button>
                  <button mat-stroked-button 
                          type="button" 
                          (click)="tableStyle.header.underline = !tableStyle.header.underline" 
                          [class.active]="tableStyle.header.underline"
                          class="format-btn">
                    <mat-icon>format_underlined</mat-icon>
                    <span>Souligné</span>
                  </button>
                </div>
              </div>
            </mat-card>
          </mat-tab>

          <!-- Tab: Первая колонка (First Column) -->
          <mat-tab label="Première colonne">
            <mat-card class="style-card">
              <div class="style-section">
                <h5 class="section-title">
                  <mat-icon>view_column</mat-icon>
                  Style de la première colonne
                </h5>
                
                <div class="style-controls-grid">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Police</mat-label>
                    <mat-select [(ngModel)]="tableStyle.firstCol.fontFamily">
                      <mat-option value="Inter">Inter</mat-option>
                      <mat-option value="Roboto">Roboto</mat-option>
                      <mat-option value="Arial">Arial</mat-option>
                      <mat-option value="Times New Roman">Times New Roman</mat-option>
                      <mat-option value="Georgia">Georgia</mat-option>
                      <mat-option value="Verdana">Verdana</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Taille de police</mat-label>
                    <input matInput type="number" [(ngModel)]="tableStyle.firstCol.fontSize" min="10" max="40">
                    <span matSuffix>px</span>
                  </mat-form-field>

                  <div class="color-picker-group">
                    <label class="color-label">
                      <mat-icon>format_color_text</mat-icon>
                      Couleur du texte
                    </label>
                    <div class="color-input-wrapper">
                      <input type="color" [(ngModel)]="tableStyle.firstCol.textColor" class="color-input">
                      <input type="text" [(ngModel)]="tableStyle.firstCol.textColor" class="color-hex-input" placeholder="#111827">
                    </div>
                  </div>

                  <div class="color-picker-group">
                    <label class="color-label">
                      <mat-icon>format_color_fill</mat-icon>
                      Couleur de fond
                    </label>
                    <div class="color-input-wrapper">
                      <input type="color" [(ngModel)]="tableStyle.firstCol.bgColor" class="color-input">
                      <input type="text" [(ngModel)]="tableStyle.firstCol.bgColor" class="color-hex-input" placeholder="#f9fafb">
                    </div>
                  </div>
                </div>

                <div class="formatting-buttons">
                  <button mat-stroked-button 
                          type="button" 
                          (click)="tableStyle.firstCol.bold = !tableStyle.firstCol.bold" 
                          [class.active]="tableStyle.firstCol.bold"
                          class="format-btn">
                    <mat-icon>format_bold</mat-icon>
                    <span>Gras</span>
                  </button>
                  <button mat-stroked-button 
                          type="button" 
                          (click)="tableStyle.firstCol.italic = !tableStyle.firstCol.italic" 
                          [class.active]="tableStyle.firstCol.italic"
                          class="format-btn">
                    <mat-icon>format_italic</mat-icon>
                    <span>Italique</span>
                  </button>
                  <button mat-stroked-button 
                          type="button" 
                          (click)="tableStyle.firstCol.underline = !tableStyle.firstCol.underline" 
                          [class.active]="tableStyle.firstCol.underline"
                          class="format-btn">
                    <mat-icon>format_underlined</mat-icon>
                    <span>Souligné</span>
                  </button>
                </div>
              </div>
            </mat-card>
          </mat-tab>

          <!-- Tab: Ячейки (Cells) -->
          <mat-tab label="Cellules">
            <mat-card class="style-card">
              <div class="style-section">
                <h5 class="section-title">
                  <mat-icon>table_chart</mat-icon>
                  Style des cellules
                </h5>
                
                <div class="style-controls-grid">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Police</mat-label>
                    <mat-select [(ngModel)]="tableStyle.cells.fontFamily">
                      <mat-option value="Inter">Inter</mat-option>
                      <mat-option value="Roboto">Roboto</mat-option>
                      <mat-option value="Arial">Arial</mat-option>
                      <mat-option value="Times New Roman">Times New Roman</mat-option>
                      <mat-option value="Georgia">Georgia</mat-option>
                      <mat-option value="Verdana">Verdana</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Taille de police</mat-label>
                    <input matInput type="number" [(ngModel)]="tableStyle.cells.fontSize" min="10" max="40">
                    <span matSuffix>px</span>
                  </mat-form-field>

                  <div class="color-picker-group">
                    <label class="color-label">
                      <mat-icon>format_color_text</mat-icon>
                      Couleur du texte
                    </label>
                    <div class="color-input-wrapper">
                      <input type="color" [(ngModel)]="tableStyle.cells.textColor" class="color-input">
                      <input type="text" [(ngModel)]="tableStyle.cells.textColor" class="color-hex-input" placeholder="#111827">
                    </div>
                  </div>

                  <div class="color-picker-group">
                    <label class="color-label">
                      <mat-icon>format_color_fill</mat-icon>
                      Couleur de fond
                    </label>
                    <div class="color-input-wrapper">
                      <input type="color" [(ngModel)]="tableStyle.cells.bgColor" class="color-input">
                      <input type="text" [(ngModel)]="tableStyle.cells.bgColor" class="color-hex-input" placeholder="#ffffff">
                    </div>
                  </div>
                </div>

                <div class="formatting-buttons">
                  <button mat-stroked-button 
                          type="button" 
                          (click)="tableStyle.cells.bold = !tableStyle.cells.bold" 
                          [class.active]="tableStyle.cells.bold"
                          class="format-btn">
                    <mat-icon>format_bold</mat-icon>
                    <span>Gras</span>
                  </button>
                  <button mat-stroked-button 
                          type="button" 
                          (click)="tableStyle.cells.italic = !tableStyle.cells.italic" 
                          [class.active]="tableStyle.cells.italic"
                          class="format-btn">
                    <mat-icon>format_italic</mat-icon>
                    <span>Italique</span>
                  </button>
                  <button mat-stroked-button 
                          type="button" 
                          (click)="tableStyle.cells.underline = !tableStyle.cells.underline" 
                          [class.active]="tableStyle.cells.underline"
                          class="format-btn">
                    <mat-icon>format_underlined</mat-icon>
                    <span>Souligné</span>
                  </button>
                </div>
              </div>
            </mat-card>
          </mat-tab>
        </mat-tab-group>
      </div>

      <div class="matrix-editor">
        <div class="drill-table-editable">
          <!-- Header row with column labels -->
          <div class="drill-header-row">
            <div class="drill-cell header-cell corner-cell" [ngStyle]="getHeaderStyle()"></div>
            <div class="drill-cell header-cell" *ngFor="let col of drillGridColumns; let colIdx = index; trackBy: trackByIndex" [ngStyle]="getHeaderStyle()">
              <input 
                type="text" 
                [value]="drillGridColumns[colIdx]" 
                (input)="drillGridColumns[colIdx] = $any($event.target).value"
                placeholder="Colonne {{ colIdx + 1 }}"
                class="header-input"
                [ngStyle]="getHeaderStyle()">
            </div>
          </div>

          <!-- Data rows -->
          <div class="drill-row" *ngFor="let row of drillGridRows; let rowIdx = index; trackBy: trackByIndex">
            <div class="drill-cell header-cell" [ngStyle]="getFirstColStyle()">
              <input 
                type="text" 
                [value]="drillGridRows[rowIdx]" 
                (input)="drillGridRows[rowIdx] = $any($event.target).value"
                placeholder="Ligne {{ rowIdx + 1 }}"
                class="header-input"
                [ngStyle]="getFirstColStyle()">
            </div>
            <div 
              class="drill-cell editable-cell" 
              *ngFor="let col of drillGridColumns; let colIdx = index"
              [ngStyle]="getCellStyle(rowIdx, colIdx)">
              <div class="cell-input-wrapper">
                <input 
                  type="text" 
                  [value]="getCellValue(rowIdx, colIdx)"
                  (input)="updateCell(rowIdx, colIdx, $any($event.target).value)"
                  placeholder="..."
                  class="cell-input"
                  [ngStyle]="getCellStyle(rowIdx, colIdx)">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer" *ngIf="mode === 'config'">
    <button mat-raised-button (click)="close()">
      Annuler
    </button>
    <button mat-raised-button color="primary" (click)="save()">
      <mat-icon>save</mat-icon>
      {{ editingDrillGrid ? 'Mettre à jour' : 'Sauvegarder' }}
    </button>
  </div>
</div>
