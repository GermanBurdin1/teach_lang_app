<div class="drill-grid-modal-container">
  <div class="modal-header">
    <h2>
      <mat-icon>{{ mode === 'config' ? 'edit' : 'visibility' }}</mat-icon>
      {{ mode === 'config' ? 'Configuration de la matrice' : 'Aperçu final' }}
    </h2>
    <button mat-icon-button (click)="close()" class="close-btn">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="modal-content">
    <!-- Режим предпросмотра -->
    <div class="preview-mode" *ngIf="mode === 'preview'">
      <div class="drill-grid-viewer">
        <div class="drill-grid-table">
          <!-- Header row -->
          <div class="drill-row">
            <div class="drill-cell header-cell empty-header" [ngStyle]="getHeaderStyle()"></div>
            <div class="drill-cell header-cell" *ngFor="let col of getGridColumnsArray(getCurrentMatrixForPreview())" [ngStyle]="getHeaderStyle()">
              {{ col }}
            </div>
          </div>
          <!-- Data rows -->
          <div class="drill-row" *ngFor="let row of getGridRowsArray(getCurrentMatrixForPreview()); let rowIdx = index">
            <div class="drill-cell header-cell" [ngStyle]="getFirstColStyle()">
              {{ row }}
            </div>
            <div class="drill-cell view-cell" *ngFor="let col of getGridColumnsArray(getCurrentMatrixForPreview()); let colIdx = index" [ngStyle]="getCellStyle(rowIdx, colIdx)">
              <div class="cell-content">
                {{ getViewCellContent(getCurrentMatrixForPreview(), rowIdx, colIdx) }}
              </div>
              <div class="cell-answer" *ngIf="getViewCellCorrectAnswer(getCurrentMatrixForPreview(), rowIdx, colIdx)">
                <mat-icon class="check-icon">check_circle</mat-icon>
                Réponse: {{ getViewCellCorrectAnswer(getCurrentMatrixForPreview(), rowIdx, colIdx) }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Режим конфигурации -->
    <div class="config-mode" *ngIf="mode === 'config'">
      <div class="style-panel">
        <h4>Style de la table</h4>
        <div class="style-row">
          <mat-form-field appearance="outline">
            <mat-label>Police</mat-label>
            <mat-select [(ngModel)]="tableStyle.fontFamily">
              <mat-option value="Inter">Inter</mat-option>
              <mat-option value="Roboto">Roboto</mat-option>
              <mat-option value="Arial">Arial</mat-option>
              <mat-option value="Times New Roman">Times New Roman</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Taille</mat-label>
            <input matInput type="number" [(ngModel)]="tableStyle.fontSize" min="10" max="40">
          </mat-form-field>
          <div class="style-toggles">
            <button mat-stroked-button color="primary" type="button" (click)="tableStyle.bold = !tableStyle.bold" [class.active]="tableStyle.bold">
              <strong>Gras</strong>
            </button>
            <button mat-stroked-button color="primary" type="button" (click)="tableStyle.italic = !tableStyle.italic" [class.active]="tableStyle.italic">
              <em>Italique</em>
            </button>
            <button mat-stroked-button color="primary" type="button" (click)="tableStyle.underline = !tableStyle.underline" [class.active]="tableStyle.underline">
              <span style="text-decoration: underline;">Souligné</span>
            </button>
          </div>
        </div>
        <div class="style-row">
          <div class="color-picker">
            <label>Texte</label>
            <input type="color" [(ngModel)]="tableStyle.textColor">
          </div>
          <div class="color-picker">
            <label>Fond des en-têtes (th)</label>
            <input type="color" [(ngModel)]="tableStyle.headerBgColor">
          </div>
          <div class="color-picker">
            <label>Fond première colonne</label>
            <input type="color" [(ngModel)]="tableStyle.firstColBgColor">
          </div>
          <div class="color-picker">
            <label>Fond des cellules</label>
            <input type="color" [(ngModel)]="tableStyle.cellBgColor">
          </div>
        </div>
      </div>

      <div class="matrix-editor">
        <div class="drill-table-editable">
          <!-- Header row with column labels -->
          <div class="drill-header-row">
            <div class="drill-cell header-cell corner-cell" [ngStyle]="getHeaderStyle()"></div>
            <div class="drill-cell header-cell" *ngFor="let col of drillGridColumns; let colIdx = index; trackBy: trackByIndex" [ngStyle]="getHeaderStyle()">
              <input 
                type="text" 
                [value]="drillGridColumns[colIdx]" 
                (input)="drillGridColumns[colIdx] = $any($event.target).value"
                placeholder="Colonne {{ colIdx + 1 }}"
                class="header-input">
            </div>
          </div>

          <!-- Data rows -->
          <div class="drill-row" *ngFor="let row of drillGridRows; let rowIdx = index; trackBy: trackByIndex">
            <div class="drill-cell header-cell" [ngStyle]="getFirstColStyle()">
              <input 
                type="text" 
                [value]="drillGridRows[rowIdx]" 
                (input)="drillGridRows[rowIdx] = $any($event.target).value"
                placeholder="Ligne {{ rowIdx + 1 }}"
                class="header-input">
            </div>
            <div 
              class="drill-cell editable-cell" 
              *ngFor="let col of drillGridColumns; let colIdx = index"
              [ngStyle]="getCellStyle(rowIdx, colIdx)">
              <div class="cell-input-wrapper">
                <input 
                  type="text" 
                  [value]="getCellValue(rowIdx, colIdx)"
                  (input)="updateCell(rowIdx, colIdx, $any($event.target).value)"
                  placeholder="..."
                  class="cell-input">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer" *ngIf="mode === 'config'">
    <button mat-raised-button (click)="close()">
      Annuler
    </button>
    <button mat-raised-button color="primary" (click)="save()">
      <mat-icon>save</mat-icon>
      {{ editingDrillGrid ? 'Mettre à jour' : 'Sauvegarder' }}
    </button>
  </div>
</div>

