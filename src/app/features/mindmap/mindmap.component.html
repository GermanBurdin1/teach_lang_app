<div class="mindmap-container" (dblclick)="activateMoveMode($event)" (mousedown)="onMouseDown($event)"
  (mouseup)="onMouseUp($event)" (mousemove)="onMouseMove($event)">
  <div class="mindmap-canvas"
    [style.transform]="'translate(' + offsetX + 'px,' + offsetY + 'px) scale(' + zoomLevel + ')'">
    <!-- SVG Ð»Ð¸Ð½Ð¸Ð¸ -->
    <svg class="mindmap-lines">
      <ng-container *ngFor="let node of nodes">
        <ng-container *ngTemplateOutlet="renderLines; context: { parent: node }"></ng-container>
      </ng-container>

      <ng-template #renderLines let-parent="parent">
        <ng-container *ngIf="parent.expanded !== false">
          <ng-container *ngFor="let child of getAllChildren(parent)">
            <path *ngIf="parent.width && parent.height && child.width && child.height"
              [attr.d]="generatePath(parent, child)" stroke="#aaa" stroke-width="2" fill="transparent" />
            <ng-container *ngTemplateOutlet="renderLines; context: { parent: child }"></ng-container>
          </ng-container>
        </ng-container>
      </ng-template>

    </svg>


    <!-- ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ ÑƒÐ·Ð»Ð¾Ð² -->
    <ng-container *ngFor="let node of getVisibleNodes(); trackBy: trackById">
      <app-node [node]="node" [hasChildren]="hasChildren" [isSelected]="selectedNodes.has(node.id)"
        [isActiveModalNode]="activeModalNode?.id === node.id" [isAnyModalOpen]="!!activeModalNode"
        (add)="addChild($event)" (addSibling)="addSibling($event)" (toggleSelect)="toggleNodeSelection($event)"
        (zoom)="toggleZoom($event)" (shortcutAddChild)="addChild({ parent: $event })"
        (shortcutAddSibling)="addSibling({ sibling: $event })" (dragStarted)="onDragStart($event)"
        (dragEnded)="onDragEnd()" (droppedOn)="onDropOnNode($event)" (openModal)="onOpenModal($event)" (titleChanged)="onTitleChange($event)">
      </app-node>
    </ng-container>
  </div>

  <div class="zoom-controls">
    <button (click)="zoomOut()">âˆ’</button>
    <span>{{ (zoomLevel * 100) | number:'1.0-0' }}%</span>
    <button (click)="zoomIn()">+</button>
    <button (click)="centerMindmap()" title="Ð¦ÐµÐ½Ñ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ°Ñ€Ñ‚Ñƒ F6 Ð¸Ð»Ð¸ 1">ðŸŽ¯</button>
  </div>




</div>

<!-- Ð’ÑƒÐ°Ð»ÑŒ -->
<div class="modal-overlay" *ngIf="activeModalNode" (click)="closeModal()"></div>

<!-- Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð°Ñ Ð¼Ð¾Ð´Ð°Ð»ÐºÐ° -->
<div *ngIf="activeModalNode" class="modal" [ngClass]="activeModalType"
     [ngStyle]="getModalLocalPosition(activeModalNode, activeModalType)">
  <textarea
    [(ngModel)]="activeModalNode[activeModalType!]"
    (input)="onModalInput()"
    rows="4"
    class="modal-textarea"
    placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚..."
  ></textarea>

  <div *ngIf="activeModalType === 'rule' || activeModalType === 'exception'" class="shortcuts">
    <button *ngFor="let shortcut of grammarShortcuts" (click)="insertShortcut(shortcut.insert)">
      {{ shortcut.label }}
    </button>
  </div>
</div>
