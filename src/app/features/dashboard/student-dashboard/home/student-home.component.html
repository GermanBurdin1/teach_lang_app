<div class="student-home">

  <!-- üîº –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å -->
  <div class="top-section">
    <!-- –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∫–ª–∞—Å—Å –¥–ª—è –±–ª–∏–∂–∞–π—à–µ–≥–æ —É—Ä–æ–∫–∞ -->
    <div *ngIf="getNextLesson() && canEnterClass(getNextLesson()!)" 
         class="next-lesson-entry-zone">
      <div class="next-lesson-card">
        <div class="lesson-info">
                     <h3>üé• Prochain cours dans {{ getMinutesUntilLesson(getNextLesson()!) }} minutes</h3>
          <p>{{ getNextLesson()!.title }}</p>
          <p>{{ getNextLesson()!.start | date:'HH:mm' }} - {{ getNextLesson()!.end | date:'HH:mm' }}</p>
        </div>
        <button mat-raised-button 
                color="accent" 
                (click)="enterVirtualClass(getNextLesson()!)"
                class="enter-class-btn large">
          üé• Entrer en classe
        </button>
      </div>
    </div>

    <div class="notification-zone">
      <div class="section-header" style="display: flex; align-items: center; justify-content: space-between;">
        <h3>üîî Notifications</h3>
        <button mat-icon-button (click)="notificationsCollapsed = !notificationsCollapsed">
          <mat-icon>{{ notificationsCollapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
        </button>
      </div>
      <div *ngIf="!notificationsCollapsed">
        <div *ngIf="notifications.length > 0; else noNotifications" class="notifications-container">
          <div *ngFor="let note of visibleNotifications" class="notification-card">
            <div class="notification-content">
              <div class="notification-text">
                <span *ngIf="note.teacherId; else plainText" [innerHTML]="makeProfesseurLink(note.text, note.teacherId, note.teacherName)"></span>
                <ng-template #plainText>{{ note.text }}</ng-template>
              </div>
              
              <div class="notification-actions">
                <!-- Actions for booking proposals -->
                <ng-container *ngIf="note.type === 'booking_proposal' && note.proposedTime">
                  <ng-container *ngIf="!note.accepted && !note.refused">
                    <button mat-raised-button color="primary" size="small" (click)="acceptProposal(note)">
                      Accepter
                    </button>
                    <button mat-stroked-button color="warn" size="small" (click)="refuseProposal(note)">
                      Refuser
                    </button>
                  </ng-container>
                  <ng-container *ngIf="note.accepted">
                    <span class="status-message accepted">
                      ‚úÖ Vous avez accept√© la nouvelle heure propos√©e par le professeur.
                    </span>
                  </ng-container>
                  <ng-container *ngIf="note.refused">
                    <span class="status-message refused">
                      ‚ùå Vous avez refus√© la nouvelle heure propos√©e par le professeur.
                    </span>
                  </ng-container>
                </ng-container>
                
                <!-- Hide button -->
                <button mat-icon-button 
                        class="hide-button" 
                        (click)="hideNotification(note)"
                        matTooltip="Masquer cette notification">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Show more/less button -->
          <div *ngIf="hasMoreNotifications" class="show-more-container">
            <button mat-stroked-button 
                    color="accent" 
                    (click)="toggleShowMore()">
              {{ showMoreNotifications ? 'Voir moins' : 'Voir plus (' + (notifications.length - MAX_NOTIFICATIONS) + ')' }}
              <mat-icon>{{ showMoreNotifications ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
          </div>
        </div>
        
        <ng-template #noNotifications>
          <div class="no-notifications">
            <mat-icon class="no-notifications-icon">notifications_off</mat-icon>
            <p>‚úÖ Aucun nouveau message</p>
          </div>
        </ng-template>
      </div>
    </div>

    <div class="goal-block">
      <div class="section-header" style="display: flex; align-items: center; justify-content: space-between;">
        <h3>üéØ Objectif</h3>
        <button mat-icon-button (click)="goalCollapsed = !goalCollapsed">
          <mat-icon>{{ goalCollapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
        </button>
      </div>
      <div *ngIf="!goalCollapsed">
        <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–ª—å –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–ª—å -->
        <div *ngIf="!loadingGoals" class="goal-content">
          <div *ngIf="currentGoal" class="goal-display">
            <div class="goal-details">
              <div class="goal-level">
                <strong>{{ getExamLevelDisplayName(currentGoal.examLevel) }}</strong>
              </div>
              <div *ngIf="currentGoal.targetDate" class="goal-date">
                üìÖ Avant le {{ currentGoal.targetDate | date:'dd/MM/yyyy' }}
              </div>
              <div *ngIf="currentGoal.description" class="goal-description">
                üí≠ {{ currentGoal.description }}
              </div>
            </div>
            <button mat-icon-button 
                    color="primary" 
                    (click)="openGoalModal()" 
                    matTooltip="Modifier l'objectif"
                    class="edit-goal-button">
              <mat-icon>edit</mat-icon>
            </button>
          </div>
          
          <div *ngIf="!currentGoal" class="no-goal-display">
            <span class="no-goal-message">üìù D√©finissez votre objectif d'apprentissage</span>
            <button mat-icon-button 
                    color="primary" 
                    (click)="openGoalModal()" 
                    matTooltip="D√©finir un objectif"
                    class="edit-goal-button">
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </div>
        
        <div *ngIf="loadingGoals" class="loading-goals">
          <mat-spinner diameter="20"></mat-spinner>
          <span>Chargement...</span>
        </div>
      </div>
    </div>

    <div class="stats-block">
      <div class="section-header" style="display: flex; align-items: center; justify-content: space-between;">
        <h3>üìä Statistiques</h3>
        <button mat-icon-button (click)="statsCollapsed = !statsCollapsed">
          <mat-icon>{{ statsCollapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
        </button>
      </div>
      <div *ngIf="!statsCollapsed">
        <ul *ngIf="!loadingStats">
          <li>
            Jours actifs: {{ stats.daysActive }}
            <mat-icon 
              class="info-icon" 
              matTooltip="Les jours actifs repr√©sentent le nombre de jours diff√©rents o√π vous vous √™tes connect√©(e) √† la plateforme. Cela montre votre r√©gularit√© d'apprentissage."
              matTooltipPosition="right">
              info_outline
            </mat-icon>
          </li>
          <li>Le√ßons termin√©es: {{ stats.lessonsCompleted }}</li>
          <li>Mots appris: {{ stats.wordsLearned }}</li>
        </ul>
      </div>
    </div>

    <div class="homework-zone">
      <div class="section-header" style="display: flex; align-items: center; justify-content: space-between;">
        <h3>üìö Devoirs √† faire</h3>
        <button mat-icon-button (click)="homeworkCollapsed = !homeworkCollapsed">
          <mat-icon>{{ homeworkCollapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
        </button>
      </div>
      <div *ngIf="!homeworkCollapsed">
        <ng-container *ngIf="studentHomework.length > 0; else noHomework">
          <div class="student-homework-list">
            <mat-card *ngFor="let hw of studentHomework" class="homework-card" (click)="goToHomeworkDetails(hw)">
              <mat-card-header>
                <mat-card-title>
                  <span class="homework-title">{{ hw.title }}</span>
                  <span class="homework-status" [ngClass]="{
                    'status-unfinished': hw.status === 'assigned',
                    'status-completed': hw.status === 'completed',
                    'status-overdue': hw.status === 'overdue'
                  }">
                    {{ hw.status === 'completed' ? '‚úÖ Termin√©' : (hw.status === 'overdue' ? '‚è∞ En retard' : 'üìù √Ä faire') }}
                  </span>
                </mat-card-title>
                <mat-card-subtitle>
                  Pour le {{ hw.dueDate | date:'dd/MM/yyyy' }}
                  <span *ngIf="isHomeworkOverdue(hw)" class="overdue-warning">
                    ‚ö†Ô∏è Ce devoir est en retard ! Cliquez pour le terminer rapidement.
                  </span>
                </mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="homework-description">{{ hw.description }}</div>
                <div *ngIf="hw.teacherFeedback" class="homework-feedback">
                  <strong>Feedback:</strong> {{ hw.teacherFeedback }}
                </div>
                <div *ngIf="hw.grade !== undefined && hw.grade !== null" class="homework-grade">
                  <strong>Note:</strong> {{ hw.grade }}
                </div>
              </mat-card-content>
              <mat-card-actions class="homework-action">
                <button mat-raised-button 
                        color="primary" 
                        (click)="goToHomeworkDetails(hw); $event.stopPropagation()"
                        *ngIf="hw.status !== 'completed'">
                  <mat-icon>assignment</mat-icon>
                  Faire le devoir
                </button>
                <button mat-stroked-button 
                        color="accent" 
                        (click)="goToHomeworkDetails(hw); $event.stopPropagation()"
                        *ngIf="hw.status === 'completed'">
                  <mat-icon>visibility</mat-icon>
                  Voir d√©tails
                </button>
              </mat-card-actions>
            </mat-card>
          </div>
        </ng-container>

        <ng-template #noHomework>
          <p>‚úÖ Aucun devoir en attente</p>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- üîΩ –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å -->
  <div class="calendar-wrapper">
    <div class="calendar-zone">
      <h3>üóìÔ∏è Prochains cours</h3>

      <!-- ÔøΩÔøΩ –®–∞–±–ª–æ–Ω —Å–æ–±—ã—Ç–∏—è -->
      <app-calendar-preview [events]="upcomingLessons" [eventTitleTemplate]="customEventTemplate"
        (eventClicked)="onLessonClick($event)">
      </app-calendar-preview>

      <ng-template #customEventTemplate let-event="event">
        <div class="custom-event" [ngClass]="{
          'past-event': event?.end && event.end < now,
          'upcoming-event': event?.end && event.end >= now
        }" (click)="onLessonClick(event)">
          <div class="event-content">
            <div class="event-info">
              <strong>{{ event?.title || 'Titre manquant' }}</strong><br />
              {{ event?.start | date: 'shortTime' }} - {{ event?.end | date: 'shortTime' }}
            </div>
            <button *ngIf="canEnterClass(event) && (event?.meta?.status === 'confirmed' || event?.meta?.status === 'in_progress')" 
                    mat-mini-fab 
                    color="accent" 
                    (click)="enterVirtualClass(event); $event.stopPropagation()"
                    class="enter-class-btn-mini"
                    matTooltip="Entrer en classe">
              üé•
            </button>
          </div>
        </div>
      </ng-template>
    </div>
  </div>
</div>


<ng-template [ngIf]="showModal">
  <div class="modal-overlay" (click)="closeModal()"></div>
  <div class="mat-modal-content details-modal" (click)="$event.stopPropagation()">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –∑–∞–∫—Ä—ã—Ç–∏—è —Å–ø—Ä–∞–≤–∞ -->
    <div class="details-modal__header">
      <h2 class="details-modal__title">D√©tails du cours</h2>
      <button mat-icon-button (click)="closeModal()" aria-label="Fermer" class="details-modal__close">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <div mat-dialog-content class="details-modal__content">
      <p><strong>Titre :</strong> {{ selectedLesson?.title }}</p>
      <p><strong>D√©but :</strong> {{ selectedLesson?.start | date: 'full' }}</p>
      <p><strong>Fin :</strong> {{ selectedLesson?.end | date: 'full' }}</p>
      <p><strong>Statut :</strong> {{ selectedLesson?.meta?.status }}</p>
    </div>

    <!-- –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ -->
    <div class="details-modal__actions" *ngIf="canCancelLesson()">
      <button mat-raised-button color="primary" (click)="openModifyModal()">Modifier ou annuler</button>
    </div>
  </div>
</ng-template>




<ng-template [ngIf]="showModifyModal">
  <div class="modal-overlay" (click)="closeModifyModal()"></div>
  <div class="mat-modal-content modify-modal" (click)="$event.stopPropagation()">

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="modify-modal__header">
      <button mat-icon-button (click)="onBackFromModify()" aria-label="Retour">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h2 class="modify-modal__title">Modifier le cours</h2>
      <button mat-icon-button (click)="closeModifyModal()" aria-label="Fermer">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div mat-dialog-content class="modify-modal__content">

      <!-- √âcran –≤—ã–±–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—è -->
      <div *ngIf="!actionType" class="modify-choice">
        <p class="mb-2">Que souhaitez-vous faire‚ÄØ?</p>
        <div class="action-buttons">
          <button mat-raised-button color="primary" (click)="actionType = 'reschedule'">üìÜ Reporter</button>
          <button mat-stroked-button color="warn" (click)="actionType = 'cancel'">‚ùå Annuler le cours</button>
        </div>
      </div>

      <!-- Reporter -->
      <div *ngIf="actionType === 'reschedule'" class="mt-3">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>–î–∞—Ç–∞</mat-label>
          <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDateOnly" />
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>–í—Ä–µ–º—è</mat-label>
          <input matInput type="time" [(ngModel)]="selectedTimeOnly" />
        </mat-form-field>
      </div>

      <!-- Annuler -->
      <div *ngIf="actionType === 'cancel'" class="mt-3">
        <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–º–µ–Ω—ã -->
        <div *ngIf="isCancellationTooLate()" class="cancellation-warning" 
             style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
          <mat-icon style="color: #856404; margin-right: 8px;">warning</mat-icon>
          <span style="color: #856404;">
            <strong>Attention :</strong> L'annulation s'effectue moins de 2h avant le cours. 
            Aucun remboursement ne sera effectu√©.
          </span>
        </div>
        
        <div *ngIf="!isCancellationTooLate()" class="cancellation-info" 
             style="background: #d1ecf1; border: 1px solid #bee5eb; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
          <mat-icon style="color: #0c5460; margin-right: 8px;">info</mat-icon>
          <span style="color: #0c5460;">
            Le remboursement sera effectu√© dans un d√©lai de 3-5 jours ouvr√©s.
          </span>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Motif d'annulation</mat-label>
          <mat-select [(ngModel)]="cancelReason">
            <mat-option value="malade">Je suis malade</mat-option>
            <mat-option value="urgence">Urgence personnelle</mat-option>
            <mat-option value="emploi_du_temps">Changement d'emploi du temps</mat-option>
            <mat-option value="autre">Autre raison</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field *ngIf="cancelReason === 'autre'" appearance="outline" class="full-width">
          <mat-label>Veuillez pr√©ciser</mat-label>
          <input matInput [(ngModel)]="customCancelReason" placeholder="√âcrivez ici la raison" />
        </mat-form-field>
      </div>

    </div>

    <!-- Bout–æ–Ω—ã -->
    <div mat-dialog-actions align="end" class="mt-3" *ngIf="actionType">
      <button mat-flat-button color="accent" (click)="submitModification()">Soumettre</button>
    </div>
  </div>
</ng-template>


<ng-template [ngIf]="rescheduleConfirmed">
  <div class="modal-overlay" (click)="rescheduleConfirmed = false"></div>
  <div class="mat-modal-content" (click)="$event.stopPropagation()">
    <p>üì¨ Votre demande de report a √©t√© envoy√©e √† l'enseignant.</p>
    <button mat-flat-button color="accent" (click)="rescheduleConfirmed = false">Fermer</button>
  </div>
</ng-template>

<!-- ======================== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –¶–ï–õ–ï–ô ======================== -->
<ng-template [ngIf]="showGoalModal">
  <div class="modal-overlay" (click)="closeGoalModal()"></div>
  <div class="mat-modal-content goal-modal" (click)="$event.stopPropagation()">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="goal-modal__header">
      <h2 class="goal-modal__title">üéØ D√©finir votre objectif</h2>
      <button mat-icon-button (click)="closeGoalModal()" aria-label="Fermer" class="goal-modal__close">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="goal-modal__content">
      
      <!-- –í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è —ç–∫–∑–∞–º–µ–Ω–∞ -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Niveau d'examen souhait√©</mat-label>
        <mat-select [(ngModel)]="selectedExamLevel" required>
          <mat-option *ngFor="let level of availableExamLevels" [value]="level">
            {{ getExamLevelDisplayName(level) }}
          </mat-option>
        </mat-select>
        <mat-hint>Choisissez le niveau que vous souhaitez atteindre</mat-hint>
      </mat-form-field>

      <!-- –î–∞—Ç–∞-—Ü–µ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Date cible (optionnel)</mat-label>
        <input matInput [matDatepicker]="goalPicker" [(ngModel)]="selectedTargetDate" />
        <mat-datepicker-toggle matSuffix [for]="goalPicker"></mat-datepicker-toggle>
        <mat-datepicker #goalPicker></mat-datepicker>
        <mat-hint>Quand souhaitez-vous atteindre ce niveau ?</mat-hint>
      </mat-form-field>

      <!-- –û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description (optionnel)</mat-label>
        <textarea matInput 
                  [(ngModel)]="goalDescription" 
                  rows="3" 
                  placeholder="Pourquoi voulez-vous atteindre ce niveau ? Projet professionnel, voyage, etc.">
        </textarea>
        <mat-hint>D√©crivez votre motivation</mat-hint>
      </mat-form-field>

    </div>

    <!-- Actions -->
    <div class="goal-modal__actions">
      <button mat-stroked-button (click)="closeGoalModal()" [disabled]="loadingGoals">
        Annuler
      </button>
      <button mat-raised-button 
              color="primary" 
              (click)="saveGoal()" 
              [disabled]="!selectedExamLevel || loadingGoals">
        <mat-spinner *ngIf="loadingGoals" diameter="16" style="margin-right: 8px;"></mat-spinner>
        {{ currentGoal ? 'Modifier' : 'Sauvegarder' }}
      </button>
    </div>
  </div>
</ng-template>
