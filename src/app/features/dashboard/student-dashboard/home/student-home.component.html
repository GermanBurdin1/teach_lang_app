<div class="student-home">

  <!-- ğŸ”¼ Ğ’ĞµÑ€Ñ…Ğ½ÑÑ Ñ‡Ğ°ÑÑ‚ÑŒ -->
  <div class="top-section">
    <div class="goal-block">
      <h3>ğŸ¯ Objectif</h3>
      <p>{{ goal }}</p>
    </div>

    <div class="stats-block">
      <h3>ğŸ“Š Statistiques</h3>
      <ul>
        <li>Jours actifs: {{ stats.daysActive }}</li>
        <li>LeÃ§ons terminÃ©es: {{ stats.lessonsCompleted }}</li>
        <li>Mots appris: {{ stats.wordsLearned }}</li>
      </ul>
    </div>
  </div>

  <!-- ğŸ”½ ĞĞ¸Ğ¶Ğ½ÑÑ Ñ‡Ğ°ÑÑ‚ÑŒ -->
  <div class="bottom-section">

    <div class="calendar-zone">
      <h3>ğŸ—“ï¸ Prochains cours</h3>

      <!-- ğŸ§© Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ -->
      <app-calendar-preview [events]="upcomingLessons" [eventTitleTemplate]="customEventTemplate"
        (eventClicked)="onLessonClick($event)">
      </app-calendar-preview>

      <ng-template #customEventTemplate let-event="event">
        <div class="custom-event" [ngClass]="{
      'past-event': event?.end && event.end < now,
      'upcoming-event': event?.end && event.end >= now
    }" (click)="onLessonClick(event)">
          <strong>{{ event?.title || 'Titre manquant' }}</strong><br />
          {{ event?.start | date: 'shortTime' }} - {{ event?.end | date: 'shortTime' }}
        </div>
      </ng-template>

    </div>

    <div class="homework-zone">
      <h3>ğŸ“š Devoirs Ã  faire</h3>

      <ng-container *ngIf="pendingHomework.length > 0; else noHomework">
        <ul>
          <li *ngFor="let hw of pendingHomework">
            {{ hw.title }} â€” pour le {{ hw.dueDate }}
          </li>
        </ul>
      </ng-container>

      <ng-template #noHomework>
        <p>âœ… Aucun devoir en attente</p>
      </ng-template>
    </div>

  </div>
</div>

<ng-template [ngIf]="showModal">
  <div class="modal-overlay" (click)="closeModal()"></div>
  <div class="mat-modal-content" (click)="$event.stopPropagation()">
    <h2 mat-dialog-title>DÃ©tails du cours</h2>
    <div mat-dialog-content>
      <p><strong>Titre :</strong> {{ selectedLesson?.title }}</p>
      <p><strong>DÃ©but :</strong> {{ selectedLesson?.start | date: 'full' }}</p>
      <p><strong>Fin :</strong> {{ selectedLesson?.end | date: 'full' }}</p>
    </div>
    <div mat-dialog-actions>
      <button *ngIf="canReschedule()" mat-raised-button color="accent" (click)="openModifyModal()">
        Modifier un cours
      </button>
      <button mat-stroked-button color="primary" (click)="closeModal()">Fermer</button>
    </div>
  </div>
</ng-template>


<ng-template [ngIf]="showModifyModal">
  <div class="modal-overlay" (click)="closeModifyModal()"></div>
  <div class="mat-modal-content" (click)="$event.stopPropagation()">
    <h2 mat-dialog-title>Modifier le cours</h2>

    <div mat-dialog-content>
      <!-- Choix initial -->
      <div *ngIf="!actionType" class="modify-choice">
        <p class="mb-2">Que souhaitez-vous faireâ€¯?</p>
        <div class="action-buttons">
          <button mat-raised-button color="primary" (click)="actionType = 'reschedule'">ğŸ“† Reporter</button>
          <button mat-stroked-button color="warn" (click)="actionType = 'cancel'">âŒ Annuler</button>
        </div>
      </div>

      <!-- Reporter -->
      <div *ngIf="actionType === 'reschedule'" class="mt-3">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nouvelle date souhaitÃ©e</mat-label>
          <input matInput type="datetime-local" [(ngModel)]="selectedNewDate" />
        </mat-form-field>
      </div>

      <!-- Annuler -->
      <div *ngIf="actionType === 'cancel'" class="mt-3">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Motif dâ€™annulation</mat-label>
          <mat-select [(ngModel)]="cancelReason">
            <mat-option value="malade">Je suis malade</mat-option>
            <mat-option value="urgence">Urgence personnelle</mat-option>
            <mat-option value="emploi_du_temps">Changement dâ€™emploi du temps</mat-option>
            <mat-option value="autre">Autre raison</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field *ngIf="cancelReason === 'autre'" appearance="outline" class="full-width">
          <mat-label>Veuillez prÃ©ciser</mat-label>
          <input matInput [(ngModel)]="customCancelReason" placeholder="Ã‰crivez ici la raison" />
        </mat-form-field>
      </div>
    </div>

    <!-- Boutons finaux -->
    <div mat-dialog-actions align="end" class="mt-3">
      <button mat-flat-button color="accent" (click)="submitModification()">Soumettre</button>
      <button mat-stroked-button color="primary" (click)="closeModifyModal()">Fermer</button>
    </div>
  </div>
</ng-template>

<ng-template [ngIf]="rescheduleConfirmed">
  <div class="modal-overlay" (click)="rescheduleConfirmed = false"></div>
  <div class="mat-modal-content" (click)="$event.stopPropagation()">
    <p>ğŸ“¬ Votre demande de report a Ã©tÃ© envoyÃ©e Ã  lâ€™enseignant.</p>
    <button mat-flat-button color="accent" (click)="rescheduleConfirmed = false">Fermer</button>
  </div>
</ng-template>
