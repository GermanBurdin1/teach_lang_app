<div class="student-home">

  <!-- üîº –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å -->
  <div class="top-section">
    <div class="notification-zone">
      <h3>üîî Notifications</h3>
      
      <div *ngIf="notifications.length > 0; else noNotifications" class="notifications-container">
        <div *ngFor="let note of visibleNotifications" class="notification-card">
          <div class="notification-content">
            <div class="notification-text">
              <span *ngIf="note.teacherId; else plainText" [innerHTML]="makeProfesseurLink(note.text, note.teacherId, note.teacherName)"></span>
              <ng-template #plainText>{{ note.text }}</ng-template>
            </div>
            
            <div class="notification-actions">
              <!-- Actions for booking proposals -->
              <ng-container *ngIf="note.type === 'booking_proposal' && note.proposedTime">
                <ng-container *ngIf="!note.accepted && !note.refused">
                  <button mat-raised-button color="primary" size="small" (click)="acceptProposal(note)">
                    Accepter
                  </button>
                  <button mat-stroked-button color="warn" size="small" (click)="refuseProposal(note)">
                    Refuser
                  </button>
                </ng-container>
                <ng-container *ngIf="note.accepted">
                  <span class="status-message accepted">
                    ‚úÖ Vous avez accept√© la nouvelle heure propos√©e par le professeur.
                  </span>
                </ng-container>
                <ng-container *ngIf="note.refused">
                  <span class="status-message refused">
                    ‚ùå Vous avez refus√© la nouvelle heure propos√©e par le professeur.
                  </span>
                </ng-container>
              </ng-container>
              
              <!-- Hide button -->
              <button mat-icon-button 
                      class="hide-button" 
                      (click)="hideNotification(note)"
                      matTooltip="Masquer cette notification">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Show more/less button -->
        <div *ngIf="hasMoreNotifications" class="show-more-container">
          <button mat-stroked-button 
                  color="accent" 
                  (click)="toggleShowMore()">
            {{ showMoreNotifications ? 'Voir moins' : 'Voir plus (' + (notifications.length - MAX_NOTIFICATIONS) + ')' }}
            <mat-icon>{{ showMoreNotifications ? 'expand_less' : 'expand_more' }}</mat-icon>
          </button>
        </div>
      </div>
      
      <ng-template #noNotifications>
        <div class="no-notifications">
          <mat-icon class="no-notifications-icon">notifications_off</mat-icon>
          <p>‚úÖ Aucun nouveau message</p>
        </div>
      </ng-template>
    </div>

    <div class="goal-block">
      <h3>üéØ Objectif</h3>
      <p>{{ goal }}</p>
    </div>

    <div class="stats-block">
      <h3>üìä Statistiques</h3>
      <ul>
        <li>Jours actifs: {{ stats.daysActive }}</li>
        <li>Le√ßons termin√©es: {{ stats.lessonsCompleted }}</li>
        <li>Mots appris: {{ stats.wordsLearned }}</li>
      </ul>
    </div>

    <div class="homework-zone">
      <h3>üìö Devoirs √† faire</h3>

      <ng-container *ngIf="pendingHomework.length > 0; else noHomework">
        <ul>
          <li *ngFor="let hw of pendingHomework">
            {{ hw.title }} ‚Äî pour le {{ hw.dueDate }}
          </li>
        </ul>
      </ng-container>

      <ng-template #noHomework>
        <p>‚úÖ Aucun devoir en attente</p>
      </ng-template>
    </div>
  </div>

  <!-- üîΩ –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å -->
  <div class="calendar-wrapper">
    <div class="calendar-zone">
      <h3>üóìÔ∏è Prochains cours</h3>

      <!-- üß© –®–∞–±–ª–æ–Ω —Å–æ–±—ã—Ç–∏—è -->
      <app-calendar-preview [events]="upcomingLessons" [eventTitleTemplate]="customEventTemplate"
        (eventClicked)="onLessonClick($event)">
      </app-calendar-preview>

      <ng-template #customEventTemplate let-event="event">
        <div class="custom-event" [ngClass]="{
          'past-event': event?.end && event.end < now,
          'upcoming-event': event?.end && event.end >= now
        }" (click)="onLessonClick(event)">
          <strong>{{ event?.title || 'Titre manquant' }}</strong><br />
          {{ event?.start | date: 'shortTime' }} - {{ event?.end | date: 'shortTime' }}
        </div>
      </ng-template>
    </div>
  </div>
</div>


<ng-template [ngIf]="showModal">
  <div class="modal-overlay" (click)="closeModal()"></div>
  <div class="mat-modal-content details-modal" (click)="$event.stopPropagation()">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –∑–∞–∫—Ä—ã—Ç–∏—è —Å–ø—Ä–∞–≤–∞ -->
    <div class="details-modal__header">
      <h2 class="details-modal__title">D√©tails du cours</h2>
      <button mat-icon-button (click)="closeModal()" aria-label="Fermer" class="details-modal__close">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <div mat-dialog-content class="details-modal__content">
      <p><strong>Titre :</strong> {{ selectedLesson?.title }}</p>
      <p><strong>D√©but :</strong> {{ selectedLesson?.start | date: 'full' }}</p>
      <p><strong>Fin :</strong> {{ selectedLesson?.end | date: 'full' }}</p>
    </div>

    <!-- –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ -->
    <div class="details-modal__actions" *ngIf="canReschedule()">
      <button mat-raised-button color="primary" (click)="openModifyModal()">Modifier la date</button>
    </div>
  </div>
</ng-template>




<ng-template [ngIf]="showModifyModal">
  <div class="modal-overlay" (click)="closeModifyModal()"></div>
  <div class="mat-modal-content modify-modal" (click)="$event.stopPropagation()">

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="modify-modal__header">
      <button mat-icon-button (click)="onBackFromModify()" aria-label="Retour">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h2 class="modify-modal__title">Modifier le cours</h2>
      <button mat-icon-button (click)="closeModifyModal()" aria-label="Fermer">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div mat-dialog-content class="modify-modal__content">

      <!-- √âcran –≤—ã–±–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—è -->
      <div *ngIf="!actionType" class="modify-choice">
        <p class="mb-2">Que souhaitez-vous faire‚ÄØ?</p>
        <div class="action-buttons">
          <button mat-raised-button color="primary" (click)="actionType = 'reschedule'">üìÜ Reporter</button>
          <button mat-stroked-button color="warn" (click)="actionType = 'cancel'">‚ùå Annuler le cours</button>
        </div>
      </div>

      <!-- Reporter -->
      <div *ngIf="actionType === 'reschedule'" class="mt-3">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>–î–∞—Ç–∞</mat-label>
          <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDateOnly" />
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>–í—Ä–µ–º—è</mat-label>
          <input matInput type="time" [(ngModel)]="selectedTimeOnly" />
        </mat-form-field>
      </div>

      <!-- Annuler -->
      <div *ngIf="actionType === 'cancel'" class="mt-3">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Motif d'annulation</mat-label>
          <mat-select [(ngModel)]="cancelReason">
            <mat-option value="malade">Je suis malade</mat-option>
            <mat-option value="urgence">Urgence personnelle</mat-option>
            <mat-option value="emploi_du_temps">Changement d'emploi du temps</mat-option>
            <mat-option value="autre">Autre raison</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field *ngIf="cancelReason === 'autre'" appearance="outline" class="full-width">
          <mat-label>Veuillez pr√©ciser</mat-label>
          <input matInput [(ngModel)]="customCancelReason" placeholder="√âcrivez ici la raison" />
        </mat-form-field>
      </div>

    </div>

    <!-- Bout–æ–Ω—ã -->
    <div mat-dialog-actions align="end" class="mt-3" *ngIf="actionType">
      <button mat-flat-button color="accent" (click)="submitModification()">Soumettre</button>
    </div>
  </div>
</ng-template>


<ng-template [ngIf]="rescheduleConfirmed">
  <div class="modal-overlay" (click)="rescheduleConfirmed = false"></div>
  <div class="mat-modal-content" (click)="$event.stopPropagation()">
    <p>üì¨ Votre demande de report a √©t√© envoy√©e √† l'enseignant.</p>
    <button mat-flat-button color="accent" (click)="rescheduleConfirmed = false">Fermer</button>
  </div>
</ng-template>
