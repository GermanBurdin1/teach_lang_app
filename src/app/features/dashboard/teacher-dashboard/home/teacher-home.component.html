<div class="teacher-home">

  <!-- üîº –í–ï–†–•–ù–Ø–Ø –ß–ê–°–¢–¨ -->
  <div class="top-section">

    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="column left-column">
      <h3>üîî Notifications</h3>
      
      <div *ngIf="notifications.length > 0; else noNotifications" class="notifications-container">
        <div *ngFor="let note of visibleNotifications" class="notification-card">
          <div class="notification-content">
            <div class="notification-text" 
                 [innerHTML]="makeStudentNameClickable(note.message, note)"
                 (click)="onNotificationClick($event, note)">
            </div>
            
            <div class="notification-actions">
              <!-- Hide button -->
              <button mat-icon-button 
                      class="hide-button" 
                      (click)="hideNotification(note)"
                      matTooltip="Masquer cette notification">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Show more/less button -->
        <div *ngIf="hasMoreNotifications" class="show-more-container">
          <button mat-stroked-button 
                  color="accent" 
                  (click)="toggleShowMore()">
            {{ showMoreNotifications ? 'Voir moins' : 'Voir plus (' + (notifications.length - MAX_NOTIFICATIONS) + ')' }}
            <mat-icon>{{ showMoreNotifications ? 'expand_less' : 'expand_more' }}</mat-icon>
          </button>
        </div>
      </div>
      
      <ng-template #noNotifications>
        <div class="no-notifications">
          <mat-icon class="no-notifications-icon">notifications_off</mat-icon>
          <p>‚úÖ Aucun nouveau message</p>
        </div>
      </ng-template>

      <!-- –°–ò–°–¢–ï–ú–ê –í–ö–õ–ê–î–û–ö –î–õ–Ø –ó–ê–Ø–í–û–ö -->
      <h3>üì® Demandes de r√©servation</h3>
      
      <mat-tab-group class="requests-tabs" animationDuration="300ms">
        <!-- –í–∫–ª–∞–¥–∫–∞: Nouvelles demandes -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">inbox</mat-icon>
            Nouvelles
            <span *ngIf="newRequests.length" class="tab-badge">{{ newRequests.length }}</span>
          </ng-template>
          
          <div class="tab-content">
            <div *ngIf="newRequests.length > 0; else noNewRequests" class="requests-container">
              <div *ngFor="let req of newRequests.slice(0, shownRequests)" class="request-card new-request">
                <div class="request-content">
                  <div class="request-text">
                    <strong>{{ req.title }}</strong><br />
                    <small>{{ req.message }}</small>
                  </div>
                  
                  <div class="request-actions">
                    <button mat-raised-button color="primary" size="small" (click)="respondToRequest(req, true)">
                      Accepter
                    </button>
                    <button mat-stroked-button color="warn" size="small" (click)="respondToRequest(req, false)">
                      Refuser
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Show more/less button for new requests -->
              <div *ngIf="newRequests.length > 5" class="show-more-container">
                <button mat-stroked-button 
                        color="primary" 
                        *ngIf="shownRequests < newRequests.length" 
                        (click)="loadMore()">
                  Voir plus ({{ newRequests.length - shownRequests }})
                  <mat-icon>expand_more</mat-icon>
                </button>
                <button mat-stroked-button 
                        color="primary" 
                        *ngIf="shownRequests > 5" 
                        (click)="reduce()">
                  R√©duire
                  <mat-icon>expand_less</mat-icon>
                </button>
              </div>
            </div>
            
            <ng-template #noNewRequests>
              <div class="no-requests">
                <mat-icon class="no-requests-icon">inbox</mat-icon>
                <p>‚úÖ Aucune nouvelle demande</p>
              </div>
            </ng-template>
          </div>
        </mat-tab>

        <!-- –í–∫–ª–∞–¥–∫–∞: Demandes trait√©es -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">done_all</mat-icon>
            Trait√©es
            <span *ngIf="treatedRequests.length" class="tab-badge">{{ treatedRequests.length }}</span>
          </ng-template>
          
          <div class="tab-content">
            <div *ngIf="treatedRequests.length > 0; else noTreatedRequests" class="requests-container treated-requests">
              <div *ngFor="let req of visibleTreatedRequests" class="request-card treated-request">
                <div class="request-content">
                  <div class="request-text">
                    <strong>{{ req.title }}</strong><br />
                    <small>{{ req.message }}</small>
                    <div class="status-badge status-{{ req.status }}">
                      Status: <strong>{{ req.status }}</strong>
                    </div>
                  </div>
                  
                  <div class="request-actions">
                    <!-- Hide button -->
                    <button mat-icon-button 
                            class="hide-button" 
                            (click)="hideTreatedRequest(req)"
                            matTooltip="Masquer cette demande">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Show more/less button for treated requests -->
              <div *ngIf="hasMoreTreatedRequests" class="show-more-container">
                <button mat-stroked-button 
                        color="accent" 
                        (click)="toggleShowMoreTreatedRequests()">
                  {{ showMoreTreatedRequests ? 'Voir moins' : 'Voir plus (' + (treatedRequests.length - MAX_TREATED_REQUESTS) + ')' }}
                  <mat-icon>{{ showMoreTreatedRequests ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>
              </div>
            </div>
            
            <ng-template #noTreatedRequests>
              <div class="no-requests">
                <mat-icon class="no-requests-icon">done_all</mat-icon>
                <p>‚úÖ Aucune demande trait√©e</p>
              </div>
            </ng-template>
          </div>
        </mat-tab>
      </mat-tab-group>

      <mat-card *ngIf="showRefuseDialog" class="request-card">
        <mat-card-title>Refuser ou proposer un autre horaire</mat-card-title>
        <mat-card-content>
          <mat-radio-group [(ngModel)]="selectedRefusalMode">
            <mat-radio-button value="refuse">Refuser la demande</mat-radio-button>
            <mat-radio-button value="propose">Proposer un autre horaire</mat-radio-button>
          </mat-radio-group>

          <div *ngIf="selectedRefusalMode === 'refuse'" class="mt-2">
            <mat-radio-group [(ngModel)]="selectedReason">
              <mat-radio-button *ngFor="let reason of REJECTION_REASONS" [value]="reason">{{ reason }}</mat-radio-button>
            </mat-radio-group>
            <mat-form-field *ngIf="selectedReason === 'Autre'" appearance="fill" class="w-full">
              <mat-label>Pr√©cisez</mat-label>
              <input matInput [(ngModel)]="customReason" />
            </mat-form-field>
          </div>

          <div *ngIf="selectedRefusalMode === 'propose'" class="mt-2">
            <mat-form-field appearance="fill">
              <mat-label>Date</mat-label>
              <input matInput [matDatepicker]="altDatePicker" [(ngModel)]="selectedAlternativeDate">
              <mat-datepicker-toggle matSuffix [for]="altDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #altDatePicker></mat-datepicker>
            </mat-form-field>
            <mat-form-field appearance="fill">
              <mat-label>Heure</mat-label>
              <input matInput type="time" [(ngModel)]="selectedAlternativeTime">
            </mat-form-field>
          </div>
        </mat-card-content>
        <mat-card-actions align="end">
          <button mat-button (click)="showRefuseDialog = false">Annuler</button>
          <button mat-raised-button color="warn" (click)="confirmRefusal()">Envoyer</button>
        </mat-card-actions>
      </mat-card>

      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
      <div class="column right-column">
        <h3>üìã Devoirs √† corriger</h3>
        <ul>
          <li *ngFor="let hw of homeworksToReview">
            {{ hw.title }} ‚Äî {{ hw.student }} (pour le {{ hw.dueDate }})
          </li>
        </ul>
      </div>

    </div>

    <!-- üîΩ –ù–ò–ñ–ù–Ø–Ø –ß–ê–°–¢–¨ -->
    <div class="bottom-section">
      <h3>üóìÔ∏è Prochains cours</h3>
      <div class="calendar-wrapper">
        <app-calendar-preview [events]="upcomingLessons" (eventClicked)="onCalendarEventClick($event)"></app-calendar-preview>
      </div>
    </div>

  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—É–¥–µ–Ω—Ç–µ -->
  <div *ngIf="showStudentModal" class="modal-overlay" (click)="closeStudentModal()">
    <div class="student-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üë§ Informations sur l'√©tudiant</h3>
        <button mat-icon-button (click)="closeStudentModal()" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="modal-content" *ngIf="selectedStudent">
        <div class="student-info">
          <p><strong>Nom:</strong> {{ selectedStudent.name }}</p>
          
          <!-- Objectif de l'√©tudiant -->
          <div style="margin: 16px 0;">
            <p><strong>üéØ Objectif d'apprentissage:</strong></p>
            <div *ngIf="selectedStudent.loadingGoal" class="loading-text" style="margin-left: 16px;">
              <mat-spinner diameter="16" style="display: inline-block; margin-right: 8px;"></mat-spinner>
              Chargement...
            </div>
            <div *ngIf="!selectedStudent.loadingGoal" style="margin-left: 16px;">
              <div *ngIf="selectedStudent.goal; else noGoal">
                <p style="margin: 4px 0; color: #1976d2; font-weight: bold;">
                  üìö {{ getExamLevelDisplay(selectedStudent.goal.examLevel) }}
                </p>
                <p *ngIf="selectedStudent.goal.targetDate" style="margin: 4px 0; color: #4caf50;">
                  üìÖ Objectif: {{ formatTargetDate(selectedStudent.goal.targetDate) }}
                </p>
                <div *ngIf="selectedStudent.goal.description" 
                     style="margin: 8px 0; padding: 8px; background-color: #f5f5f5; border-left: 3px solid #1976d2; border-radius: 4px;">
                  <strong>üí≠ Motivation:</strong> {{ selectedStudent.goal.description }}
                </div>
              </div>
              <ng-template #noGoal>
                <p style="color: #666; font-style: italic;">Aucun objectif d√©fini</p>
              </ng-template>
            </div>
          </div>
          
          <!-- Informations contextuelles -->
          <div *ngIf="selectedStudent.reason" style="margin: 16px 0;">
            <p><strong>‚ÑπÔ∏è Contexte:</strong> {{ selectedStudent.reason }}</p>
          </div>
          
          <div *ngIf="selectedStudent.refundAvailable !== undefined" style="margin: 16px 0;">
            <p><strong>üí∞ Remboursement:</strong> 
              <span [style.color]="selectedStudent.refundAvailable ? '#4caf50' : '#f44336'">
                {{ selectedStudent.refundAvailable ? '‚úÖ Disponible' : '‚ùå Non disponible' }}
              </span>
            </p>
          </div>
        </div>
        
        <div class="modal-actions">
          <button mat-raised-button color="primary" 
                  *ngIf="selectedStudent.lessonId"
                  (click)="navigateToLesson(selectedStudent.lessonId)">
            Aller √† la le√ßon
          </button>
          <button mat-stroked-button (click)="closeStudentModal()">
            Fermer
          </button>
        </div>
      </div>
    </div>
  </div>
