<div class="student-training-container">
  <!-- Header -->
  <div class="training-header">
    <h1 class="page-title">
      <i [class]="isTeacher() ? 'fas fa-chalkboard-teacher' : 'fas fa-user-graduate'"></i>
      {{ isTeacher() ? 'Espace P√©dagogique' : 'Mon Espace d\'Entra√Ænement' }}
    </h1>
    <p class="page-subtitle">
      {{ isTeacher() ? 'G√©rez vos mat√©riaux et devoirs pour vos √©tudiants' : 'Acc√©dez √† vos mat√©riaux et devoirs' }}
    </p>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filters-container">
      <!-- Teacher Filter -->
      <div class="filter-group">
        <label>
          <i class="fas fa-chalkboard-teacher"></i>
          Professeur
        </label>
        <select 
          [(ngModel)]="selectedTeacher"
          (change)="onTeacherFilterChange()"
          class="filter-control">
          <option value="">Tous les professeurs</option>
          <option 
            *ngFor="let teacher of teachers"
            [value]="teacher.name">
            {{ teacher.name }}
          </option>
        </select>
      </div>

      <!-- Material Type Filter -->
      <div class="filter-group" *ngIf="activeTab === 'materials'">
        <label>
          <i class="fas fa-filter"></i>
          Type de mat√©riau
        </label>
        <select 
          [(ngModel)]="selectedMaterialType"
          (change)="onMaterialTypeFilterChange()"
          class="filter-control">
          <option value="">Tous les types</option>
          <option value="text">üìÑ Texte</option>
          <option value="audio">üéß Audio</option>
          <option value="video">üé¨ Vid√©o</option>
          <option value="pdf">üìã PDF</option>
          <option value="image">üñºÔ∏è Image</option>
        </select>
      </div>

      <!-- Homework Status Filter -->
      <div class="filter-group" *ngIf="activeTab === 'homework'">
        <label>
          <i class="fas fa-tasks"></i>
          Statut
        </label>
        <select 
          [(ngModel)]="selectedHomeworkStatus"
          (change)="onHomeworkStatusFilterChange()"
          class="filter-control">
          <option value="">Tous les statuts</option>
          <option value="assigned">Assign√©</option>
          <option value="submitted">Soumis</option>
          <option value="completed">Termin√©</option>
          <option value="overdue">En retard</option>
        </select>
      </div>

      <!-- Date Filter -->
      <div class="filter-group" *ngIf="activeTab === 'homework'">
        <label>
          <i class="fas fa-calendar"></i>
          Date
        </label>
        <input 
          type="date" 
          [(ngModel)]="dateFilter"
          (change)="onDateFilterChange()"
          class="filter-control">
      </div>

      <!-- Clear Filters -->
      <button 
        class="btn btn-secondary clear-filters-btn"
        (click)="clearFilters()">
        <i class="fas fa-times"></i>
        Effacer
      </button>
    </div>
  </div>

  <!-- Main Tabs -->
  <div class="main-tabs">
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'materials'"
      (click)="activeTab = 'materials'">
      <i class="fas fa-folder-open"></i>
      Mat√©riaux
      <span class="badge" *ngIf="filteredMaterials.length">{{ filteredMaterials.length }}</span>
    </button>
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'homework'"
      (click)="activeTab = 'homework'">
      <i class="fas fa-clipboard-list"></i>
      Devoirs
      <span class="badge" *ngIf="filteredHomeworks.length">{{ filteredHomeworks.length }}</span>
    </button>
  </div>

  <!-- ==================== MATERIALS TAB ==================== -->
  <div *ngIf="activeTab === 'materials'" class="tab-content materials-tab">
    <!-- Loading State -->
    <div *ngIf="loadingMaterials" class="loading-state">
      <div class="spinner"></div>
      <p>Chargement des mat√©riaux...</p>
    </div>

    <!-- Materials Grid -->
    <div *ngIf="!loadingMaterials" class="materials-grid">
      <div 
        *ngFor="let material of filteredMaterials"
        class="material-card"
        (click)="openMaterial(material)">
        <div class="material-header">
          <div class="material-type">
            <i [class]="getMaterialTypeIcon(material.type)"></i>
            {{ material.type.toUpperCase() }}
          </div>
          <div class="material-teacher">
            Par {{ material.createdByName }}
          </div>
        </div>

        <div class="material-body">
          <h4 class="material-title">{{ material.title }}</h4>
          <p class="material-description" *ngIf="material.description">
            {{ material.description }}
          </p>
          
          <div class="material-preview">
            <div class="content-preview">
              {{ material.content | slice:0:150 }}
              <span *ngIf="material.content.length > 150">...</span>
            </div>
          </div>
          
          <div class="material-tags" *ngIf="material.tags.length">
            <span 
              *ngFor="let tag of material.tags"
              class="material-tag">
              #{{ tag }}
            </span>
          </div>
        </div>

        <div class="material-footer">
          <div class="material-date">
            <i class="fas fa-calendar"></i>
            {{ material.createdAt | date:'dd/MM/yyyy' }}
          </div>
          <div class="open-indicator">
            <i class="fas fa-external-link-alt"></i>
            Ouvrir
          </div>
        </div>
      </div>

      <!-- Empty State for Materials -->
      <div *ngIf="filteredMaterials.length === 0 && !loadingMaterials" class="empty-state">
        <i class="fas fa-folder-open"></i>
        <h3>Aucun mat√©riau disponible</h3>
        <p *ngIf="materials.length === 0">Votre professeur n'a pas encore partag√© de mat√©riaux avec vous</p>
        <p *ngIf="materials.length > 0">Aucun mat√©riau ne correspond aux filtres s√©lectionn√©s</p>
      </div>
    </div>
  </div>

  <!-- ==================== HOMEWORK TAB ==================== -->
  <div *ngIf="activeTab === 'homework'" class="tab-content homework-tab">
    
    <!-- Section Header with Create Button -->
    <div class="section-header">
      <h2>
        <i class="fas fa-clipboard-list"></i>
        {{ isTeacher() ? 'Gestion des Devoirs' : 'Mes Devoirs' }}
      </h2>
      <button 
        class="btn btn-primary"
        (click)="openCreateHomeworkForm()">
        <i class="fas fa-plus"></i>
        {{ isTeacher() ? 'Assigner un Devoir' : 'Nouveau Devoir' }}
      </button>
    </div>

    <!-- Create Homework Form -->
    <div *ngIf="showCreateHomeworkForm" class="create-form-modal">
      <div class="modal-overlay" (click)="clearHomeworkForm()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>
            <i class="fas fa-clipboard-list"></i>
            {{ isTeacher() ? 'Assigner un Devoir √† un √âtudiant' : 'Cr√©er un Nouveau Devoir' }}
          </h3>
          <button class="close-btn" (click)="clearHomeworkForm()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="modal-body">
          <div class="form-group">
            <label>Titre du devoir</label>
            <input 
              type="text" 
              [(ngModel)]="newHomework.title"
              placeholder="Ex: R√©vision du chapitre 3"
              class="form-control">
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea 
              [(ngModel)]="newHomework.description"
              placeholder="D√©crivez en d√©tail ce que vous devez faire..."
              rows="6"
              class="form-control"></textarea>
          </div>

          <div class="form-group">
            <label>Date limite</label>
            <input 
              type="datetime-local" 
              [(ngModel)]="newHomework.dueDate"
              class="form-control">
          </div>

          <div class="form-group">
            <label>
              {{ isTeacher() ? 'Cours pour l\'√©tudiant' : 'Cours associ√© (optionnel)' }}
              <span *ngIf="isTeacher()" class="text-danger">*</span>
            </label>
            <select [(ngModel)]="newHomework.lessonId" class="form-control" [required]="isTeacher()">
              <option value="">{{ isTeacher() ? 'S√©lectionner un cours' : 'Aucun cours sp√©cifique' }}</option>
              <option 
                *ngFor="let lesson of availableLessons"
                [value]="lesson.id">
                {{ getLessonTitle(lesson.id) }}
                <span *ngIf="isTeacher() && lesson.studentName"> - {{ lesson.studentName }}</span>
              </option>
            </select>
            <small *ngIf="isTeacher()" class="form-text text-muted">
              S√©lectionnez le cours pour lequel vous voulez assigner ce devoir
            </small>
          </div>

          <div class="form-group">
            <label>Mat√©riaux associ√©s (optionnel)</label>
            <div class="materials-selector">
              <div 
                *ngFor="let material of materials"
                class="material-option">
                <label class="checkbox-label">
                  <input 
                    type="checkbox" 
                    [value]="material.id"
                    (change)="toggleMaterialForHomework(material.id, $event)">
                  <span class="checkmark"></span>
                  {{ material.title }}
                  <small class="material-type-small">{{ material.type }}</small>
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="clearHomeworkForm()">
            Annuler
          </button>
          <button class="btn btn-primary" (click)="createHomework()">
            <i class="fas fa-save"></i>
            Cr√©er le Devoir
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loadingHomeworks" class="loading-state">
      <div class="spinner"></div>
      <p>Chargement des devoirs...</p>
    </div>

    <!-- Homework List Grouped by Lessons -->
    <div *ngIf="!loadingHomeworks" class="homework-list">
      <!-- Grouped Homework Display -->
      <div *ngFor="let group of getGroupedHomeworksArray()" class="lesson-group">
        <div class="lesson-group-header">
          <h3 class="lesson-title">
            <i class="fas fa-graduation-cap"></i>
            {{ group.lessonTitle }}
            <span class="homework-count">({{ group.homeworks.length }} devoir{{ group.homeworks.length > 1 ? 's' : '' }})</span>
          </h3>
        </div>

        <div class="lesson-homework-cards">
          <mat-card *ngFor="let homework of group.homeworks; let i = index" 
                    class="homework-card"
                    [class]="'type-' + (homework.sourceType || 'manual')">
            <mat-card-header>
              <mat-card-title>
                <div class="homework-header">
                  <span class="homework-number">{{ i + 1 }}.</span>
                  <mat-icon class="homework-type-icon">
                    {{ homework.sourceType === 'task' ? 'assignment' : 
                       homework.sourceType === 'question' ? 'quiz' : 
                       homework.sourceType === 'material' ? 'folder' : 'edit' }}
                  </mat-icon>
                  <span class="homework-title">{{ homework.title }}</span>
                  <span class="homework-status-badge" [class]="'status-' + homework.status">
                    {{ getHomeworkStatusText(homework.status) }}
                  </span>
                  
                  <!-- –ó–Ω–∞—á–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
                  <span *ngIf="homework.createdInClass" class="source-badge in-class" title="Cr√©√© en classe">
                    üè´ En classe
                  </span>
                  <span *ngIf="!homework.createdInClass" class="source-badge outside-class" title="Cr√©√© hors classe">
                    üè† Hors classe
              </span>
            </div>
              </mat-card-title>
              <mat-card-subtitle>
                <div class="homework-meta">
                  <span class="homework-type">
                    {{ homework.sourceType === 'task' ? 'T√¢che' : 
                       homework.sourceType === 'question' ? 'Question' : 
                       homework.sourceType === 'material' ? 'Mat√©riau' : 'Manuel' }}
                  </span>
                  <span class="homework-date">Cr√©√© le {{ homework.assignedAt | date:'dd/MM/yyyy √† HH:mm' }}</span>
                  <span class="homework-due" *ngIf="homework.dueDate">√âch√©ance: {{ homework.dueDate | date:'dd/MM/yyyy' }}</span>
            </div>
              </mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="homework-description">{{ homework.description }}</div>
              
              <!-- Source info for in-class homework -->
              <div *ngIf="homework.createdInClass && homework.sourceItemText" class="source-info">
                <strong>Source:</strong> {{ homework.sourceItemText }}
          </div>

          <!-- Linked Materials -->
              <div class="linked-materials" *ngIf="homework.materialIds && homework.materialIds.length">
            <h5>
              <i class="fas fa-paperclip"></i>
              Mat√©riaux associ√©s
            </h5>
            <div class="material-chips">
              <span 
                *ngFor="let materialId of homework.materialIds"
                class="material-chip">
                    {{ getMaterialTitle(materialId) }}
              </span>
            </div>
          </div>

              <!-- Teacher Feedback -->
          <div class="teacher-feedback" *ngIf="homework.teacherFeedback">
            <h5>
              <i class="fas fa-comment"></i>
              Commentaire du professeur
            </h5>
            <div class="feedback-content">
              {{ homework.teacherFeedback }}
            </div>
          </div>
            </mat-card-content>

            <mat-card-actions>
              <!-- Grade Display -->
          <div class="homework-grade" *ngIf="homework.grade !== undefined">
            <span class="grade-label">Note:</span>
                <span class="grade-value" 
                      [class.good]="homework.grade >= 15" 
                      [class.average]="homework.grade >= 10 && homework.grade < 15" 
                      [class.poor]="homework.grade < 10">
              {{ homework.grade }}/20
            </span>
          </div>
          
          <!-- Action Buttons -->
          <div class="homework-actions">
            <button 
              *ngIf="homework.status === 'assigned'"
                  mat-raised-button color="primary"
              (click)="submitHomework(homework.id)">
                  ‚úÖ Soumettre
                </button>
                <button 
                  *ngIf="homework.status !== 'assigned'"
                  mat-button color="accent">
                  üìù Modifier
            </button>
          </div>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>

      <!-- Empty State for Homework -->
      <div *ngIf="filteredHomeworks.length === 0 && !loadingHomeworks" class="empty-state">
        <i class="fas fa-clipboard-list"></i>
        <h3>{{ isTeacher() ? 'Aucun devoir cr√©√©' : 'Aucun devoir disponible' }}</h3>
        <p *ngIf="homeworks.length === 0">
          {{ isTeacher() ? 'Vous n\'avez pas encore cr√©√© de devoirs' : 'Vous n\'avez pas encore de devoirs assign√©s' }}
        </p>
        <p *ngIf="homeworks.length > 0">Aucun devoir ne correspond aux filtres s√©lectionn√©s</p>
        <div class="empty-state-hint" *ngIf="homeworks.length === 0">
          <small>üí° Les devoirs cr√©√©s en classe appara√Ætront ici, group√©s par cours</small>
        </div>
        <button 
          *ngIf="homeworks.length === 0"
          class="btn btn-primary"
          (click)="openCreateHomeworkForm()">
          <i class="fas fa-plus"></i>
          {{ isTeacher() ? 'Cr√©er le premier devoir' : 'Cr√©er un devoir personnel' }}
        </button>
      </div>
    </div>
  </div>
</div> 