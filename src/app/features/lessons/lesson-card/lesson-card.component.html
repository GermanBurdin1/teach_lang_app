<mat-card class="lesson-card">

  <!-- ğŸ§‘â€ğŸ« En-tÃªte de lâ€™enseignant et bouton -->
  <div class="lesson-header">
    <div class="teacher-info">
      <img class="avatar" src="https://via.placeholder.com/40" alt="avatar" />
      <div>
        <div class="name">ğŸ‘©â€ğŸ« {{ lesson.teacher }}</div>
        <div class="date">ğŸ“… {{ lesson.date | date: 'dd/MM/yyyy HH:mm' }}</div>
      </div>
    </div>

    <button *ngIf="showJoinButton()" mat-flat-button color="primary" (click)="enterVirtualClass()">
      ğŸ”— Rejoindre la classe
    </button>
  </div>

  <!-- ğŸ“‚ Corps principal -->
  <div class="lesson-body">
    <!-- ğŸ“ˆ Statistiques -->
    <div *ngIf="isPast()" class="stats">
      âœ… TÃ¢ches terminÃ©es : {{ lesson.tasksDone || 0 }}<br />
      âœ… Questions rÃ©solues : {{ lesson.questionsDone || 0 }}
    </div>
  </div>

  <!-- ğŸ§² Zones de glisser-dÃ©poser -->
  <div class="lesson-dnd">
    <!-- ğŸ“Œ TÃ¢ches -->
    <div class="drop-zone">
      <h4 (click)="toggleCollapse('tasks')" class="collapsible-header">
        ğŸ“Œ TÃ¢ches
        <span class="toggle-icon">{{ collapsedTasks ? 'ğŸ”½' : 'ğŸ”¼' }}</span>
      </h4>
      <div *ngIf="!collapsedTasks">

        <div cdkDropList [id]="'tasks-' + lesson.id" [cdkDropListData]="lesson.tasks"
          [cdkDropListConnectedTo]="taskDropIds" (cdkDropListDropped)="dropItem($event, 'task')">

          <div *ngFor="let task of lesson.tasks; let i = index" cdkDrag class="drag-item"
            (click)="onPastItemClick(task, 'task')" [class.clickable]="isPast()"
            [class.text-muted]="resolvedItems.includes(task)">
            {{ i + 1 }}. ğŸ›  {{ task }}
            <button *ngIf="!isPast()" mat-icon-button color="warn" (click)="removeItem('task', i)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>

        <div class="add-item" *ngIf="!isPast()">
          <mat-form-field appearance="fill" class="w-100">
            <mat-label>Ajouter une tÃ¢che</mat-label>
            <input matInput placeholder="ex: Analyser une chanson de Charles Aznavour" [(ngModel)]="newTask"
              (keydown.enter)="addItem('task', newTask); newTask=''">
          </mat-form-field>
          <button mat-icon-button color="primary" (click)="addItem('task', newTask); newTask=''"
            [disabled]="!newTask || !newTask.trim()">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- â“ Questions -->
    <div class="drop-zone">
      <h4 (click)="toggleCollapse('questions')" class="collapsible-header">
        â“ Questions
        <span class="toggle-icon">{{ collapsedQuestions ? 'ğŸ”½' : 'ğŸ”¼' }}</span>
      </h4>
      <div *ngIf="!collapsedQuestions">
        <div cdkDropList [id]="'questions-' + lesson.id" [cdkDropListData]="lesson.questions"
          [cdkDropListConnectedTo]="questionDropIds" (cdkDropListDropped)="dropItem($event, 'question')">

          <div *ngFor="let q of lesson.questions; let i = index" cdkDrag class="drag-item"
            (click)="onPastItemClick(q, 'question')" [class.clickable]="isPast()"
            [class.text-muted]="resolvedItems.includes(q)">
            {{ i + 1 }}. ğŸ’¬ {{ q }}
            <button *ngIf="!isPast()" mat-icon-button color="warn" (click)="removeItem('question', i)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>

        <div class="add-item" *ngIf="!isPast()">
          <mat-form-field appearance="fill" class="w-100">
            <mat-label>Ajouter une question</mat-label>
            <input matInput placeholder="ex: Quelle est la structure du discours indirect ?" [(ngModel)]="newQuestion"
              (keydown.enter)="addItem('question', newQuestion); newQuestion=''">
          </mat-form-field>
          <button mat-icon-button color="primary" (click)="addItem('question', newQuestion); newQuestion=''"
            [disabled]="!newQuestion || !newQuestion.trim()">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- ğŸ“š Devoirs -->
    <div class="drop-zone" *ngIf="newHomeworkFromClass.length > 0">
      <h4 (click)="toggleCollapse('homework')" class="collapsible-header">
        ğŸ“š Devoirs
        <span class="toggle-icon">{{ collapsedHomework ? 'ğŸ”½' : 'ğŸ”¼' }}</span>
      </h4>

      <div *ngIf="!collapsedHomework">
        <div *ngFor="let hw of newHomeworkFromClass; let i = index" class="drag-item text-muted">
          {{ i + 1 }}. ğŸ“š {{ hw }}
        </div>
      </div>
    </div>


  </div>

</mat-card>
