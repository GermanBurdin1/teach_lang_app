<div class="lesson-management" *ngIf="!activeLesson">

  <!-- === FILTRES + LEÇONS === -->
  <div *ngIf="activePanel === 'cours'">

    <!-- 🔍 Filtres -->
    <div class="filter-container mat-elevation-z1">
      <mat-button-toggle-group [(ngModel)]="filter" name="period" (change)="recalculateStatus()">
        <mat-button-toggle value="future">📅 À venir</mat-button-toggle>
        <mat-button-toggle value="past">🕓 Passés</mat-button-toggle>
        <mat-button-toggle value="all">📚 Tous</mat-button-toggle>
      </mat-button-toggle-group>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>👩‍🎓 Étudiant</mat-label>
        <mat-select [(ngModel)]="selectedStudent">
          <mat-option value="">Tous les étudiants</mat-option>
          <mat-option *ngFor="let s of uniqueStudents" [value]="s">{{ s }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>Date de début</mat-label>
        <input matInput type="date" [(ngModel)]="startDate">
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>Date de fin</mat-label>
        <input matInput type="date" [(ngModel)]="endDate">
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item keyword">
        <mat-label>Mot-clé</mat-label>
        <input matInput [(ngModel)]="searchTerm" placeholder="🔍 tâches, textes, etc.">
      </mat-form-field>
    </div>

    <!-- 📦 Liste des cours -->
    <div class="lesson-list">
      <app-teacher-lesson-card *ngFor="let lesson of filteredLessons" [lesson]="lesson" [lessonId]="lesson.id"
        [taskDropIds]="taskDropIds" [resolvedItems]="resolvedItemsPerLesson[lesson.id] || []"
        (itemDropped)="onItemDropped($event)" (openGabarit)="openGabarit(lesson)">
      </app-teacher-lesson-card>
      <div class="paginator-wrapper" *ngIf="activePanel === 'cours'">
        <mat-paginator [length]="fullFilteredLessons.length" [pageSize]="pageSize" [pageSizeOptions]="[4, 8, 12]"
          (page)="onPageChange($event)" [showFirstLastButtons]="true" aria-label="Pagination des cours">
        </mat-paginator>
      </div>

      <div *ngIf="filteredLessons.length < fullFilteredLessons.length" class="text-center mt-3">
        <button mat-stroked-button color="primary" (click)="loadMore()">Afficher plus</button>
      </div>
    </div>

  </div>


  <div *ngIf="activePanel === 'settings'" class="lesson-list p-3">
    <h3>⚙️ Paramètres</h3>
    <p class="text-muted">Zone de configuration (à définir)...</p>
  </div>

  <div *ngIf="activePanel === 'stats'" class="lesson-list p-3">
    <h3>📈 Statistiques globales</h3>

    <ul class="mb-3">
      <li>Cours passés : {{ pastLessonsCount }}</li>
      <li>Cours à venir : {{ futureLessonsCount }}</li>
      <li>Étudiants uniques : {{ uniqueStudents.length }}</li>
    </ul>

    <h4>🎯 Objectifs</h4>
    <p class="text-muted">Définir des objectifs à long terme ici...</p>
  </div>


  <!-- ⬅️ Сайдбар -->
  <div class="side-tabs-wrapper" (mouseenter)="hideTabs = false" (mouseleave)="hideTabs = true">
    <div class="side-tabs">
      <div class="tab-button" (click)="activePanel = 'cours'" [class.active]="activePanel === 'cours'"
        [class.expanded]="!hideTabs">
        📋 <span class="label" *ngIf="!hideTabs">Cours</span>
      </div>
      <div class="tab-button" (click)="activePanel = 'stats'" [class.active]="activePanel === 'stats'"
        [class.expanded]="!hideTabs">
        📈 <span class="label" *ngIf="!hideTabs">Statistiques</span>
      </div>
      <div class="tab-button" (click)="activePanel = 'settings'" [class.active]="activePanel === 'settings'"
        [class.expanded]="!hideTabs">
        ⚙️ <span class="label" *ngIf="!hideTabs">Paramètres</span>
      </div>


    </div>
  </div>
</div>

<!-- Габарит -->
<app-gabarit *ngIf="activeLesson" [lesson]="activeLesson" [visible]="true" [close]="closeGabarit.bind(this)">
</app-gabarit>

<div class="teacher-lesson-management">
  <!-- Индикатор загрузки -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Chargement du cours...</p>
  </div>

  <!-- Основной контент -->
  <div *ngIf="!loading && currentLesson" class="lesson-details">
    <!-- Заголовок урока -->
    <div class="lesson-header mat-elevation-z2">
      <h2>👨‍🏫 Cours avec {{ currentLesson.studentName || 'Étudiant' }}</h2>
      <p>📅 {{ currentLesson.scheduledAt | date:'short' }}</p>
      <p>📊 Statut: {{ currentLesson.status === 'future' ? 'À venir' : 'Passé' }}</p>
    </div>

    <!-- Вкладки -->
    <mat-tab-group>
      <!-- Вкладка: Задачи студента -->
      <mat-tab label="📝 Tâches de l'étudiant">
        <div class="tab-content">
          <!-- Задачи, созданные студентом -->
          <div class="section">
            <h3>📋 Tâches créées par l'étudiant</h3>
            <div class="tasks-list">
              <mat-card *ngFor="let task of studentTasks" class="task-card" 
                        [class.completed]="task.isCompleted">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon *ngIf="task.isCompleted" class="completed-icon">check_circle</mat-icon>
                    <mat-icon *ngIf="!task.isCompleted" class="pending-icon">radio_button_unchecked</mat-icon>
                    {{ task.title }}
                  </mat-card-title>
                  <mat-card-subtitle>
                    Créée le {{ task.createdAt | date:'short' }}
                    <span *ngIf="task.isCompleted" class="completion-info">
                      - Terminée le {{ task.completedAt | date:'short' }}
                    </span>
                  </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content *ngIf="task.description">
                  <p>{{ task.description }}</p>
                </mat-card-content>
              </mat-card>
            </div>

            <!-- Message si pas de tâches étudiantes -->
            <div *ngIf="studentTasks.length === 0" class="no-items">
              <mat-icon>assignment_ind</mat-icon>
              <p>L'étudiant n'a pas encore créé de tâches</p>
            </div>
          </div>

          <!-- Задачи, назначенные преподавателем -->
          <div class="section">
            <h3>📋 Tâches assignées à l'étudiant</h3>
            
            <!-- Форма добавления задачи -->
            <div class="add-form" *ngIf="showAddTaskForm">
              <mat-card>
                <mat-card-header>
                  <mat-card-title>➕ Assigner une nouvelle tâche</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Titre de la tâche</mat-label>
                    <input matInput [(ngModel)]="newTaskTitle" 
                           placeholder="Ex: Analyser le poème de Baudelaire">
                  </mat-form-field>
                  
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Description détaillée</mat-label>
                    <textarea matInput [(ngModel)]="newTaskDescription" rows="3" 
                              placeholder="Instructions détaillées pour l'étudiant..."></textarea>
                  </mat-form-field>
                </mat-card-content>
                <mat-card-actions align="end">
                  <button mat-button (click)="clearTaskForm()">Annuler</button>
                  <button mat-raised-button color="primary" (click)="addTaskForStudent()"
                          [disabled]="!newTaskTitle.trim()">
                    Assigner la tâche
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>

            <!-- Bouton для вывода формы -->
            <button *ngIf="!showAddTaskForm" mat-raised-button color="primary" 
                    (click)="showAddTaskForm = true" class="add-button">
              ➕ Assigner une tâche
            </button>

            <!-- Liste des tâches assignées -->
            <div class="tasks-list">
              <mat-card *ngFor="let task of teacherTasks" class="task-card assigned-task">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>assignment</mat-icon>
                    {{ task.title }}
                  </mat-card-title>
                  <mat-card-subtitle>
                    Assignée le {{ task.createdAt | date:'short' }}
                  </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content *ngIf="task.description">
                  <p>{{ task.description }}</p>
                </mat-card-content>
              </mat-card>
            </div>

            <!-- Message si pas de tâches assignées -->
            <div *ngIf="teacherTasks.length === 0" class="no-items">
              <mat-icon>assignment</mat-icon>
              <p>Aucune tâche assignée à l'étudiant</p>
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Вкладка: Вопросы студента -->
      <mat-tab label="❓ Questions de l'étudiant">
        <div class="tab-content">
          <!-- Вопросы без ответа -->
          <div class="section">
            <h3>❓ Questions en attente de réponse</h3>
            
            <div class="questions-list">
              <mat-card *ngFor="let question of unansweredQuestions" class="question-card pending">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>help_outline</mat-icon>
                    {{ question.question }}
                  </mat-card-title>
                  <mat-card-subtitle>
                    Posée le {{ question.createdAt | date:'short' }}
                  </mat-card-subtitle>
                </mat-card-header>
                
                <!-- Форма ответа -->
                <mat-card-content *ngIf="answeringQuestionId === question.id">
                  <div class="answer-form">
                    <mat-form-field appearance="fill" class="full-width">
                      <mat-label>Votre réponse</mat-label>
                      <textarea matInput [(ngModel)]="answerText" rows="3" 
                                placeholder="Tapez votre réponse détaillée..."></textarea>
                    </mat-form-field>
                    <div class="answer-actions">
                      <button mat-button (click)="cancelAnswering()">Annuler</button>
                      <button mat-raised-button color="primary" 
                              (click)="answerQuestion(question.id)"
                              [disabled]="!answerText.trim()">
                        Envoyer la réponse
                      </button>
                    </div>
                  </div>
                </mat-card-content>
                
                <!-- Кнопка для начала ответа -->
                <mat-card-actions *ngIf="answeringQuestionId !== question.id">
                  <button mat-raised-button color="accent" 
                          (click)="startAnswering(question.id)">
                    💬 Répondre
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>

            <!-- Message si pas de questions en attente -->
            <div *ngIf="unansweredQuestions.length === 0" class="no-items">
              <mat-icon>quiz</mat-icon>
              <p>Aucune question en attente de réponse</p>
            </div>
          </div>

          <!-- Вопросы с ответами -->
          <div class="section">
            <h3>✅ Questions déjà répondues</h3>
            
            <div class="questions-list">
              <mat-card *ngFor="let question of answeredQuestions" class="question-card answered">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>help</mat-icon>
                    {{ question.question }}
                  </mat-card-title>
                  <mat-card-subtitle>
                    Posée le {{ question.createdAt | date:'short' }}
                  </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                  <div class="answer">
                    <strong>Votre réponse:</strong>
                    <p>{{ question.answer }}</p>
                    <small>Répondu le {{ question.answeredAt | date:'short' }}</small>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>

            <!-- Message si pas de questions répondues -->
            <div *ngIf="answeredQuestions.length === 0" class="no-items">
              <mat-icon>quiz</mat-icon>
              <p>Aucune question répondue pour ce cours</p>
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Вкладка: Материалы -->
      <mat-tab label="📚 Matériaux du cours">
        <div class="tab-content">
          <div class="section">
            <h3>📚 Ajouter des matériaux</h3>
            
            <!-- Форма добавления материала -->
            <div class="add-form" *ngIf="showAddMaterialForm">
              <mat-card>
                <mat-card-header>
                  <mat-card-title>➕ Ajouter un nouveau matériau</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Titre du matériau</mat-label>
                    <input matInput [(ngModel)]="newMaterialTitle" 
                           placeholder="Ex: Introduction à la poésie française">
                  </mat-form-field>
                  
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Type de matériau</mat-label>
                    <mat-select [(ngModel)]="newMaterialType">
                      <mat-option value="text">📄 Texte</mat-option>
                      <mat-option value="audio">🎵 Audio</mat-option>
                      <mat-option value="video">🎥 Vidéo</mat-option>
                    </mat-select>
                  </mat-form-field>
                  
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>
                      {{ newMaterialType === 'text' ? 'Contenu du texte' : 'URL du fichier' }}
                    </mat-label>
                    <textarea matInput [(ngModel)]="newMaterialContent" rows="4" 
                              [placeholder]="newMaterialType === 'text' ? 'Tapez le contenu...' : 'https://example.com/fichier.mp3'"></textarea>
                  </mat-form-field>
                </mat-card-content>
                <mat-card-actions align="end">
                  <button mat-button (click)="clearMaterialForm()">Annuler</button>
                  <button mat-raised-button color="primary" 
                          [disabled]="!newMaterialTitle.trim() || !newMaterialContent.trim()">
                    Ajouter le matériau
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>

            <!-- Bouton для вывода формы -->
            <button *ngIf="!showAddMaterialForm" mat-raised-button color="primary" 
                    (click)="showAddMaterialForm = true" class="add-button">
              📚 Ajouter un matériau
            </button>
            
            <!-- Message temporaire -->
            <div class="no-items">
              <mat-icon>library_books</mat-icon>
              <p>La gestion des matériaux sera implémentée prochainement</p>
            </div>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>

  <!-- Message если нет урока -->
  <div *ngIf="!loading && !currentLesson" class="no-lesson">
    <mat-icon>school</mat-icon>
    <h3>Aucun cours sélectionné</h3>
    <p>Cliquez sur un cours dans le calendrier pour commencer à gérer les tâches et répondre aux questions.</p>
  </div>
</div>
