<!-- ОСНОВНАЯ ПАНЕЛЬ ПРЕПОДАВАТЕЛЯ (когда НЕ выбран конкретный урок) -->
<div class="lesson-management" *ngIf="!currentLesson">

  <!-- === FILTRES + LEÇONS === -->
  <div *ngIf="activePanel === 'cours'">

    <!-- 🔍 Filtres -->
    <div class="filter-container mat-elevation-z1">
      <mat-button-toggle-group [(ngModel)]="filter" name="period" (change)="recalculateStatus()">
        <mat-button-toggle value="future">📅 À venir</mat-button-toggle>
        <mat-button-toggle value="past">🕓 Passés</mat-button-toggle>
        <mat-button-toggle value="all">📚 Tous</mat-button-toggle>
      </mat-button-toggle-group>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>👩‍🎓 Étudiant</mat-label>
        <mat-select [(ngModel)]="selectedStudent">
          <mat-option value="">Tous les étudiants</mat-option>
          <mat-option *ngFor="let s of uniqueStudents" [value]="s">{{ s }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>Date de début</mat-label>
        <input matInput type="date" [(ngModel)]="startDate">
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>Date de fin</mat-label>
        <input matInput type="date" [(ngModel)]="endDate">
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item keyword">
        <mat-label>Mot-clé</mat-label>
        <input matInput [(ngModel)]="searchTerm" placeholder="🔍 tâches, textes, etc.">
      </mat-form-field>
    </div>

    <!-- 📦 Liste des cours -->
    <div class="lesson-list">
      <app-teacher-lesson-card *ngFor="let lesson of filteredLessons" 
        [lesson]="lesson" 
        [lessonId]="lesson.id"
        [taskDropIds]="taskDropIds" 
        [resolvedItems]="resolvedItemsPerLesson[lesson.id] || []"
        (itemDropped)="onItemDropped($event)" 
        (openGabarit)="openGabarit(lesson)">
      </app-teacher-lesson-card>
      
      <div class="paginator-wrapper" *ngIf="activePanel === 'cours'">
        <mat-paginator [length]="fullFilteredLessons.length" [pageSize]="pageSize" [pageSizeOptions]="[4, 8, 12]"
          (page)="onPageChange($event)" [showFirstLastButtons]="true" aria-label="Pagination des cours">
        </mat-paginator>
      </div>

      <div *ngIf="filteredLessons.length < fullFilteredLessons.length" class="text-center mt-3">
        <button mat-stroked-button color="primary" (click)="loadMore()">Afficher plus</button>
      </div>
    </div>
  </div>

  <div *ngIf="activePanel === 'settings'" class="lesson-list p-3">
    <h3>⚙️ Paramètres</h3>
    <p class="text-muted">Zone de configuration (à définir)...</p>
  </div>

  <div *ngIf="activePanel === 'stats'" class="lesson-list p-3">
    <h3>📈 Statistiques globales</h3>
    <ul class="mb-3">
      <li>Cours passés : {{ pastLessonsCount }}</li>
      <li>Cours à venir : {{ futureLessonsCount }}</li>
      <li>Étudiants uniques : {{ uniqueStudents.length }}</li>
    </ul>
    <h4>🎯 Objectifs</h4>
    <p class="text-muted">Définir des objectifs à long terme ici...</p>
  </div>

  <!-- ⬅️ Сайдбар -->
  <div class="side-tabs-wrapper" (mouseenter)="hideTabs = false" (mouseleave)="hideTabs = true">
    <div class="side-tabs">
      <div class="tab-button" (click)="activePanel = 'cours'" [class.active]="activePanel === 'cours'" [class.expanded]="!hideTabs">
        📋 <span class="label" *ngIf="!hideTabs">Cours</span>
      </div>
      <div class="tab-button" (click)="activePanel = 'stats'" [class.active]="activePanel === 'stats'" [class.expanded]="!hideTabs">
        📈 <span class="label" *ngIf="!hideTabs">Statistiques</span>
      </div>
      <div class="tab-button" (click)="activePanel = 'settings'" [class.active]="activePanel === 'settings'" [class.expanded]="!hideTabs">
        ⚙️ <span class="label" *ngIf="!hideTabs">Paramètres</span>
      </div>
    </div>
  </div>
</div>

<!-- Габарит -->
<app-gabarit *ngIf="activeLesson" [lesson]="activeLesson" [visible]="true" [close]="closeGabarit.bind(this)">
</app-gabarit>

<!-- ОБЩАЯ КАРТОЧКА УРОКА (когда выбран конкретный урок) -->
<div class="teacher-lesson-management" *ngIf="currentLesson">
  <!-- Индикатор загрузки -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Chargement du cours...</p>
  </div>

  <!-- Основной контент -->
  <div *ngIf="!loading && currentLesson" class="lesson-details">
    <!-- En-tête du cours -->
    <div class="lesson-header mat-elevation-z2">
      <div class="lesson-header-content">
        <div class="lesson-info">
          <h2>👨‍🏫 Cours avec {{ currentLesson.studentName || 'Étudiant' }}</h2>
          <p>📅 {{ currentLesson.scheduledAt | date:'dd/MM/yyyy à HH:mm' }}</p>
          <div class="status-container">
            <span class="status-label">📊 Statut:</span>
            <span class="status-badge" [ngClass]="getStatusClass(currentLesson.status)">
              {{ getStatusText(currentLesson.status) }}
            </span>
          </div>
        </div>
        <div class="lesson-actions" *ngIf="canEnterClass(currentLesson)">
          <button mat-raised-button 
                  color="accent" 
                  (click)="enterVirtualClass(currentLesson)"
                  class="enter-class-btn large">
            🎥 Entrer en classe
          </button>
        </div>
      </div>
    </div>

    <!-- Вкладки -->
    <mat-tab-group>
      <!-- Вкладка: Задачи -->
      <mat-tab label="📝 Tâches du cours">
        <div class="tab-content">
          <!-- Форма добавления задачи -->
          <div class="add-form" *ngIf="showAddTaskForm">
            <mat-card>
              <mat-card-header>
                <mat-card-title>➕ Assigner une nouvelle tâche</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>Titre de la tâche</mat-label>
                  <input matInput [(ngModel)]="newTaskTitle" 
                         placeholder="Ex: Analyser le poème de Baudelaire">
                </mat-form-field>
                
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>Description détaillée</mat-label>
                  <textarea matInput [(ngModel)]="newTaskDescription" rows="3" 
                            placeholder="Instructions détaillées pour l'étudiant..."></textarea>
                </mat-form-field>
              </mat-card-content>
              <mat-card-actions align="end">
                <button mat-button (click)="clearTaskForm()">Annuler</button>
                <button mat-raised-button color="primary" (click)="addTaskForStudent()"
                        [disabled]="!newTaskTitle.trim()">
                  Assigner la tâche
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <!-- Bouton для отображения формы -->
          <button *ngIf="!showAddTaskForm" mat-raised-button color="primary" 
                  (click)="showAddTaskForm = true" class="add-button">
            ➕ Assigner une tâche
          </button>

          <!-- Liste unifiée des tâches -->
          <div class="tasks-list">
            <mat-card *ngFor="let task of currentLesson.tasks; let i = index" 
                      class="task-card" 
                      [class.completed]="task.isCompleted"
                      [class.student-task]="task.createdByRole === 'student'"
                      [class.teacher-task]="task.createdByRole === 'teacher'">
              <mat-card-header>
                <mat-card-title>
                  <div class="task-header">
                    <span class="task-number">{{ i + 1 }}.</span>
                    <mat-icon class="role-icon" [class.student-icon]="task.createdByRole === 'student'" 
                              [class.teacher-icon]="task.createdByRole === 'teacher'">
                      {{ task.createdByRole === 'student' ? 'person' : 'school' }}
                    </mat-icon>
                    <span class="task-title">{{ task.title }}</span>
                    <mat-icon class="status-icon" *ngIf="task.isCompleted">check_circle</mat-icon>
                    <mat-icon class="status-icon" *ngIf="!task.isCompleted">radio_button_unchecked</mat-icon>
                  </div>
                </mat-card-title>
                <mat-card-subtitle>
                  <span class="author-badge" [class.student-badge]="task.createdByRole === 'student'"
                        [class.teacher-badge]="task.createdByRole === 'teacher'">
                    {{ task.createdByRole === 'student' ? '👨‍🎓 Étudiant' : '👨‍🏫 Professeur' }}
                  </span>
                  <span class="date">{{ task.createdAt | date:'dd/MM/yyyy à HH:mm' }}</span>
                  <span *ngIf="task.isCompleted" class="completion-info">
                    - ✅ Terminée le {{ task.completedAt | date:'dd/MM/yyyy à HH:mm' }}
                  </span>
                </mat-card-subtitle>
              </mat-card-header>
              <mat-card-content *ngIf="task.description">
                <p>{{ task.description }}</p>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Message si pas de tâches -->
          <div *ngIf="currentLesson.tasks.length === 0" class="no-items">
            <mat-icon>assignment</mat-icon>
            <p>Aucune tâche pour ce cours</p>
          </div>
        </div>
      </mat-tab>

      <!-- Вкладка: Вопросы -->
      <mat-tab label="❓ Questions du cours">
        <div class="tab-content">
          <!-- Форма добавления вопроса -->
          <div class="add-form" *ngIf="showAddQuestionForm">
            <mat-card>
              <mat-card-header>
                <mat-card-title>➕ Poser une question à l'étudiant</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>Votre question</mat-label>
                  <textarea matInput [(ngModel)]="newQuestionText" rows="3" 
                            placeholder="Ex: Avez-vous compris la différence entre...?"></textarea>
                </mat-form-field>
              </mat-card-content>
              <mat-card-actions align="end">
                <button mat-button (click)="clearQuestionForm()">Annuler</button>
                <button mat-raised-button color="primary" (click)="addQuestionToStudent()"
                        [disabled]="!newQuestionText.trim()">
                  Poser la question
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <!-- Bouton для отображения формы -->
          <button *ngIf="!showAddQuestionForm" mat-raised-button color="primary" 
                  (click)="showAddQuestionForm = true" class="add-button">
            ❓ Poser une question
          </button>

          <!-- Liste unifiée des questions -->
          <div class="questions-list">
            <mat-card *ngFor="let question of currentLesson.questions; let i = index" 
                      class="question-card"
                      [class.answered]="question.isAnswered"
                      [class.student-question]="question.createdByRole === 'student'"
                      [class.teacher-question]="question.createdByRole === 'teacher'">
              <mat-card-header>
                <mat-card-title>
                  <div class="question-header">
                    <span class="question-number">{{ i + 1 }}.</span>
                    <mat-icon class="role-icon" [class.student-icon]="question.createdByRole === 'student'" 
                              [class.teacher-icon]="question.createdByRole === 'teacher'">
                      {{ question.createdByRole === 'student' ? 'person' : 'school' }}
                    </mat-icon>
                    <span class="question-text">{{ question.question }}</span>
                    <mat-icon class="status-icon" *ngIf="question.isAnswered">help</mat-icon>
                    <mat-icon class="status-icon" *ngIf="!question.isAnswered">help_outline</mat-icon>
                  </div>
                </mat-card-title>
                <mat-card-subtitle>
                  <span class="author-badge" [class.student-badge]="question.createdByRole === 'student'"
                        [class.teacher-badge]="question.createdByRole === 'teacher'">
                    {{ question.createdByRole === 'student' ? '👨‍🎓 Étudiant' : '👨‍🏫 Professeur' }}
                  </span>
                  <span class="date">{{ question.createdAt | date:'dd/MM/yyyy à HH:mm' }}</span>
                </mat-card-subtitle>
              </mat-card-header>
              
              <!-- Ответ, если есть -->
              <mat-card-content *ngIf="question.isAnswered && question.answer">
                <div class="answer">
                  <strong>💬 Réponse:</strong>
                  <p>{{ question.answer }}</p>
                  <small>Répondu le {{ question.answeredAt | date:'dd/MM/yyyy à HH:mm' }}</small>
                </div>
              </mat-card-content>

              <!-- Форма ответа (только для вопросов студентов без ответа) -->
              <mat-card-content *ngIf="!question.isAnswered && question.createdByRole === 'student' && answeringQuestionId === question.id">
                <div class="answer-form">
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Votre réponse</mat-label>
                    <textarea matInput [(ngModel)]="answerText" rows="3" 
                              placeholder="Tapez votre réponse détaillée..."></textarea>
                  </mat-form-field>
                  <div class="answer-actions">
                    <button mat-button (click)="cancelAnswering()">Annuler</button>
                    <button mat-raised-button color="primary" 
                            (click)="answerQuestion(question.id)"
                            [disabled]="!answerText.trim()">
                      Envoyer la réponse
                    </button>
                  </div>
                </div>
              </mat-card-content>

              <!-- Статус для вопросов без ответа -->
              <mat-card-content *ngIf="!question.isAnswered && answeringQuestionId !== question.id">
                <p class="waiting-answer" *ngIf="question.createdByRole === 'teacher'">
                  ⏳ En attente de réponse de l'étudiant...
                </p>
                <p class="waiting-answer" *ngIf="question.createdByRole === 'student'">
                  ⏳ En attente de votre réponse...
                </p>
              </mat-card-content>
              
              <!-- Кнопка для ответа (только для вопросов студентов без ответа) -->
              <mat-card-actions *ngIf="!question.isAnswered && question.createdByRole === 'student' && answeringQuestionId !== question.id">
                <button mat-raised-button color="accent" 
                        (click)="startAnswering(question.id)">
                  💬 Répondre
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <!-- Message si pas de questions -->
          <div *ngIf="currentLesson.questions.length === 0" class="no-items">
            <mat-icon>quiz</mat-icon>
            <p>Aucune question pour ce cours</p>
          </div>
        </div>
      </mat-tab>

      <!-- Вкладка: Материалы -->
      <mat-tab label="📚 Matériaux du cours">
        <div class="tab-content">
          <div class="section">
            <h3>📚 Ajouter des matériaux</h3>
            
            <!-- Форма добавления материала -->
            <div class="add-form" *ngIf="showAddMaterialForm">
              <mat-card>
                <mat-card-header>
                  <mat-card-title>➕ Ajouter un nouveau matériau</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Titre du matériau</mat-label>
                    <input matInput [(ngModel)]="newMaterialTitle" 
                           placeholder="Ex: Introduction à la poésie française">
                  </mat-form-field>
                  
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Type de matériau</mat-label>
                    <mat-select [(ngModel)]="newMaterialType">
                      <mat-option value="text">📄 Texte</mat-option>
                      <mat-option value="audio">🎵 Audio</mat-option>
                      <mat-option value="video">🎥 Vidéo</mat-option>
                    </mat-select>
                  </mat-form-field>
                  
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>
                      {{ newMaterialType === 'text' ? 'Contenu du texte' : 'URL du fichier' }}
                    </mat-label>
                    <textarea matInput [(ngModel)]="newMaterialContent" rows="4" 
                              [placeholder]="newMaterialType === 'text' ? 'Tapez le contenu...' : 'https://example.com/fichier.mp3'"></textarea>
                  </mat-form-field>
                </mat-card-content>
                <mat-card-actions align="end">
                  <button mat-button (click)="clearMaterialForm()">Annuler</button>
                  <button mat-raised-button color="primary" 
                          [disabled]="!newMaterialTitle.trim() || !newMaterialContent.trim()">
                    Ajouter le matériau
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>

            <!-- Bouton для вывода формы -->
            <button *ngIf="!showAddMaterialForm" mat-raised-button color="primary" 
                    (click)="showAddMaterialForm = true" class="add-button">
              📚 Ajouter un matériau
            </button>
            
            <!-- Message temporaire -->
            <div class="no-items">
              <mat-icon>library_books</mat-icon>
              <p>La gestion des matériaux sera implémentée prochainement</p>
            </div>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>

  <!-- Message если нет урока -->
  <div *ngIf="!loading && !currentLesson" class="no-lesson">
    <mat-icon>school</mat-icon>
    <h3>Aucun cours sélectionné</h3>
    <p>Cliquez sur un cours dans le calendrier pour commencer à gérer les tâches et répondre aux questions.</p>
  </div>
</div>
