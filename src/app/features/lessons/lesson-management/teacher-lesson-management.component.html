<div class="lesson-management" *ngIf="!activeLesson">

  <!-- === FILTRES + LEÃ‡ONS === -->
  <div *ngIf="activePanel === 'cours'">

    <!-- ğŸ” Filtres -->
    <div class="filter-container mat-elevation-z1">
      <mat-button-toggle-group [(ngModel)]="filter" name="period" (change)="recalculateStatus()">
        <mat-button-toggle value="future">ğŸ“… Ã€ venir</mat-button-toggle>
        <mat-button-toggle value="past">ğŸ•“ PassÃ©s</mat-button-toggle>
        <mat-button-toggle value="all">ğŸ“š Tous</mat-button-toggle>
      </mat-button-toggle-group>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>ğŸ‘©â€ğŸ“ Ã‰tudiant</mat-label>
        <mat-select [(ngModel)]="selectedStudent">
          <mat-option value="">Tous les Ã©tudiants</mat-option>
          <mat-option *ngFor="let s of uniqueStudents" [value]="s">{{ s }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>Date de dÃ©but</mat-label>
        <input matInput type="date" [(ngModel)]="startDate">
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>Date de fin</mat-label>
        <input matInput type="date" [(ngModel)]="endDate">
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item keyword">
        <mat-label>Mot-clÃ©</mat-label>
        <input matInput [(ngModel)]="searchTerm" placeholder="ğŸ” tÃ¢ches, textes, etc.">
      </mat-form-field>
    </div>

    <!-- ğŸ“¦ Liste des cours -->
    <div class="lesson-list">
      <app-teacher-lesson-card *ngFor="let lesson of filteredLessons" [lesson]="lesson" [lessonId]="lesson.id"
        [taskDropIds]="taskDropIds" [resolvedItems]="resolvedItemsPerLesson[lesson.id] || []"
        (itemDropped)="onItemDropped($event)" (openGabarit)="openGabarit(lesson)">
      </app-teacher-lesson-card>
      <div class="paginator-wrapper" *ngIf="activePanel === 'cours'">
        <mat-paginator [length]="fullFilteredLessons.length" [pageSize]="pageSize" [pageSizeOptions]="[4, 8, 12]"
          (page)="onPageChange($event)" [showFirstLastButtons]="true" aria-label="Pagination des cours">
        </mat-paginator>
      </div>

      <div *ngIf="filteredLessons.length < fullFilteredLessons.length" class="text-center mt-3">
        <button mat-stroked-button color="primary" (click)="loadMore()">Afficher plus</button>
      </div>
    </div>

  </div>


  <div *ngIf="activePanel === 'settings'" class="lesson-list p-3">
    <h3>âš™ï¸ ParamÃ¨tres</h3>
    <p class="text-muted">Zone de configuration (Ã  dÃ©finir)...</p>
  </div>

  <div *ngIf="activePanel === 'stats'" class="lesson-list p-3">
    <h3>ğŸ“ˆ Statistiques globales</h3>

    <ul class="mb-3">
      <li>Cours passÃ©s : {{ pastLessonsCount }}</li>
      <li>Cours Ã  venir : {{ futureLessonsCount }}</li>
      <li>Ã‰tudiants uniques : {{ uniqueStudents.length }}</li>
    </ul>

    <h4>ğŸ¯ Objectifs</h4>
    <p class="text-muted">DÃ©finir des objectifs Ã  long terme ici...</p>
  </div>


  <!-- â¬…ï¸ Ğ¡Ğ°Ğ¹Ğ´Ğ±Ğ°Ñ€ -->
  <div class="side-tabs-wrapper" (mouseenter)="hideTabs = false" (mouseleave)="hideTabs = true">
    <div class="side-tabs">
      <div class="tab-button" (click)="activePanel = 'cours'" [class.active]="activePanel === 'cours'"
        [class.expanded]="!hideTabs">
        ğŸ“‹ <span class="label" *ngIf="!hideTabs">Cours</span>
      </div>
      <div class="tab-button" (click)="activePanel = 'stats'" [class.active]="activePanel === 'stats'"
        [class.expanded]="!hideTabs">
        ğŸ“ˆ <span class="label" *ngIf="!hideTabs">Statistiques</span>
      </div>
      <div class="tab-button" (click)="activePanel = 'settings'" [class.active]="activePanel === 'settings'"
        [class.expanded]="!hideTabs">
        âš™ï¸ <span class="label" *ngIf="!hideTabs">ParamÃ¨tres</span>
      </div>


    </div>
  </div>
</div>

<!-- Ğ“Ğ°Ğ±Ğ°Ñ€Ğ¸Ñ‚ -->
<app-gabarit *ngIf="activeLesson" [lesson]="activeLesson" [visible]="true" [close]="closeGabarit.bind(this)">
</app-gabarit>

<div class="teacher-lesson-management">
  <!-- Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Chargement du cours...</p>
  </div>

  <!-- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ -->
  <div *ngIf="!loading && currentLesson" class="lesson-details">
    <!-- Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº ÑƒÑ€Ğ¾ĞºĞ° -->
    <div class="lesson-header mat-elevation-z2">
      <h2>ğŸ‘¨â€ğŸ« Cours avec {{ currentLesson.studentName || 'Ã‰tudiant' }}</h2>
      <p>ğŸ“… {{ currentLesson.scheduledAt | date:'short' }}</p>
      <p>ğŸ“Š Statut: {{ currentLesson.status === 'future' ? 'Ã€ venir' : 'PassÃ©' }}</p>
    </div>

    <!-- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ¸ -->
    <mat-tab-group>
      <!-- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ°: Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° -->
      <mat-tab label="ğŸ“ TÃ¢ches de l'Ã©tudiant">
        <div class="tab-content">
          <!-- Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ¼ -->
          <div class="section">
            <h3>ğŸ“‹ TÃ¢ches crÃ©Ã©es par l'Ã©tudiant</h3>
            <div class="tasks-list">
              <mat-card *ngFor="let task of studentTasks" class="task-card" 
                        [class.completed]="task.isCompleted">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon *ngIf="task.isCompleted" class="completed-icon">check_circle</mat-icon>
                    <mat-icon *ngIf="!task.isCompleted" class="pending-icon">radio_button_unchecked</mat-icon>
                    {{ task.title }}
                  </mat-card-title>
                  <mat-card-subtitle>
                    CrÃ©Ã©e le {{ task.createdAt | date:'short' }}
                    <span *ngIf="task.isCompleted" class="completion-info">
                      - TerminÃ©e le {{ task.completedAt | date:'short' }}
                    </span>
                  </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content *ngIf="task.description">
                  <p>{{ task.description }}</p>
                </mat-card-content>
              </mat-card>
            </div>

            <!-- Message si pas de tÃ¢ches Ã©tudiantes -->
            <div *ngIf="studentTasks.length === 0" class="no-items">
              <mat-icon>assignment_ind</mat-icon>
              <p>L'Ã©tudiant n'a pas encore crÃ©Ã© de tÃ¢ches</p>
            </div>
          </div>

          <!-- Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸, Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ -->
          <div class="section">
            <h3>ğŸ“‹ TÃ¢ches assignÃ©es Ã  l'Ã©tudiant</h3>
            
            <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ -->
            <div class="add-form" *ngIf="showAddTaskForm">
              <mat-card>
                <mat-card-header>
                  <mat-card-title>â• Assigner une nouvelle tÃ¢che</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Titre de la tÃ¢che</mat-label>
                    <input matInput [(ngModel)]="newTaskTitle" 
                           placeholder="Ex: Analyser le poÃ¨me de Baudelaire">
                  </mat-form-field>
                  
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Description dÃ©taillÃ©e</mat-label>
                    <textarea matInput [(ngModel)]="newTaskDescription" rows="3" 
                              placeholder="Instructions dÃ©taillÃ©es pour l'Ã©tudiant..."></textarea>
                  </mat-form-field>
                </mat-card-content>
                <mat-card-actions align="end">
                  <button mat-button (click)="clearTaskForm()">Annuler</button>
                  <button mat-raised-button color="primary" (click)="addTaskForStudent()"
                          [disabled]="!newTaskTitle.trim()">
                    Assigner la tÃ¢che
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>

            <!-- Bouton Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ñ„Ğ¾Ñ€Ğ¼Ñ‹ -->
            <button *ngIf="!showAddTaskForm" mat-raised-button color="primary" 
                    (click)="showAddTaskForm = true" class="add-button">
              â• Assigner une tÃ¢che
            </button>

            <!-- Liste des tÃ¢ches assignÃ©es -->
            <div class="tasks-list">
              <mat-card *ngFor="let task of teacherTasks" class="task-card assigned-task">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>assignment</mat-icon>
                    {{ task.title }}
                  </mat-card-title>
                  <mat-card-subtitle>
                    AssignÃ©e le {{ task.createdAt | date:'short' }}
                  </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content *ngIf="task.description">
                  <p>{{ task.description }}</p>
                </mat-card-content>
              </mat-card>
            </div>

            <!-- Message si pas de tÃ¢ches assignÃ©es -->
            <div *ngIf="teacherTasks.length === 0" class="no-items">
              <mat-icon>assignment</mat-icon>
              <p>Aucune tÃ¢che assignÃ©e Ã  l'Ã©tudiant</p>
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ°: Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° -->
      <mat-tab label="â“ Questions de l'Ã©tudiant">
        <div class="tab-content">
          <!-- Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ±ĞµĞ· Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° -->
          <div class="section">
            <h3>â“ Questions en attente de rÃ©ponse</h3>
            
            <div class="questions-list">
              <mat-card *ngFor="let question of unansweredQuestions" class="question-card pending">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>help_outline</mat-icon>
                    {{ question.question }}
                  </mat-card-title>
                  <mat-card-subtitle>
                    PosÃ©e le {{ question.createdAt | date:'short' }}
                  </mat-card-subtitle>
                </mat-card-header>
                
                <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° -->
                <mat-card-content *ngIf="answeringQuestionId === question.id">
                  <div class="answer-form">
                    <mat-form-field appearance="fill" class="full-width">
                      <mat-label>Votre rÃ©ponse</mat-label>
                      <textarea matInput [(ngModel)]="answerText" rows="3" 
                                placeholder="Tapez votre rÃ©ponse dÃ©taillÃ©e..."></textarea>
                    </mat-form-field>
                    <div class="answer-actions">
                      <button mat-button (click)="cancelAnswering()">Annuler</button>
                      <button mat-raised-button color="primary" 
                              (click)="answerQuestion(question.id)"
                              [disabled]="!answerText.trim()">
                        Envoyer la rÃ©ponse
                      </button>
                    </div>
                  </div>
                </mat-card-content>
                
                <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° -->
                <mat-card-actions *ngIf="answeringQuestionId !== question.id">
                  <button mat-raised-button color="accent" 
                          (click)="startAnswering(question.id)">
                    ğŸ’¬ RÃ©pondre
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>

            <!-- Message si pas de questions en attente -->
            <div *ngIf="unansweredQuestions.length === 0" class="no-items">
              <mat-icon>quiz</mat-icon>
              <p>Aucune question en attente de rÃ©ponse</p>
            </div>
          </div>

          <!-- Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°Ğ¼Ğ¸ -->
          <div class="section">
            <h3>âœ… Questions dÃ©jÃ  rÃ©pondues</h3>
            
            <div class="questions-list">
              <mat-card *ngFor="let question of answeredQuestions" class="question-card answered">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>help</mat-icon>
                    {{ question.question }}
                  </mat-card-title>
                  <mat-card-subtitle>
                    PosÃ©e le {{ question.createdAt | date:'short' }}
                  </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                  <div class="answer">
                    <strong>Votre rÃ©ponse:</strong>
                    <p>{{ question.answer }}</p>
                    <small>RÃ©pondu le {{ question.answeredAt | date:'short' }}</small>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>

            <!-- Message si pas de questions rÃ©pondues -->
            <div *ngIf="answeredQuestions.length === 0" class="no-items">
              <mat-icon>quiz</mat-icon>
              <p>Aucune question rÃ©pondue pour ce cours</p>
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ°: ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹ -->
      <mat-tab label="ğŸ“š MatÃ©riaux du cours">
        <div class="tab-content">
          <div class="section">
            <h3>ğŸ“š Ajouter des matÃ©riaux</h3>
            
            <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ° -->
            <div class="add-form" *ngIf="showAddMaterialForm">
              <mat-card>
                <mat-card-header>
                  <mat-card-title>â• Ajouter un nouveau matÃ©riau</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Titre du matÃ©riau</mat-label>
                    <input matInput [(ngModel)]="newMaterialTitle" 
                           placeholder="Ex: Introduction Ã  la poÃ©sie franÃ§aise">
                  </mat-form-field>
                  
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Type de matÃ©riau</mat-label>
                    <mat-select [(ngModel)]="newMaterialType">
                      <mat-option value="text">ğŸ“„ Texte</mat-option>
                      <mat-option value="audio">ğŸµ Audio</mat-option>
                      <mat-option value="video">ğŸ¥ VidÃ©o</mat-option>
                    </mat-select>
                  </mat-form-field>
                  
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>
                      {{ newMaterialType === 'text' ? 'Contenu du texte' : 'URL du fichier' }}
                    </mat-label>
                    <textarea matInput [(ngModel)]="newMaterialContent" rows="4" 
                              [placeholder]="newMaterialType === 'text' ? 'Tapez le contenu...' : 'https://example.com/fichier.mp3'"></textarea>
                  </mat-form-field>
                </mat-card-content>
                <mat-card-actions align="end">
                  <button mat-button (click)="clearMaterialForm()">Annuler</button>
                  <button mat-raised-button color="primary" 
                          [disabled]="!newMaterialTitle.trim() || !newMaterialContent.trim()">
                    Ajouter le matÃ©riau
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>

            <!-- Bouton Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ñ„Ğ¾Ñ€Ğ¼Ñ‹ -->
            <button *ngIf="!showAddMaterialForm" mat-raised-button color="primary" 
                    (click)="showAddMaterialForm = true" class="add-button">
              ğŸ“š Ajouter un matÃ©riau
            </button>
            
            <!-- Message temporaire -->
            <div class="no-items">
              <mat-icon>library_books</mat-icon>
              <p>La gestion des matÃ©riaux sera implÃ©mentÃ©e prochainement</p>
            </div>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>

  <!-- Message ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ ÑƒÑ€Ğ¾ĞºĞ° -->
  <div *ngIf="!loading && !currentLesson" class="no-lesson">
    <mat-icon>school</mat-icon>
    <h3>Aucun cours sÃ©lectionnÃ©</h3>
    <p>Cliquez sur un cours dans le calendrier pour commencer Ã  gÃ©rer les tÃ¢ches et rÃ©pondre aux questions.</p>
  </div>
</div>
