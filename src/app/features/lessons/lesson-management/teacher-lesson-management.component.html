<!-- ĞĞ¡ĞĞĞ’ĞĞĞ¯ ĞŸĞĞĞ•Ğ›Ğ¬ ĞŸĞ Ğ•ĞŸĞĞ”ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯ (ĞºĞ¾Ğ³Ğ´Ğ° ĞĞ• Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğº) -->
<div class="lesson-management" *ngIf="!currentLesson">

  <!-- === FILTRES + LEÃ‡ONS === -->
  <div *ngIf="activePanel === 'cours'">

    <!-- ğŸ” Filtres -->
    <div class="filter-container mat-elevation-z1">
      <mat-button-toggle-group [(ngModel)]="filter" name="period" (change)="recalculateStatus()">
        <mat-button-toggle value="future">ğŸ“… Ã€ venir</mat-button-toggle>
        <mat-button-toggle value="past">ğŸ•“ PassÃ©s</mat-button-toggle>
        <mat-button-toggle value="all">ğŸ“š Tous</mat-button-toggle>
      </mat-button-toggle-group>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>ğŸ‘©â€ğŸ“ Ã‰tudiant</mat-label>
        <mat-select [(ngModel)]="selectedStudent">
          <mat-option value="">Tous les Ã©tudiants</mat-option>
          <mat-option *ngFor="let s of uniqueStudents" [value]="s">{{ s }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>Date de dÃ©but</mat-label>
        <input matInput type="date" [(ngModel)]="startDate">
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>Date de fin</mat-label>
        <input matInput type="date" [(ngModel)]="endDate">
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-item keyword">
        <mat-label>Mot-clÃ©</mat-label>
        <input matInput [(ngModel)]="searchTerm" placeholder="ğŸ” tÃ¢ches, textes, etc.">
      </mat-form-field>
    </div>

    <!-- ğŸ“¦ Liste des cours -->
    <div class="lesson-list">
      <app-teacher-lesson-card *ngFor="let lesson of filteredLessons" 
        [lesson]="lesson" 
        [lessonId]="lesson.id"
        [taskDropIds]="taskDropIds" 
        [resolvedItems]="resolvedItemsPerLesson[lesson.id] || []"
        (itemDropped)="onItemDropped($event)" 
        (openGabarit)="openGabarit(lesson)">
      </app-teacher-lesson-card>
      
      <div class="paginator-wrapper" *ngIf="activePanel === 'cours'">
        <mat-paginator [length]="fullFilteredLessons.length" [pageSize]="pageSize" [pageSizeOptions]="[4, 8, 12]"
          (page)="onPageChange($event)" [showFirstLastButtons]="true" aria-label="Pagination des cours">
        </mat-paginator>
      </div>

      <div *ngIf="filteredLessons.length < fullFilteredLessons.length" class="text-center mt-3">
        <button mat-stroked-button color="primary" (click)="loadMore()">Afficher plus</button>
      </div>
    </div>
  </div>

  <div *ngIf="activePanel === 'settings'" class="lesson-list p-3">
    <h3>âš™ï¸ ParamÃ¨tres</h3>
    <p class="text-muted">Zone de configuration (Ã  dÃ©finir)...</p>
  </div>

  <div *ngIf="activePanel === 'stats'" class="lesson-list p-3">
    <h3>ğŸ“ˆ Statistiques globales</h3>
    <ul class="mb-3">
      <li>Cours passÃ©s : {{ pastLessonsCount }}</li>
      <li>Cours Ã  venir : {{ futureLessonsCount }}</li>
      <li>Ã‰tudiants uniques : {{ uniqueStudents.length }}</li>
    </ul>
    <h4>ğŸ¯ Objectifs</h4>
    <p class="text-muted">DÃ©finir des objectifs Ã  long terme ici...</p>
  </div>

  <!-- â¬…ï¸ Ğ¡Ğ°Ğ¹Ğ´Ğ±Ğ°Ñ€ -->
  <div class="side-tabs-wrapper" (mouseenter)="hideTabs = false" (mouseleave)="hideTabs = true">
    <div class="side-tabs">
      <div class="tab-button" (click)="activePanel = 'cours'" [class.active]="activePanel === 'cours'" [class.expanded]="!hideTabs">
        ğŸ“‹ <span class="label" *ngIf="!hideTabs">Cours</span>
      </div>
      <div class="tab-button" (click)="activePanel = 'stats'" [class.active]="activePanel === 'stats'" [class.expanded]="!hideTabs">
        ğŸ“ˆ <span class="label" *ngIf="!hideTabs">Statistiques</span>
      </div>
      <div class="tab-button" (click)="activePanel = 'settings'" [class.active]="activePanel === 'settings'" [class.expanded]="!hideTabs">
        âš™ï¸ <span class="label" *ngIf="!hideTabs">ParamÃ¨tres</span>
      </div>
    </div>
  </div>
</div>

<!-- Ğ“Ğ°Ğ±Ğ°Ñ€Ğ¸Ñ‚ -->
<app-gabarit *ngIf="activeLesson" [lesson]="activeLesson" [visible]="true" [close]="closeGabarit.bind(this)">
</app-gabarit>

<!-- ĞĞ‘Ğ©ĞĞ¯ ĞšĞĞ Ğ¢ĞĞ§ĞšĞ Ğ£Ğ ĞĞšĞ (ĞºĞ¾Ğ³Ğ´Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğº) -->
<div class="teacher-lesson-management" *ngIf="currentLesson">
  <!-- Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Chargement du cours...</p>
  </div>

  <!-- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ -->
  <div *ngIf="!loading && currentLesson" class="lesson-details">
    <!-- En-tÃªte du cours -->
    <div class="lesson-header mat-elevation-z2">
      <div class="lesson-header-content">
        <div class="lesson-info">
          <h2>ğŸ‘¨â€ğŸ« Cours avec {{ currentLesson.studentName || 'Ã‰tudiant' }}</h2>
          <p>ğŸ“… {{ currentLesson.scheduledAt | date:'dd/MM/yyyy Ã  HH:mm' }}</p>
          <div class="status-container">
            <span class="status-label">ğŸ“Š Statut:</span>
            <span class="status-badge" [ngClass]="getStatusClass(currentLesson.status)">
              {{ getStatusText(currentLesson.status) }}
            </span>
          </div>
        </div>
        <div class="lesson-actions" *ngIf="canEnterClass(currentLesson)">
          <button mat-raised-button 
                  color="accent" 
                  (click)="enterVirtualClass(currentLesson)"
                  class="enter-class-btn large">
            ğŸ¥ Entrer en classe
          </button>
        </div>
      </div>
    </div>

    <!-- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ¸ -->
    <mat-tab-group>
      <!-- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ°: Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ -->
      <mat-tab label="ğŸ“ TÃ¢ches du cours">
        <div class="tab-content">
          <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ -->
          <div class="add-form" *ngIf="showAddTaskForm">
            <mat-card>
              <mat-card-header>
                <mat-card-title>â• Assigner une nouvelle tÃ¢che</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>Titre de la tÃ¢che</mat-label>
                  <input matInput [(ngModel)]="newTaskTitle" 
                         placeholder="Ex: Analyser le poÃ¨me de Baudelaire">
                </mat-form-field>
                
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>Description dÃ©taillÃ©e</mat-label>
                  <textarea matInput [(ngModel)]="newTaskDescription" rows="3" 
                            placeholder="Instructions dÃ©taillÃ©es pour l'Ã©tudiant..."></textarea>
                </mat-form-field>
              </mat-card-content>
              <mat-card-actions align="end">
                <button mat-button (click)="clearTaskForm()">Annuler</button>
                <button mat-raised-button color="primary" (click)="addTaskForStudent()"
                        [disabled]="!newTaskTitle.trim()">
                  Assigner la tÃ¢che
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <!-- Bouton Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ -->
          <button *ngIf="!showAddTaskForm" mat-raised-button color="primary" 
                  (click)="showAddTaskForm = true" class="add-button">
            â• Assigner une tÃ¢che
          </button>

          <!-- Liste unifiÃ©e des tÃ¢ches -->
          <div class="tasks-list">
            <mat-card *ngFor="let task of currentLesson.tasks; let i = index" 
                      class="task-card" 
                      [class.completed]="task.isCompleted"
                      [class.student-task]="task.createdByRole === 'student'"
                      [class.teacher-task]="task.createdByRole === 'teacher'">
              <mat-card-header>
                <mat-card-title>
                  <div class="task-header">
                    <span class="task-number">{{ i + 1 }}.</span>
                    <mat-icon class="role-icon" [class.student-icon]="task.createdByRole === 'student'" 
                              [class.teacher-icon]="task.createdByRole === 'teacher'">
                      {{ task.createdByRole === 'student' ? 'person' : 'school' }}
                    </mat-icon>
                    <span class="task-title">{{ task.title }}</span>
                    <mat-icon class="status-icon" *ngIf="task.isCompleted">check_circle</mat-icon>
                    <mat-icon class="status-icon" *ngIf="!task.isCompleted">radio_button_unchecked</mat-icon>
                  </div>
                </mat-card-title>
                <mat-card-subtitle>
                  <span class="author-badge" [class.student-badge]="task.createdByRole === 'student'"
                        [class.teacher-badge]="task.createdByRole === 'teacher'">
                    {{ task.createdByRole === 'student' ? 'ğŸ‘¨â€ğŸ“ Ã‰tudiant' : 'ğŸ‘¨â€ğŸ« Professeur' }}
                  </span>
                  <span class="date">{{ task.createdAt | date:'dd/MM/yyyy Ã  HH:mm' }}</span>
                  <span *ngIf="task.isCompleted" class="completion-info">
                    - âœ… TerminÃ©e le {{ task.completedAt | date:'dd/MM/yyyy Ã  HH:mm' }}
                  </span>
                </mat-card-subtitle>
              </mat-card-header>
              <mat-card-content *ngIf="task.description">
                <p>{{ task.description }}</p>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Message si pas de tÃ¢ches -->
          <div *ngIf="currentLesson.tasks.length === 0" class="no-items">
            <mat-icon>assignment</mat-icon>
            <p>Aucune tÃ¢che pour ce cours</p>
          </div>
        </div>
      </mat-tab>

      <!-- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ°: Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ -->
      <mat-tab label="â“ Questions du cours">
        <div class="tab-content">
          <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° -->
          <div class="add-form" *ngIf="showAddQuestionForm">
            <mat-card>
              <mat-card-header>
                <mat-card-title>â• Poser une question Ã  l'Ã©tudiant</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>Votre question</mat-label>
                  <textarea matInput [(ngModel)]="newQuestionText" rows="3" 
                            placeholder="Ex: Avez-vous compris la diffÃ©rence entre...?"></textarea>
                </mat-form-field>
              </mat-card-content>
              <mat-card-actions align="end">
                <button mat-button (click)="clearQuestionForm()">Annuler</button>
                <button mat-raised-button color="primary" (click)="addQuestionToStudent()"
                        [disabled]="!newQuestionText.trim()">
                  Poser la question
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <!-- Bouton Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ -->
          <button *ngIf="!showAddQuestionForm" mat-raised-button color="primary" 
                  (click)="showAddQuestionForm = true" class="add-button">
            â“ Poser une question
          </button>

          <!-- Liste unifiÃ©e des questions -->
          <div class="questions-list">
            <mat-card *ngFor="let question of currentLesson.questions; let i = index" 
                      class="question-card"
                      [class.answered]="question.isAnswered"
                      [class.student-question]="question.createdByRole === 'student'"
                      [class.teacher-question]="question.createdByRole === 'teacher'">
              <mat-card-header>
                <mat-card-title>
                  <div class="question-header">
                    <span class="question-number">{{ i + 1 }}.</span>
                    <mat-icon class="role-icon" [class.student-icon]="question.createdByRole === 'student'" 
                              [class.teacher-icon]="question.createdByRole === 'teacher'">
                      {{ question.createdByRole === 'student' ? 'person' : 'school' }}
                    </mat-icon>
                    <span class="question-text">{{ question.question }}</span>
                    <mat-icon class="status-icon" *ngIf="question.isAnswered">help</mat-icon>
                    <mat-icon class="status-icon" *ngIf="!question.isAnswered">help_outline</mat-icon>
                  </div>
                </mat-card-title>
                <mat-card-subtitle>
                  <span class="author-badge" [class.student-badge]="question.createdByRole === 'student'"
                        [class.teacher-badge]="question.createdByRole === 'teacher'">
                    {{ question.createdByRole === 'student' ? 'ğŸ‘¨â€ğŸ“ Ã‰tudiant' : 'ğŸ‘¨â€ğŸ« Professeur' }}
                  </span>
                  <span class="date">{{ question.createdAt | date:'dd/MM/yyyy Ã  HH:mm' }}</span>
                </mat-card-subtitle>
              </mat-card-header>
              
              <!-- ĞÑ‚Ğ²ĞµÑ‚, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ -->
              <mat-card-content *ngIf="question.isAnswered && question.answer">
                <div class="answer">
                  <strong>ğŸ’¬ RÃ©ponse:</strong>
                  <p>{{ question.answer }}</p>
                  <small>RÃ©pondu le {{ question.answeredAt | date:'dd/MM/yyyy Ã  HH:mm' }}</small>
                </div>
              </mat-card-content>

              <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² Ğ±ĞµĞ· Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°) -->
              <mat-card-content *ngIf="!question.isAnswered && question.createdByRole === 'student' && answeringQuestionId === question.id">
                <div class="answer-form">
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Votre rÃ©ponse</mat-label>
                    <textarea matInput [(ngModel)]="answerText" rows="3" 
                              placeholder="Tapez votre rÃ©ponse dÃ©taillÃ©e..."></textarea>
                  </mat-form-field>
                  <div class="answer-actions">
                    <button mat-button (click)="cancelAnswering()">Annuler</button>
                    <button mat-raised-button color="primary" 
                            (click)="answerQuestion(question.id)"
                            [disabled]="!answerText.trim()">
                      Envoyer la rÃ©ponse
                    </button>
                  </div>
                </div>
              </mat-card-content>

              <!-- Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ´Ğ»Ñ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ±ĞµĞ· Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° -->
              <mat-card-content *ngIf="!question.isAnswered && answeringQuestionId !== question.id">
                <p class="waiting-answer" *ngIf="question.createdByRole === 'teacher'">
                  â³ En attente de rÃ©ponse de l'Ã©tudiant...
                </p>
                <p class="waiting-answer" *ngIf="question.createdByRole === 'student'">
                  â³ En attente de votre rÃ©ponse...
                </p>
              </mat-card-content>
              
              <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² Ğ±ĞµĞ· Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°) -->
              <mat-card-actions *ngIf="!question.isAnswered && question.createdByRole === 'student' && answeringQuestionId !== question.id">
                <button mat-raised-button color="accent" 
                        (click)="startAnswering(question.id)">
                  ğŸ’¬ RÃ©pondre
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <!-- Message si pas de questions -->
          <div *ngIf="currentLesson.questions.length === 0" class="no-items">
            <mat-icon>quiz</mat-icon>
            <p>Aucune question pour ce cours</p>
          </div>
        </div>
      </mat-tab>

      <!-- Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ°: ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹ -->
      <mat-tab label="ğŸ“š MatÃ©riaux du cours">
        <div class="tab-content">
          <div class="section">
            <h3>ğŸ“š Ajouter des matÃ©riaux</h3>
            
            <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ° -->
            <div class="add-form" *ngIf="showAddMaterialForm">
              <mat-card>
                <mat-card-header>
                  <mat-card-title>â• Ajouter un nouveau matÃ©riau</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Titre du matÃ©riau</mat-label>
                    <input matInput [(ngModel)]="newMaterialTitle" 
                           placeholder="Ex: Introduction Ã  la poÃ©sie franÃ§aise">
                  </mat-form-field>
                  
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Type de matÃ©riau</mat-label>
                    <mat-select [(ngModel)]="newMaterialType">
                      <mat-option value="text">ğŸ“„ Texte</mat-option>
                      <mat-option value="audio">ğŸµ Audio</mat-option>
                      <mat-option value="video">ğŸ¥ VidÃ©o</mat-option>
                    </mat-select>
                  </mat-form-field>
                  
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>
                      {{ newMaterialType === 'text' ? 'Contenu du texte' : 'URL du fichier' }}
                    </mat-label>
                    <textarea matInput [(ngModel)]="newMaterialContent" rows="4" 
                              [placeholder]="newMaterialType === 'text' ? 'Tapez le contenu...' : 'https://example.com/fichier.mp3'"></textarea>
                  </mat-form-field>
                </mat-card-content>
                <mat-card-actions align="end">
                  <button mat-button (click)="clearMaterialForm()">Annuler</button>
                  <button mat-raised-button color="primary" 
                          [disabled]="!newMaterialTitle.trim() || !newMaterialContent.trim()">
                    Ajouter le matÃ©riau
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>

            <!-- Bouton Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ñ„Ğ¾Ñ€Ğ¼Ñ‹ -->
            <button *ngIf="!showAddMaterialForm" mat-raised-button color="primary" 
                    (click)="showAddMaterialForm = true" class="add-button">
              ğŸ“š Ajouter un matÃ©riau
            </button>
            
            <!-- Message temporaire -->
            <div class="no-items">
              <mat-icon>library_books</mat-icon>
              <p>La gestion des matÃ©riaux sera implÃ©mentÃ©e prochainement</p>
            </div>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>

  <!-- Message ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ ÑƒÑ€Ğ¾ĞºĞ° -->
  <div *ngIf="!loading && !currentLesson" class="no-lesson">
    <mat-icon>school</mat-icon>
    <h3>Aucun cours sÃ©lectionnÃ©</h3>
    <p>Cliquez sur un cours dans le calendrier pour commencer Ã  gÃ©rer les tÃ¢ches et rÃ©pondre aux questions.</p>
  </div>
</div>
