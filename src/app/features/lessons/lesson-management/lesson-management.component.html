<div class="lesson-management">
  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–∞...</p>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <div *ngIf="!loading && currentLesson" class="lesson-details">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–∫–∞ -->
    <div class="lesson-header mat-elevation-z2">
      <h2>üìö –£—Ä–æ–∫ —Å {{ currentLesson.teacherName || '–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º' }}</h2>
      <p>üìÖ {{ currentLesson.scheduledAt | date:'short' }}</p>
      <p>üìä –°—Ç–∞—Ç—É—Å: {{ currentLesson.status }}</p>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <mat-tab-group>
      <!-- –í–∫–ª–∞–¥–∫–∞: –ó–∞–¥–∞—á–∏ -->
      <mat-tab label="üìù Mes t√¢ches">
        <div class="tab-content">
          <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
          <div class="add-form" *ngIf="showAddTaskForm">
            <mat-card>
              <mat-card-header>
                <mat-card-title>‚ûï Ajouter une nouvelle t√¢che</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>Titre de la t√¢che</mat-label>
                  <input matInput [(ngModel)]="newTaskTitle" placeholder="Ex: Analyser un po√®me">
                </mat-form-field>
                
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>Description (optionnel)</mat-label>
                  <textarea matInput [(ngModel)]="newTaskDescription" rows="3" 
                            placeholder="D√©tails de la t√¢che..."></textarea>
                </mat-form-field>
              </mat-card-content>
              <mat-card-actions align="end">
                <button mat-button (click)="clearTaskForm()">Annuler</button>
                <button mat-raised-button color="primary" (click)="addTask()"
                        [disabled]="!newTaskTitle.trim()">
                  Ajouter
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <!-- Bouton –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ä–º—ã -->
          <button *ngIf="!showAddTaskForm" mat-raised-button color="primary" 
                  (click)="showAddTaskForm = true" class="add-button">
            ‚ûï Ajouter une t√¢che
          </button>

          <!-- Liste des t√¢ches -->
          <div class="tasks-list">
            <mat-card *ngFor="let task of currentLesson.tasks" class="task-card" 
                      [class.completed]="task.isCompleted">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon *ngIf="task.isCompleted">check_circle</mat-icon>
                  <mat-icon *ngIf="!task.isCompleted">radio_button_unchecked</mat-icon>
                  {{ task.title }}
                </mat-card-title>
                <mat-card-subtitle>
                  Par {{ task.createdByRole === 'student' ? 'moi' : 'le professeur' }} 
                  le {{ task.createdAt | date:'short' }}
                </mat-card-subtitle>
              </mat-card-header>
              <mat-card-content *ngIf="task.description">
                <p>{{ task.description }}</p>
              </mat-card-content>
              <mat-card-actions *ngIf="!task.isCompleted && task.createdByRole === 'student'">
                <button mat-raised-button color="accent" (click)="completeTask(task.id)">
                  ‚úÖ Marquer comme termin√©
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <!-- Message si pas de t√¢ches -->
          <div *ngIf="currentLesson.tasks.length === 0" class="no-items">
            <mat-icon>assignment</mat-icon>
            <p>Aucune t√¢che pour ce cours</p>
          </div>
        </div>
      </mat-tab>

      <!-- Vk–ª–∞–¥–∫–∞: –í–æ–ø—Ä–æ—Å—ã -->
      <mat-tab label="‚ùì Mes questions">
        <div class="tab-content">
          <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞ -->
          <div class="add-form" *ngIf="showAddQuestionForm">
            <mat-card>
              <mat-card-header>
                <mat-card-title>‚ûï Poser une nouvelle question</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-form-field appearance="fill" class="full-width">
                  <mat-label>Votre question</mat-label>
                  <textarea matInput [(ngModel)]="newQuestionText" rows="3" 
                            placeholder="Ex: Comment utilise-t-on le subjonctif ?"></textarea>
                </mat-form-field>
              </mat-card-content>
              <mat-card-actions align="end">
                <button mat-button (click)="clearQuestionForm()">Annuler</button>
                <button mat-raised-button color="primary" (click)="addQuestion()"
                        [disabled]="!newQuestionText.trim()">
                  Poser la question
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <!-- Bouton –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ä–º—ã -->
          <button *ngIf="!showAddQuestionForm" mat-raised-button color="primary" 
                  (click)="showAddQuestionForm = true" class="add-button">
            ‚ùì Poser une question
          </button>

          <!-- –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ -->
          <div class="questions-list">
            <mat-card *ngFor="let question of currentLesson.questions" class="question-card"
                      [class.answered]="question.isAnswered">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon *ngIf="question.isAnswered">help</mat-icon>
                  <mat-icon *ngIf="!question.isAnswered">help_outline</mat-icon>
                  {{ question.question }}
                </mat-card-title>
                <mat-card-subtitle>
                  Par {{ question.createdByRole === 'student' ? 'moi' : 'le professeur' }} 
                  le {{ question.createdAt | date:'short' }}
                </mat-card-subtitle>
              </mat-card-header>
              <mat-card-content *ngIf="question.isAnswered && question.answer">
                <div class="answer">
                  <strong>R√©ponse:</strong>
                  <p>{{ question.answer }}</p>
                  <small>R√©pondu le {{ question.answeredAt | date:'short' }}</small>
                </div>
              </mat-card-content>
              <mat-card-content *ngIf="!question.isAnswered">
                <p class="waiting-answer">En attente de r√©ponse du professeur...</p>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Message si –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ -->
          <div *ngIf="currentLesson.questions.length === 0" class="no-items">
            <mat-icon>quiz</mat-icon>
            <p>Aucune question pour ce cours</p>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>

  <!-- Message –µ—Å–ª–∏ –Ω–µ—Ç —É—Ä–æ–∫–∞ -->
  <div *ngIf="!loading && !currentLesson" class="no-lesson">
    <mat-icon>school</mat-icon>
    <h3>Aucun cours s√©lectionn√©</h3>
    <p>Cliquez sur un cours dans le calendrier pour commencer √† ajouter des t√¢ches et des questions.</p>
  </div>

  <div *ngIf="activePanel === 'cours'">
    <!-- üìö Filtres √©l√©gants -->
    <div class="filter-container mat-elevation-z1">

      <!-- üß≠ P√©riode -->
      <mat-button-toggle-group [(ngModel)]="filter" name="period" (change)="recalculateStatus()">

        <mat-button-toggle value="future">üìÖ √Ä venir</mat-button-toggle>
        <mat-button-toggle value="past">üïì Pass√©s</mat-button-toggle>
        <mat-button-toggle value="all">üìö Tous</mat-button-toggle>
      </mat-button-toggle-group>
      <!-- üë®‚Äçüè´ Enseignant -->
      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>Enseignant</mat-label>
        <mat-select [(ngModel)]="selectedTeacher">
          <mat-option value="">Tous</mat-option>
          <mat-option *ngFor="let t of ['Marie', 'Paul', 'Claire']" [value]="t">{{ t }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- üìÖ Date d√©but -->
      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>Date de d√©but</mat-label>
        <input matInput type="date" [(ngModel)]="startDate">
      </mat-form-field>

      <!-- üìÖ Date fin -->
      <mat-form-field appearance="fill" class="filter-item">
        <mat-label>Date de fin</mat-label>
        <input matInput type="date" [(ngModel)]="endDate">
      </mat-form-field>

      <!-- üîç Mot-cl√© -->
      <mat-form-field appearance="fill" class="filter-item keyword">
        <mat-label>Mot-cl√© dans t√¢ches ou questions</mat-label>
        <input matInput [(ngModel)]="searchTerm" placeholder="üîç Synth√®se, discours, etc.">
      </mat-form-field>

    </div>

    <!-- üì¶ Liste des cours -->
    <div class="lesson-list">
      <app-lesson-card *ngFor="let lesson of filteredLessons" [lesson]="lesson" [lessonId]="lesson.id"
        [taskDropIds]="taskDropListIds" [questionDropIds]="questionDropListIds"
        [resolvedItems]="resolvedItemsPerLesson[lesson.id] || []" (itemDropped)="onItemDropped($event)"
        (moveToFuture)="onMoveToFuture($event)">
      </app-lesson-card>
      <div class="paginator-wrapper" *ngIf="activePanel === 'cours'">
        <mat-paginator [length]="fullFilteredLessons.length" [pageSize]="pageSize" [pageSizeOptions]="[4, 8, 12]"
          (page)="onPageChange($event)" [showFirstLastButtons]="true" aria-label="Pagination des cours">
        </mat-paginator>
      </div>
    </div>

  </div>

  <div *ngIf="activePanel === 'stats'" class="lesson-list p-4">
    <h4>üìä Statistiques</h4>
    <ul>
      <li>Cours pass√©s : {{ stats.pastCount }}</li>
      <li>Cours √† venir : {{ stats.futureCount }}</li>
      <li>T√¢ches totales : {{ stats.totalTasks }}</li>
      <li>Questions totales : {{ stats.totalQuestions }}</li>
    </ul>

    <h4 class="mt-3">üéØ Objectifs</h4>
    <p class="text-muted">D√©finir ses objectifs d'apprentissage √† long terme ici‚Ä¶</p>
  </div>

  <!-- üìé Side Tabs -->
  <div class="side-tabs-wrapper" (mouseleave)="hideTabs = true" (mouseenter)="hideTabs = false">
    <div class="side-tabs-wrapper">
      <div class="side-tabs">
        <div class="tab-button" (click)="activePanel = 'cours'" [class.active]="activePanel === 'cours'">
          üìã <span class="label">Cours</span>
        </div>
        <div class="tab-button" (click)="activePanel = 'settings'" [class.active]="activePanel === 'settings'">
          ‚öôÔ∏è <span class="label">Param√®tres</span>
        </div>
        <div class="tab-button" (click)="activePanel = 'stats'" [class.active]="activePanel === 'stats'">
          üìä <span class="label">Statistiques</span>
        </div>

      </div>
    </div>
  </div>


</div>
