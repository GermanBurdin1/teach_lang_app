<div class="vocabulary-container">
  <h1>{{ currentSubtopic }}
  </h1>



  <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ -->
  <div *ngIf="showInputFields" class="input-fields">
    <input [(ngModel)]="newWord" placeholder="–í–≤–µ–¥–∏—Ç–µ {{ newWordType === 'word' ? '—Å–ª–æ–≤–æ' : '–≤—ã—Ä–∞–∂–µ–Ω–∏–µ' }}" />
    <input [(ngModel)]="newTranslation" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
    <button (click)="addItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>


  <div class="view-sort-toggle">
    <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</label>
    <select [(ngModel)]="sortBy" (change)="sortWords()">
      <option value="all"><i class="fas fa-layer-group"></i> –í—Å–µ</option>
      <option value="repeat"><i class="fas fa-sync-alt"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</option>
      <option value="learned"><i class="fas fa-check-circle"></i> –í—ã—É—á–µ–Ω–Ω—ã–µ</option>
      <option value="untranslated"><i class="fas fa-question-circle"></i> –ë–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞</option>
      <option value="hardest"><i class="fas fa-fire"></i> –û—à–∏–±–∫–∏</option>
    </select>

    <!-- Toggle-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
    <div class="view-toggle-switch">
      <button (click)="viewMode = 'cards'" [class.active]="viewMode === 'cards'" aria-label="–ö–∞—Ä—Ç–æ—á–∫–∏">
        üìá
      </button>
      <button (click)="viewMode = 'list'" [class.active]="viewMode === 'list'" aria-label="–°–ø–∏—Å–∫–æ–º">
        üìã
      </button>
    </div>
  </div>


  <!-- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ª–æ–≤/–≤—ã—Ä–∞–∂–µ–Ω–∏–π -->
  <div class="filter-toggle">
    <button (click)="filterType = 'all'" [class.active]="filterType === 'all'">–í—Å–µ</button>
    <button (click)="filterType = 'word'" [class.active]="filterType === 'word'">–¢–æ–ª—å–∫–æ —Å–ª–æ–≤–∞</button>
    <button (click)="filterType = 'expression'" [class.active]="filterType === 'expression'">–¢–æ–ª—å–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è</button>
  </div>

  <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ -->
  <div class="cards-container" [ngClass]="{
    'single-column': filterType !== 'all',
    'two-columns': filterType === 'all'
  }">
    <!-- –ö–æ–ª–æ–Ω–∫–∞ –¥–ª—è —Å–ª–æ–≤ -->
    <div class="column" *ngIf="filterType === 'all' || filterType === 'word'">
      <div class="controls-row">
        <button class="add-icon-btn" (click)="openAddCardModal('word')" title="–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ">
          <i class="fas fa-plus"></i>
        </button>
        <button class="sort-toggle-btn" (click)="toggleSortOrderWords()"
          title="–°–Ω–∞—á–∞–ª–∞ {{ sortOrderWords === 'desc' ? '–Ω–æ–≤—ã–µ' : '—Å—Ç–∞—Ä—ã–µ' }}">
          <i class="fas" [ngClass]="sortOrderWords === 'desc' ? 'fa-arrow-down' : 'fa-arrow-up'"></i>
        </button>

      </div>

      <h3>
        <div class="pagination-info">
          {{ wordsRangeLabel }}
        </div>
      </h3>
      <ng-container *ngIf="viewMode === 'cards'; else wordList">
        <div *ngFor="let card of paginatedWords" class="card-wrapper" [ngClass]="{
          'card-wrapper--repeat': sortBy === 'repeat' && card.status === 'repeat',
          'card-wrapper--learned': sortBy === 'learned' && card.status === 'learned',
          'card-wrapper--untranslated': sortBy === 'untranslated' && (!card.translations[0] || card.translations[0].target === '...'),
          'card-wrapper--enlarged': enlargedCardId === card.id

        }">
          <div class="card">
            <div class="card-inner" [class.flipped]="card.flipped">
              <div class="card-front" [ngClass]="{
                'card-front--repeat': card.status === 'repeat',
                'card-front--learned': card.status === 'learned',
                'card-front--untranslated': !card.translations[0] || card.translations[0].target === '...'
              }">
                <div class="card-icon" *ngIf="sortBy === 'repeat' && card.status === 'repeat'">
                  <i class="fas fa-sync-alt" title="–ù–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ"></i>
                </div>
                <div class="card-icon" *ngIf="sortBy === 'learned' && card.status === 'learned'">
                  <i class="fas fa-check-circle" title="–ò–∑—É—á–µ–Ω–æ"></i>
                </div>
                <div class="card-icon"
                  *ngIf="sortBy === 'untranslated' && (!card.translations[0] || card.translations[0].target === '...')">
                  <i class="fas fa-question-circle" title="–ù–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞"></i>
                </div>
                <div class="card-header">
                  <p class="date-label">
                    üìÖ {{ card.createdAt | date:'dd/MM/yyyy' }}
                  </p>
                  <button class="delete-btn" (click)="deleteItem(card.id, 'word'); $event.stopPropagation()">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
                <div class="card-body">
                  <p>{{ card.word }}</p>
                  <span *ngIf="card.hintVisible">
                    <span *ngIf="card.translations[0].target === '...' || !card.translations[0]"
                      class="hint untranslated" (click)="openTranslationForm(card, true)">
                      –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥
                    </span>
                    <span *ngIf="card.translations[0] && card.translations[0].target !== '...'" class="hint">
                      –ö–ª–∏–∫–Ω–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–µ—Ä–µ–≤–æ–¥
                    </span>
                  </span>
                </div>
                <button class="flip-btn" (click)="flipCard(card); $event.stopPropagation()">
                  <i class="fas fa-retweet"></i> <!-- –∏–ª–∏ –¥—Ä—É–≥–∞—è –∏–∫–æ–Ω–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä fa-rotate -->
                </button>
              </div>
              <div class="card-back">
                <div class="btn-group" *ngIf="!card.isCorrect && !card.showTranslation">
                  <button
                    *ngIf="card.translations[0] && !card.showTranslation && (card.hintIndex ?? 0) < card.translations[0].target.length - 1"
                    (click)="revealNextHint(card)">
                    {{ card.hintIndex ? '–ï—â—ë –ø–æ–¥—Å–∫–∞–∑–∫—É' : '–ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É' }}
                  </button>


                  <button *ngIf="!card.showTranslation" (click)="showFullTranslation(card)">
                    –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–≤–æ
                  </button>
                  <input [(ngModel)]="card.userInput" (keyup.enter)="checkTranslation(card)" placeholder="–í–≤–µ–¥–∏ –ø–µ—Ä–µ–≤–æ–¥"
                    class="input-field" />
                </div>

                <div *ngIf="(card.isCorrect === true || card.showTranslation) && !card.status" class="after-guess-btns">
                  <button (click)="markAsLearned(card)">–Ø –∑–Ω–∞—é —ç—Ç–æ —Å–ª–æ–≤–æ</button>
                  <button (click)="markForRepetition(card)">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∑–∂–µ</button>
                </div>
                <div *ngIf="card.status === 'learned'" class="after-guess-btns">
                  <button (click)="resetToPractice(card)">–°–Ω–æ–≤–∞ —Å–ø—Ä—è—Ç–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
                </div>


                <div class="card-show-translation" *ngIf="card.showTranslation">

                  <div class="translation-entry" *ngFor="let t of card.translations; let i = index">
                    <p>{{ t.target }}</p>
                    <button class="translation-entry__more-button"
                      (click)="toggleEnlargedCard(card, i); $event.stopPropagation()">
                      {{ enlargedCardId === card.id ? '‚Ü© –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º' : '–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ' }}
                    </button>

                  </div>

                </div>

                <div *ngIf="enlargedCardId === card.id" class="card-actions-bottom">
                  <button (click)="openExampleModal(); $event.stopPropagation()">‚ûï –ü—Ä–∏–º–µ—Ä</button>
                  <button (click)="openExtraTranslationModal(); $event.stopPropagation()">‚ûï –ü–µ—Ä–µ–≤–æ–¥</button>
                  <button (click)="viewExamples(); $event.stopPropagation()">üëÅ –ü—Ä–∏–º–µ—Ä—ã</button>
                  <button (click)="viewTranslations(); $event.stopPropagation()">üëÅ –ü–µ—Ä–µ–≤–æ–¥—ã</button>
                  <button (click)="closeEnlargedCard(); $event.stopPropagation()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
                </div>

                <p *ngIf="!card.showTranslation && (card.hintIndex ?? 0) > 0" class="hint-display">
                  {{ getHint(card) }}
                </p>

                <span *ngIf="card.isCorrect === true" class="correct">‚úîÔ∏è</span>
                <span *ngIf="card.isCorrect === false" class="wrong">‚ùå</span>

                <button class="flip-btn" (click)="flipCard(card); $event.stopPropagation()">
                  <i class="fas fa-retweet"></i>
                </button>
              </div>


            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #wordList>
        <ul class="word-list">
          <li *ngFor="let word of paginatedWords">
            <strong>{{ word.word }}</strong> ‚Üí {{ word.translations[0] || '...' }}
          </li>
        </ul>
      </ng-template>

      <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è —Å–ª–æ–≤ -->
      <div class="pagination-controls">
        <button (click)="changeWordsPage(-1)" [disabled]="!hasPrevWordsPage">‚¨Ö</button>
        <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ currentWordsPage }}</span>
        <button (click)="changeWordsPage(1)" [disabled]="!hasNextWordsPage">‚û°</button>
      </div>

    </div>
    <!-- –ö–æ–ª–æ–Ω–∫–∞ –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏–π -->
    <div class="column" *ngIf="filterType === 'all' || filterType === 'expression'">
      <div class="controls-row">
        <button class="add-icon-btn" (click)="openAddCardModal('expression')" title="–î–æ–±–∞–≤–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ"
          aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ">
          <i class="fas fa-plus"></i>
        </button>
        <button class="sort-toggle-btn" (click)="toggleSortOrderExpressions()"
          title="–°–Ω–∞—á–∞–ª–∞ {{ sortOrderExpressions === 'desc' ? '–Ω–æ–≤—ã–µ' : '—Å—Ç–∞—Ä—ã–µ' }}">
          <i class="fas" [ngClass]="sortOrderExpressions === 'desc' ? 'fa-arrow-down' : 'fa-arrow-up'"></i>
        </button>

      </div>
      <h3>
        <div class="pagination-info">
          {{ expressionsPaginationLabel }}
        </div>
      </h3>
      <ng-container *ngIf="viewMode === 'cards'; else expressionList">
        <div *ngFor="let card of paginatedExpressions" class="card-wrapper" [ngClass]="{
          'card-wrapper--repeat': sortBy === 'repeat' && card.status === 'repeat',
          'card-wrapper--learned': sortBy === 'learned' && card.status === 'learned',
          'card-wrapper--untranslated': sortBy === 'untranslated' && (!card.translations[0] || card.translations[0].target === '...')
        }">
          <div class="card">
            <div class="card-inner" [class.flipped]="card.flipped">
              <div class="card-front" [ngClass]="{
                'card-front--repeat': card.status === 'repeat',
                'card-front--learned': card.status === 'learned',
                'card-front--untranslated': !card.translations[0] || card.translations[0].target === '...'
              }">
                <div class="card-header">
                  <p class="date-label">
                    üìÖ {{ card.createdAt | date:'dd/MM/yyyy' }}
                  </p>
                  <button class="delete-btn" (click)="deleteItem(card.id, 'expression'); $event.stopPropagation()">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
                <div class="card-body">
                  <p>{{ card.word }}</p>
                  <span *ngIf="card.hintVisible" class="hint">–ö–ª–∏–∫–Ω–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–µ—Ä–µ–≤–æ–¥</span>
                </div>
                <button class="flip-btn" (click)="flipCard(card); $event.stopPropagation()">
                  <i class="fas fa-retweet"></i>
                </button>
              </div>
              <div class="card-back">
                <div class="btn-group" *ngIf="!card.isCorrect && !card.showTranslation">
                  <button *ngIf="!card.showTranslation && (card.hintIndex ?? 0) < card.translations.length - 1"
                    (click)="revealNextHint(card)">
                    {{ card.hintIndex ? '–ï—â—ë –ø–æ–¥—Å–∫–∞–∑–∫—É' : '–ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É' }}
                  </button>

                  <button *ngIf="!card.showTranslation" (click)="showFullTranslation(card)">
                    –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–≤–æ
                  </button>
                  <input [(ngModel)]="card.userInput" (keyup.enter)="checkTranslation(card)" placeholder="–í–≤–µ–¥–∏ –ø–µ—Ä–µ–≤–æ–¥"
                    class="input-field" />
                </div>

                <div *ngIf="(card.isCorrect === true || card.showTranslation) && !card.status" class="after-guess-btns">
                  <button (click)="markAsLearned(card)">–Ø –∑–Ω–∞—é —ç—Ç–æ —Å–ª–æ–≤–æ</button>
                  <button (click)="markForRepetition(card)">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∑–∂–µ</button>
                </div>

                <div *ngIf="card.showTranslation">
                  <div *ngFor="let t of card.translations; let i = index">
                    <p>{{ t.target }}</p>
                    <button class="translation-entry__more-button"
                      (click)="toggleEnlargedCard(card, i); $event.stopPropagation()">
                      {{ enlargedCardId === card.id ? '‚Ü© –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º' : '–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ' }}
                    </button>
                  </div>
                </div>
                <p *ngIf="!card.showTranslation && (card.hintIndex ?? 0) > 0" class="hint-display">
                  {{ getHint(card) }}
                </p>

                <span *ngIf="card.isCorrect === true" class="correct">‚úîÔ∏è</span>
                <span *ngIf="card.isCorrect === false" class="wrong">‚ùå</span>

                <button class="flip-btn" (click)="flipCard(card); $event.stopPropagation()">
                  <i class="fas fa-retweet"></i>
                </button>
              </div>


            </div>
          </div>

        </div>
      </ng-container>

      <ng-template #expressionList>
        <ul class="word-list">
          <li *ngFor="let expr of paginatedExpressions">
            <strong>{{ expr.word }}</strong> ‚Üí {{ expr.translations }}
          </li>
        </ul>
      </ng-template>

      <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏–π -->
      <div class="pagination-controls">
        <button (click)="changeExpressionsPage(-1)" [disabled]="!hasPrevExpressionsPage">‚¨Ö</button>
        <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ currentExpressionsPage }}</span>
        <button (click)="changeExpressionsPage(1)" [disabled]="!hasNextExpressionsPage">‚û°</button>
      </div>


    </div>
  </div>

</div>

<div class="modal-overlay" *ngIf="showAddCardModal">
  <div class="modal card">
    <div class="card-inner no-flip">
      <button class="add-entry-modal__close-btn" (click)="closeAddCardModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <i class="fas fa-times"></i>
      </button>
      <div class="card-front modal-content">
        <h2 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å {{ newWordType === 'word' ? '—Å–ª–æ–≤–æ' : '–≤—ã—Ä–∞–∂–µ–Ω–∏–µ' }}</h2>

        <input [(ngModel)]="newWord" placeholder="–í–≤–µ–¥–∏—Ç–µ {{ newWordType === 'word' ? '—Å–ª–æ–≤–æ' : '–≤—ã—Ä–∞–∂–µ–Ω–∏–µ' }}" />
        <button *ngIf="!isManualTranslation" (click)="requestTranslation()" class="generate-button">
          üåê –ù–∞–π—Ç–∏ –ø–µ—Ä–µ–≤–æ–¥
        </button>
        <input *ngIf="!isAutoTranslation" [(ngModel)]="newTranslation" (input)="onManualTranslationInput()"
          placeholder="–∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ —Å–∞–º–∏" />
        <div class="lang-selectors">
          <label>–° —è–∑—ã–∫–∞:
            <select [(ngModel)]="sourceLang">
              <option value="ru">—Ä—É—Å—Å–∫–∏–π</option>
              <option value="fr">—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
              <option value="en">–∞–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
            </select>
          </label>
          <label>–ù–∞ —è–∑—ã–∫:
            <select [(ngModel)]="targetLang">
              <option value="ru">—Ä—É—Å—Å–∫–∏–π</option>
              <option value="fr">—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
              <option value="en">–∞–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
            </select>
          </label>
        </div>

        <div class="modal-actions">
          <button (click)="addItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="cancel-btn" (click)="closeAddCardModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- –ú–æ–¥–∞–ª–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –¥–ª—è –Ω–µ–ø–µ—Ä–µ–≤–µ–¥—ë–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ -->
<div class="translation-modal-overlay"
  *ngIf="editingCard && manualTranslation !== '' && !showExtraModal && !showExtraTranslationModal">
  <div class="translation-modal">
    <button class="close-btn" (click)="cancelTranslationEdit()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
      <i class="fas fa-times"></i>
    </button>
    <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</h2>
    <p><strong>{{ editingCard.word }}</strong></p>
    <div class="input-group">
      <input [(ngModel)]="manualTranslation" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –≤—Ä—É—á–Ω—É—é" />
    </div>

    <div class="modal-actions">
      <button (click)="saveManualTranslation()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button (click)="requestTranslation(editingCard)">üåê –ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
      <button (click)="cancelTranslationEdit()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<div *ngIf="showExtraModal" class="translation-modal">
  <h3 class="translation-modal__title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä</h3>

  <input class="translation-modal__input" [(ngModel)]="newExample" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä" />

  <div class="translation-modal__button-group">
    <button class="translation-modal__button" (click)="addExample()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <button class="translation-modal__button" (click)="closeExtraModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

  <ul *ngIf="selectedTranslation" class="translation-modal__examples">
    <li *ngFor="let e of selectedTranslation.examples || []">{{ e }}</li>
  </ul>
</div>
