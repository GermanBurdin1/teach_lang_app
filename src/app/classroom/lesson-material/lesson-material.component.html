<div class="container mt-4" [ngStyle]="{ 'backgroundImage': backgroundStyle, 'backgroundSize': 'cover' }">

  <!-- ğŸ”§ Ğ‘Ğ¾ĞºĞ¾Ğ²Ñ‹Ğµ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ -->
  <div class="side-tabs">
    <div class="tab-button left-tab" 
         (click)="lessonStarted ? null : toggleBoard()" 
         [class.active]="showBoard && !showGabarit"
         [class.disabled]="lessonStarted"
         [title]="lessonStarted ? 'Disponible aprÃ¨s connexion des Ã©tudiants' : 'Afficher le tableau'">
      ğŸ§‘â€ğŸ«
      <div class="label">Tableau interactif</div>
    </div>

    <div class="tab-button right-tab" 
         (click)="lessonStarted ? null : toggleGabarit()" 
         [class.active]="showGabarit"
         [class.disabled]="lessonStarted"
         [title]="lessonStarted ? 'Disponible aprÃ¨s connexion des Ã©tudiants' : 'Afficher les matÃ©riaux'">
      ğŸ“‚
      <div class="label">matÃ©riaux</div>
    </div>

    <!-- ğŸ‘¥ Nouvelle Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ° pour ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ°ÑÑĞ¾Ğ¼ -->
    <div class="tab-button top-tab" (click)="toggleClassManagement()" [class.active]="showClassManagement"
      title="Gestion de classe">
      ğŸ‘¥
      <div class="label">Gestion de classe</div>
    </div>
  </div>

  <div class="row justify-content-center align-items-start video-wrapper position-relative">

    <!-- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ²Ğ¸Ğ´ĞµĞ¾+Ğ´Ğ¾ÑĞºĞ° Ğ±Ğ»Ğ¾Ğº -->
    <div class="col-md-10 d-flex justify-content-center position-relative">

      <!-- ğŸ“‹ Ğ˜Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ´Ğ¾ÑĞºĞ° -->
      <app-interactive-board *ngIf="showBoard" class="whiteboard-layer position-absolute top-0 start-0 w-100 h-100">
      </app-interactive-board>

      <!-- ğŸ‘¨â€ğŸ“ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ»Ğ°ÑÑĞµ Ğ´Ğ»Ñ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² -->
      <div *ngIf="userRole === 'student'" class="student-class-info-panel">
        <div class="student-class-header">
          <h2>ğŸ“š Ma classe</h2>
        </div>

        <!-- Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ»Ğ°ÑÑĞµ -->
        <div *ngIf="studentClassInfo" class="student-class-card">
          <mat-card>
            <mat-card-header>
              <mat-card-title>{{ studentClassInfo.name }}</mat-card-title>
              <mat-card-subtitle>Niveau {{ studentClassInfo.level }}</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="class-details">
                <div class="detail-item">
                  <mat-icon>schedule</mat-icon>
                  <span>Statut: {{ studentClassInfo.status }}</span>
                </div>
                
                <div *ngIf="studentClassInfo.startTime" class="detail-item">
                  <mat-icon>access_time</mat-icon>
                  <span>DÃ©but: {{ studentClassInfo.startTime | date:'short' }}</span>
                </div>
                
                <div *ngIf="studentClassInfo.endTime" class="detail-item">
                  <mat-icon>access_time</mat-icon>
                  <span>Fin: {{ studentClassInfo.endTime | date:'short' }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸ÑÑ… -->
        <div *ngIf="hasUnreadInvitations()" class="persistent-invitation-notification">
          <mat-card class="invitation-card">
            <mat-card-content>
              <div class="invitation-header">
                <mat-icon class="invitation-icon">mail</mat-icon>
                <h3>Nouvelle invitation reÃ§ue!</h3>
              </div>
              <div class="invitation-content">
                <p *ngIf="pendingClassInvitations.length === 1">Vous avez reÃ§u une invitation Ã  rejoindre un cours.</p>
                <p *ngIf="pendingClassInvitations.length > 1">Vous avez reÃ§u {{ pendingClassInvitations.length }} invitations Ã  rejoindre des cours.</p>
                <div class="invitation-actions">
                  <button mat-raised-button color="primary" (click)="showInvitationDialogFromPanel()">
                    <mat-icon>visibility</mat-icon>
                    Voir l'invitation
                  </button>
                  <button mat-stroked-button (click)="dismissInvitationNotification()">
                    <mat-icon>close</mat-icon>
                    Masquer
                  </button>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»Ğµ -->
        <div *ngIf="teacherInfo" class="teacher-info-card">
          <mat-card>
            <mat-card-header>
              <mat-card-title>ğŸ‘¨â€ğŸ« Mon professeur</mat-card-title>
            </mat-card-header>
            
            <mat-card-content>
              <div class="teacher-details">
                <div class="detail-item">
                  <mat-icon>person</mat-icon>
                  <span>{{ teacherInfo.name }}</span>
                </div>
                
                <div class="detail-item">
                  <mat-icon>email</mat-icon>
                  <span>{{ teacherInfo.email }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚ Ğ½Ğµ ÑĞ¾ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ² ĞºĞ»Ğ°ÑÑĞµ -->
        <div *ngIf="!studentClassInfo" class="no-class-message">
          <mat-card>
            <mat-card-content>
              <div class="no-class-content">
                <mat-icon>school</mat-icon>
                <h3>Vous n'Ãªtes pas encore inscrit dans une classe</h3>
                <p>Contactez votre professeur pour Ãªtre ajoutÃ© Ã  une classe.</p>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ¶Ğ¸Ğ´Ğ°ÑÑ‰Ğ¸Ñ… Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ğ¹ -->
        <div *ngIf="pendingClassInvitations.length > 0" class="pending-invitations">
          <div class="invitations-header">
            <h3>ğŸ“¨ Invitations en attente</h3>
            <button mat-stroked-button (click)="checkAndShowUnreadInvitations()" class="show-invitations-btn">
              <mat-icon>refresh</mat-icon>
              Voir les invitations
            </button>
          </div>
          <div *ngFor="let invitation of pendingClassInvitations" class="invitation-item">
            <mat-card>
              <mat-card-content>
                <div class="invitation-content">
                  <div class="invitation-info">
                    <h4>{{ invitation.name }}</h4>
                    <p>Niveau: {{ invitation.level }}</p>
                    <p>Professeur: {{ invitation.teacherName }}</p>
                    <p *ngIf="invitation.description">{{ invitation.description }}</p>
                  </div>
                  <div class="invitation-actions">
                    <button mat-raised-button color="primary" (click)="acceptClassInvitationFromList(invitation)">
                      <mat-icon>check</mat-icon>
                      Accepter
                    </button>
                    <button mat-raised-button color="warn" (click)="rejectClassInvitationFromList(invitation)">
                      <mat-icon>close</mat-icon>
                      Refuser
                    </button>
                    <button mat-stroked-button (click)="showInvitationDialogAgain(invitation)">
                      <mat-icon>refresh</mat-icon>
                      Voir Ã  nouveau
                    </button>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </div>

      <!-- ğŸ¥ Ğ’Ğ¸Ğ´ĞµĞ¾ (Ñ€Ğ°ÑĞ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµÑ‚ÑÑ Ğ½Ğ¸Ğ¶Ğµ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ°ÑÑĞ¾Ğ¼) -->
      <app-video-call *ngIf="videoService.showVideoCall$ | async" [isFloatingMode]="false" class="main-video-container">
      </app-video-call>

      <!-- ğŸ‘¥ PiP Ğ¾ĞºĞ½Ğ° ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ Ğ·Ğ²Ğ¾Ğ½ĞºĞ° -->
      <div *ngIf="(videoService.showVideoCall$ | async) && lessonStarted && currentClass?.students" class="students-calling-overlay">
        <div *ngFor="let student of currentClass?.students" 
             class="student-calling-pip"
             [class.calling]="getStudentCallState(student.studentId) === 'calling'"
             [class.connected]="getStudentCallState(student.studentId) === 'connected'"
             [class.declined]="getStudentCallState(student.studentId) === 'declined'">
          
          <!-- ĞĞ²Ğ°Ñ‚Ğ°Ñ€ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° -->
          <div class="student-avatar">
            <div class="avatar-circle">
              {{ getStudentNameById(student.studentId).charAt(0).toUpperCase() }}
            </div>
          </div>
          
          <!-- Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğµ -->
          <div class="student-info">
            <div class="student-name">{{ getStudentNameById(student.studentId) }}</div>
            <div class="call-status">
              <span *ngIf="getStudentCallState(student.studentId) === 'calling'" class="calling-status">
                ğŸ“ Appel en cours...
              </span>
              <span *ngIf="getStudentCallState(student.studentId) === 'connected'" class="connected-status">
                âœ… ConnectÃ©
              </span>
              <span *ngIf="getStudentCallState(student.studentId) === 'declined'" class="declined-status">
                âŒ RefusÃ©
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- ğŸ“ Gabarit -->
      <app-gabarit-page *ngIf="showGabarit" [lesson]="getCurrentLessonForGabarit()" [readonly]="true"
        [lessonStarted]="lessonStarted" (openNotesEvent)="onGabaritOpenNotes($event)">

      </app-gabarit-page>

      <!-- ğŸ‘¥ ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ°ÑÑĞ¾Ğ¼ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹) -->
      <div *ngIf="showClassManagement && !isClassManagementCollapsed && userRole === 'teacher'" class="class-management-panel">
        <div class="class-header">
          <h2>ğŸ“ Gestion de classes DELF/DALF</h2>
          <button mat-raised-button color="primary" (click)="openCreateClassDialog()">
            â• CrÃ©er une nouvelle classe
          </button>
        </div>

        <!-- Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ ÑƒÑ€Ğ¾Ğ²Ğ½ÑĞ¼ -->
        <div class="level-stats" *ngIf="allTeacherClasses.length > 0">
          <h3>ğŸ“Š Statistiques par niveau</h3>
          <div class="stats-grid">
            <div *ngFor="let stat of getLevelStats()" class="stat-card" [style.background-color]="stat.color + '20'"
              [style.border-color]="stat.color" (click)="setLevelFilter(stat.count > 0 ? stat.level : null)">
              <div class="stat-level">{{ stat.level }}</div>
              <div class="stat-count">{{ stat.count }}</div>
              <div class="stat-label">classe(s)</div>
            </div>
          </div>
        </div>

        <!-- Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑƒÑ€Ğ¾Ğ²Ğ½ÑĞ¼ -->
        <div class="level-filter" *ngIf="allTeacherClasses.length > 0">
          <button mat-button [class.active]="selectedLevelFilter === null" (click)="setLevelFilter(null)">
            Tous les niveaux ({{ allTeacherClasses.length }})
          </button>
          <button *ngFor="let stat of getLevelStats()" mat-button [class.active]="selectedLevelFilter === stat.level"
            [style.color]="stat.count > 0 ? stat.color : '#ccc'" [disabled]="stat.count === 0"
            (click)="setLevelFilter(stat.level)">
            {{ stat.level }} ({{ stat.count }})
          </button>
        </div>

        <!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… ĞºĞ»Ğ°ÑÑĞ¾Ğ² -->
        <div class="classes-grid" *ngIf="getFilteredClasses().length > 0; else noClasses">
          <mat-card *ngFor="let cls of getFilteredClasses()" class="class-card"
            [class.selected]="currentClass?.id === cls.id" (click)="selectClass(cls)">

            <!-- Header ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ -->
            <mat-card-header>
              <div mat-card-avatar class="class-level-avatar" [style.background-color]="getLevelColor(cls.level)">
                {{ cls.level }}
              </div>
              <mat-card-title>{{ cls.name }}</mat-card-title>
              <mat-card-subtitle>
                Niveau {{ cls.level }} â€¢ {{ cls.students.length || 0 }}/{{ cls.maxStudents }} Ã©lÃ¨ves
              </mat-card-subtitle>
            </mat-card-header>

            <!-- Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ -->
            <mat-card-content>
              <p class="class-description">{{ cls.description }}</p>

              <!-- Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¸ Ğ´Ğ°Ñ‚Ğ° -->
              <div class="class-meta">
                <span class="status-badge" [style.background-color]="getClassStatusColor(cls.status)">
                  {{ getClassStatusText(cls.status) }}
                </span>
                <span class="scheduled-date">
                  ğŸ“… {{ formatScheduledDate(cls.scheduledAt) }}
                </span>
              </div>

              <!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² Ñ ĞºÑ€ĞµÑÑ‚Ğ¸ĞºĞ°Ğ¼Ğ¸ -->
              <div class="students-preview" *ngIf="cls.students && cls.students.length > 0">
                <h4>ğŸ‘¥ Ã‰lÃ¨ves inscrits:</h4>
                <div class="students-list">
                  <div *ngFor="let student of cls.students.slice(0, 3)" class="student-chip-with-remove">
                    <span class="student-name">{{ student.studentName || 'Ã‰lÃ¨ve' }}</span>
                    <button mat-icon-button 
                            class="remove-student-btn"
                            (click)="removeStudentFromClass(student); $event.stopPropagation()"
                            matTooltip="Retirer de la classe">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                  <span *ngIf="cls.students.length > 3" class="more-students">
                    +{{ cls.students.length - 3 }} autres
                  </span>
                </div>
              </div>
            </mat-card-content>

            <!-- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ -->
            <mat-card-actions>
              <!-- ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ -->
              <div class="main-actions">
                <button mat-raised-button color="primary" (click)="startVideoCall(); $event.stopPropagation()">
                  <mat-icon>play_arrow</mat-icon>
                  Commencer
                </button>
              </div>
              
              <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ°ÑÑĞ¾Ğ¼ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ°ÑÑĞ°) -->
              <div *ngIf="currentClass && currentClass.id === cls.id" class="class-management-section">
                <!-- Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑƒÑ€Ğ¾ĞºĞ° -->
                <div class="lesson-status-inline">
                  <span class="status-label">Statut:</span>
                  <span class="status-badge" [style.background-color]="getLessonStatusColor()">
                    {{ getLessonStatusText() }}
                  </span>
                  <span class="timer" *ngIf="lessonStarted && !lessonEnded">
                    â° {{ formatLessonTime() }}
                  </span>
                  <button *ngIf="lessonStarted" 
                          mat-icon-button 
                          color="warn" 
                          (click)="stopVideoCall(); $event.stopPropagation()"
                          matTooltip="ArrÃªter la vidÃ©o">
                    <mat-icon>stop</mat-icon>
                  </button>
                </div>
                
                <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ -->
                <div class="class-management-buttons">
                  <button mat-stroked-button (click)="inviteStudentsToClass(); $event.stopPropagation()">
                    ğŸ“¨ Inviter des Ã©lÃ¨ves
                  </button>
                  <button mat-stroked-button color="warn" (click)="deleteClass(); $event.stopPropagation()">
                    ğŸ—‘ï¸ Supprimer
                  </button>
                </div>
              </div>
            </mat-card-actions>
          </mat-card>
        </div>

        <!-- Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ ĞºĞ»Ğ°ÑÑĞ¾Ğ² -->
        <ng-template #noClasses>
          <div class="no-classes-message">
            <mat-card class="welcome-card">
              <mat-card-header>
                <mat-card-title>Bienvenue dans votre espace classes !</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <p>CrÃ©ez votre premiÃ¨re classe pour commencer Ã  enseigner le franÃ§ais (DELF/DALF)</p>
              <ul>
                <li>âœ… Organisez vos Ã©lÃ¨ves par niveau</li>
                <li>âœ… GÃ©rez les invitations d'Ã©lÃ¨ves</li>
                <li>âœ… Lancez des cours en ligne</li>
                <li>âœ… Suivez les progrÃ¨s de chaque Ã©lÃ¨ve</li>
              </ul>
            </mat-card-content>
          </mat-card>
        </div>
        </ng-template>


      </div>
                </div>

              </div>

  <!-- Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ñ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² -->
  <div *ngIf="showStudentsList" class="students-dialog-overlay">
    <mat-card class="students-dialog">
      <mat-card-header>
        <mat-card-title>ğŸ“¨ Inviter des Ã©lÃ¨ves Ã  la classe</mat-card-title>
        <button mat-icon-button (click)="closeStudentsList()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-header>
      
      <mat-card-content>
        <div class="invitation-info">
          <p><strong>Classe:</strong> {{ currentClass?.name }} ({{ currentClass?.level }})</p>
          <p><strong>Description:</strong> {{ currentClass?.description }}</p>
        </div>
        
        <div class="students-list">
          <div *ngFor="let student of availableStudents" 
               class="student-item"
               (click)="inviteStudentToClass(student)">
            <div class="student-info">
              <div class="student-name">{{ getStudentName(student) }}</div>
              <div class="student-email">{{ getStudentEmail(student) }}</div>
              <div class="student-level">Niveau: {{ getStudentLevel(student) }}</div>
            </div>
            <button mat-icon-button class="invite-button">
              <mat-icon>mail</mat-icon>
            </button>
          </div>
          
          <div *ngIf="availableStudents.length === 0" class="no-students">
            <p>Aucun Ã©lÃ¨ve disponible Ã  inviter</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

    <!-- ğŸ§© ĞĞ¸Ğ¶Ğ½ÑÑ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹ -->
    <div class="fixed-task-panel bg-light px-4 py-2" [class.collapsed]="tasksCollapsed">
      <div class="collapse-toggle" (click)="toggleTasksCollapsed()">
        {{ tasksCollapsed ? 'ğŸ”¼' : 'ğŸ”½' }}
      </div>

      <!-- Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ -->
      <div *ngIf="isLoadingData" class="loading-container text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Chargement des donnÃ©es du cours...</p>
      </div>

      <div *ngIf="!tasksCollapsed && !isLoadingData" class="d-flex justify-content-between">
        
        <!-- ğŸ‘¨â€ğŸ“ Ã‰tudiant -->
        <div class="student-zone w-50 pe-2">
          <h5 class="zone-header">ğŸ‘¨â€ğŸ“ Ã‰tudiant</h5>

          <!-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ¼ -->
          <div *ngIf="userRole === 'student' || userRole === 'teacher'" class="input-group mb-2">
            <input type="text" [(ngModel)]="newStudentTask" placeholder="Ajouter une tÃ¢che" class="form-control"
              (keyup.enter)="addStudentTask()" />
            <button class="btn btn-outline-primary" (click)="addStudentTask()">â•</button>
          </div>

          <div *ngIf="userRole === 'student' || userRole === 'teacher'" class="input-group mb-2">
            <input type="text" [(ngModel)]="newStudentQuestion" placeholder="Ajouter une question" class="form-control"
              (keyup.enter)="addStudentQuestion()" />
            <button class="btn btn-outline-info" (click)="addStudentQuestion()">â•</button>
          </div>

          <!-- ğŸ’¼ Bloc devoirs -->
          <div *ngIf="userRole === 'student' || userRole === 'teacher'" class="input-group mb-2">
          </div>

          <!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° -->
          <div class="section-header">ğŸ“ TÃ¢ches</div>
          <div *ngFor="let task of getCurrentLessonSafe()?.studentTasks" (mouseenter)="onHoverSafe(task, $event)"
            (mouseleave)="onLeaveItem()" class="position-relative">

            <div class="task-card student-task" [class.covered-in-class]="isCoveredInClassSafe(task)">
              <label class="task-label d-flex align-items-center">
                <span class="task-text">{{ getTaskTitle(task) }}</span>
                <div class="status-indicators ms-auto">
                <span *ngIf="isAddedToHomeworkSafe(task)" class="badge bg-success ms-1"
                  title="AjoutÃ© aux devoirs">ğŸ“‹</span>
                  <span *ngIf="isCoveredInClassSafe(task)" class="badge bg-info ms-1" title="TraitÃ© en classe">âœ…</span>
                <button *ngIf="lessonStarted && !isResolvedSafe(task)" class="btn btn-sm btn-outline-success ms-1"
                  (click)="markTaskAsCompletedSafe(task)" title="Marquer comme terminÃ©">
                    âœ…
                  </button>
                </div>
              </label>

              <!-- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ -->
              <div *ngIf="hoveredItem === task" class="item-actions" [ngClass]="{
                'drop-above': hoveredPosition === 'above',
                'drop-below': hoveredPosition === 'below'
              }" (mouseenter)="onEnterActions()" (mouseleave)="onLeaveActions()">
              <div class="action-item primary" (click)="lessonStarted && openNotesSafe('tasks', task, task)"
                [class.disabled]="!lessonStarted" [attr.tabindex]="lessonStarted ? 0 : -1"
                [attr.aria-disabled]="!lessonStarted">
                  ğŸ“ Travailler la tÃ¢che
                </div>
                <!-- <div class="action-item secondary" (click)="lessonStarted && addToHomework('task', task, task)" [class.disabled]="!lessonStarted" [attr.tabindex]="lessonStarted ? 0 : -1" [attr.aria-disabled]="!lessonStarted">
                  ğŸ“‹ Ajouter aux devoirs
                </div> -->
                <!-- Ğ—Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¹ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ -->
                <!--
                <div class="action-item" (click)="postpone(task)">â­ Revoir au prochain cours</div>
                <div class="action-item" (click)="goToMindmap(task)">ğŸ§  Mindmap</div>
                <div class="action-item" (click)="goToDictionary(task)">ğŸ“˜ Dictionnaire</div>
                -->
              </div>
            </div>
          </div>

          <!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° -->
          <div class="section-header">â“ Questions</div>
        <div *ngFor="let question of getCurrentLessonSafe()?.studentQuestions"
          (mouseenter)="onHoverSafe(question, $event)" (mouseleave)="onLeaveItem()" class="position-relative">

            <div class="question-card student-question" [class.covered-in-class]="isCoveredInClassSafe(question)">
              <label class="question-label d-flex align-items-center">
                <span class="question-text">{{ getQuestionText(question) }}</span>
                <div class="status-indicators ms-auto">
                <span *ngIf="isAddedToHomeworkSafe(question)" class="badge bg-success ms-1"
                  title="AjoutÃ© aux devoirs">ğŸ“‹</span>
                <span *ngIf="isCoveredInClassSafe(question)" class="badge bg-info ms-1"
                  title="TraitÃ© en classe">âœ…</span>
                <button *ngIf="lessonStarted && !isResolvedSafe(question)" class="btn btn-sm btn-outline-success ms-1"
                  (click)="markQuestionAsCompletedSafe(question)" title="Marquer comme terminÃ©">
                    âœ…
                  </button>
                </div>
              </label>

              <!-- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ -->
              <div *ngIf="hoveredItem === question" class="item-actions" [ngClass]="{
                'drop-above': hoveredPosition === 'above',
                'drop-below': hoveredPosition === 'below'
              }" (mouseenter)="onEnterActions()" (mouseleave)="onLeaveActions()">
              <div class="action-item primary" (click)="lessonStarted && openNotesSafe('questions', question, question)"
                [class.disabled]="!lessonStarted" [attr.tabindex]="lessonStarted ? 0 : -1"
                [attr.aria-disabled]="!lessonStarted">
                  â“ Travailler la question
                </div>
                <!-- <div class="action-item secondary" (click)="lessonStarted && addToHomework('question', question, question)" [class.disabled]="!lessonStarted" [attr.tabindex]="lessonStarted ? 0 : -1" [attr.aria-disabled]="!lessonStarted">
                  ğŸ“‹ Ajouter aux devoirs
                </div> -->
                <!-- Ğ—Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¹ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ -->
                <!--
                <div class="action-item" (click)="postponeQuestion(question)">â­ Revoir au prochain cours</div>
                <div class="action-item" (click)="goToMindmap(question)">ğŸ§  Mindmap</div>
                <div class="action-item" (click)="goToDictionary(question)">ğŸ“˜ Dictionnaire</div>
                -->
              </div>
            </div>
          </div>



          <!-- Ğ”Ğ¾Ğ¼Ğ°ÑˆĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ -->
        <div *ngIf="homeworkItems?.length || getCurrentLessonSafe()?.homework?.length" class="section-header">ğŸ“š Devoirs
        </div>
          
          <!-- Ğ”Ğ¾Ğ¼Ğ°ÑˆĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ· ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ (Ğ½Ğ¾Ğ²Ñ‹Ğµ) -->
          <div *ngIf="homeworkItems?.length" class="homework-list">
            <div *ngFor="let homework of homeworkItems" class="homework-item-card">
              <div class="homework-header">
                <span class="homework-title">{{ getHomeworkTitle(homework) }}</span>
              </div>
            <div *ngIf="hasHomeworkDescription(homework)" class="homework-description">{{
              getHomeworkDescription(homework) }}</div>
              <div class="homework-meta">
                <span class="homework-type">{{ getHomeworkType(homework) }}</span>
                <span class="homework-due">Ã‰chÃ©ance: {{ getHomeworkDueDate(homework) | date:'dd/MM/yyyy' }}</span>
              </div>
              <div class="homework-actions">
              <button
                *ngIf="lessonStarted && getHomeworkStatus(homework) !== 'finished' && !isHomeworkCompleted(homework)"
                class="btn btn-sm btn-success" (click)="markHomeworkAsCompleted(getHomeworkId(homework))">
                  âœ… Marquer comme terminÃ©
                </button>
                <span *ngIf="lessonStarted && getHomeworkStatus(homework) === 'finished' || isHomeworkCompleted(homework)" 
                      class="completed-badge">
                  âœ… TerminÃ©
                </span>
              </div>
            </div>
          </div>
          
          <!-- Ğ”Ğ¾Ğ¼Ğ°ÑˆĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ğ°Ñ€Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ (Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸) -->
          <div *ngIf="getCurrentLessonSafe()?.homework?.length" class="homework-list legacy">
            <div *ngFor="let hw of getCurrentLessonSafe()?.homework" class="homework-item">{{ hw }}</div>
          </div>
        </div>

        <!-- ğŸ‘©â€ğŸ« Enseignant -->
        <div class="teacher-zone w-50 ps-2">
          <h5 class="zone-header">ğŸ‘©â€ğŸ« Enseignant</h5>

          <!-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ -->
          <div *ngIf="userRole === 'teacher'" class="input-group mb-2">
          <input type="text" [(ngModel)]="newTeacherTask" placeholder="Ajouter une tÃ¢che pour moi" class="form-control"
            (keyup.enter)="addTeacherTask()" />
            <button class="btn btn-outline-warning" (click)="addTeacherTask()">â•</button>
          </div>

          <!-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ -->
          <div *ngIf="userRole === 'teacher'" class="input-group mb-2">
            <input type="text" [(ngModel)]="newTeacherQuestion" placeholder="Ajouter une question pour moi"
              class="form-control" (keyup.enter)="addTeacherQuestion()" />
            <button class="btn btn-outline-info" (click)="addTeacherQuestion()">â•</button>
          </div>

          <!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»Ñ -->
          <div class="section-header">ğŸ“ TÃ¢ches</div>
          <div *ngFor="let task of getCurrentLessonSafe()?.teacherTasks" (mouseenter)="onHoverSafe(task, $event)"
            (mouseleave)="onLeaveItem()" class="position-relative">

            <div class="task-card teacher-task" [class.covered-in-class]="isCoveredInClassSafe(task)">
              <label class="task-label d-flex align-items-center">
                <span class="task-text">{{ getTaskTitle(task) }}</span>
                <div class="status-indicators ms-auto">
                <span *ngIf="isAddedToHomeworkSafe(task)" class="badge bg-success ms-1"
                  title="AjoutÃ© aux devoirs">ğŸ“‹</span>
                  <span *ngIf="isCoveredInClassSafe(task)" class="badge bg-info ms-1" title="TraitÃ© en classe">âœ…</span>
                  <button *ngIf="lessonStarted && !isResolvedSafe(task) && userRole === 'teacher'" 
                  class="btn btn-sm btn-outline-success ms-1" (click)="markTaskAsCompletedSafe(task)"
                          title="Marquer comme terminÃ©">
                    âœ…
                  </button>
                </div>
              </label>

              <!-- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ -->
              <div *ngIf="hoveredItem === task && userRole === 'teacher'" class="item-actions" [ngClass]="{
                'drop-above': hoveredPosition === 'above',
                'drop-below': hoveredPosition === 'below'
              }" (mouseenter)="onEnterActions()" (mouseleave)="onLeaveActions()">
              <div class="action-item primary" (click)="lessonStarted && openNotesSafe('tasks', task, task)"
                [class.disabled]="!lessonStarted" [attr.tabindex]="lessonStarted ? 0 : -1"
                [attr.aria-disabled]="!lessonStarted">
                  ğŸ“ Travailler la tÃ¢che
                </div>
                <!-- Ğ—Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¹ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ -->
                <!--
                <div class="action-item" (click)="postpone(task)">â­ Revoir au prochain cours</div>
                <div class="action-item" (click)="goToMindmap(task)">ğŸ§  Mindmap</div>
                <div class="action-item" (click)="goToDictionary(task)">ğŸ“˜ Dictionnaire</div>
                -->
              </div>
            </div>
          </div>

          <!-- Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»Ñ -->
          <div class="section-header">â“ Questions</div>
        <div *ngFor="let question of getCurrentLessonSafe()?.teacherQuestions"
          (mouseenter)="onHoverSafe(question, $event)" (mouseleave)="onLeaveItem()" class="position-relative">

            <div class="question-card teacher-question" [class.covered-in-class]="isCoveredInClassSafe(question)">
              <label class="question-label d-flex align-items-center">
                <span class="question-text">{{ getQuestionText(question) }}</span>
                <div class="status-indicators ms-auto">
                <span *ngIf="isAddedToHomeworkSafe(question)" class="badge bg-success ms-1"
                  title="AjoutÃ© aux devoirs">ğŸ“‹</span>
                <span *ngIf="isCoveredInClassSafe(question)" class="badge bg-info ms-1"
                  title="TraitÃ© en classe">âœ…</span>
                  <span *ngIf="isResolvedSafe(question)">âœ…</span>
                </div>
              </label>

              <!-- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ -->
              <div *ngIf="hoveredItem === question && userRole === 'teacher'" class="item-actions" [ngClass]="{
                'drop-above': hoveredPosition === 'above',
                'drop-below': hoveredPosition === 'below'
              }" (mouseenter)="onEnterActions()" (mouseleave)="onLeaveActions()">
              <div class="action-item primary" (click)="lessonStarted && openNotesSafe('questions', question, question)"
                [class.disabled]="!lessonStarted" [attr.tabindex]="lessonStarted ? 0 : -1"
                [attr.aria-disabled]="!lessonStarted">
                  â“ Travailler la question
                </div>
                <!-- Ğ—Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¹ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ -->
                <!--
                <div class="action-item" (click)="postponeQuestion(question)">â­ Revoir au prochain cours</div>
                <div class="action-item" (click)="goToMindmap(question)">ğŸ§  Mindmap</div>
                <div class="action-item" (click)="goToDictionary(question)">ğŸ“˜ Dictionnaire</div>
                -->
              </div>
            </div>
          </div>



        </div>
      </div>
    </div>

  <!-- Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ñ Ğ² ĞºĞ»Ğ°ÑÑ -->
  <div *ngIf="showInvitationDialog && currentInvitation" class="invitation-dialog-overlay">
    <div class="invitation-dialog">
      <div class="dialog-header">
        <h2>ğŸ“¨ Invitation Ã  rejoindre une classe</h2>
        <button mat-icon-button (click)="closeInvitationWithoutResponse()" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="dialog-content">
        <div class="invitation-details">
          <div class="class-info">
            <h3>{{ currentInvitation.name }}</h3>
            <p class="level">Niveau: {{ currentInvitation.level }}</p>
            <p class="teacher">Professeur: {{ currentInvitation.teacherName }}</p>
            <p *ngIf="currentInvitation.description" class="description">{{ currentInvitation.description }}</p>
          </div>
          
          <div class="invitation-message">
            <p>Vous avez Ã©tÃ© invitÃ© Ã  rejoindre cette classe. Voulez-vous accepter cette invitation ?</p>
          </div>
        </div>
  </div>

      <div class="dialog-actions">
        <button mat-button (click)="rejectClassInvitation()" class="reject-button">
          <mat-icon>close</mat-icon>
          Refuser
        </button>
        <button mat-raised-button color="primary" (click)="acceptClassInvitation()" class="accept-button">
          <mat-icon>check</mat-icon>
          Accepter
    </button>
      </div>
    </div>
  </div>

</div>