<div class="container mt-4" [ngStyle]="{ 'backgroundImage': backgroundStyle, 'backgroundSize': 'cover' }">

  <!-- ğŸ”§ Ğ‘Ğ¾ĞºĞ¾Ğ²Ñ‹Ğµ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ -->
  <div class="side-tabs">
    <div class="tab-button left-tab" (click)="toggleBoard()" [class.active]="showBoard && !showGabarit"
      title="Afficher le tableau">
      ğŸ§‘â€ğŸ«
      <div class="label">Tableau interactif</div>
    </div>

    <div class="tab-button right-tab" (click)="toggleGabarit()" [class.active]="showGabarit"
      title="Afficher les matÃ©riaux">
      ğŸ“‚
      <div class="label">matÃ©riaux</div>
    </div>
  </div>

  <div class="row justify-content-center align-items-start video-wrapper position-relative">

    <!-- ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ²Ğ¸Ğ´ĞµĞ¾+Ğ´Ğ¾ÑĞºĞ° Ğ±Ğ»Ğ¾Ğº -->
    <div class="col-md-10 d-flex justify-content-center position-relative">

      <!-- ğŸ“‹ Ğ˜Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ´Ğ¾ÑĞºĞ° -->
      <app-interactive-board *ngIf="showBoard" class="whiteboard-layer position-absolute top-0 start-0 w-100 h-100">
      </app-interactive-board>

      <!-- ğŸ¥ Ğ’Ğ¸Ğ´ĞµĞ¾ -->
      <app-video-call *ngIf="videoService.showVideoCall$ | async" [isFloatingMode]="true" class="floating-video-layer">
      </app-video-call>

      <!-- ğŸ“ Gabarit -->
      <app-gabarit-page *ngIf="showGabarit" [lesson]="currentLesson" [readonly]="true">
      </app-gabarit-page>

    </div>

    <!-- ğŸ§© ĞĞ¸Ğ¶Ğ½ÑÑ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹ -->
    <div class="fixed-task-panel bg-light px-4 py-2" [class.collapsed]="tasksCollapsed">
      <div class="collapse-toggle" (click)="toggleTasksCollapsed()">
        {{ tasksCollapsed ? 'ğŸ”¼' : 'ğŸ”½' }}
      </div>

      <!-- Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ -->
      <div *ngIf="isLoadingData" class="loading-container text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑƒÑ€Ğ¾ĞºĞ°...</p>
      </div>

      <div *ngIf="!tasksCollapsed && !isLoadingData" class="d-flex justify-content-between">
        
        <!-- ğŸ‘¨â€ğŸ“ Ã‰tudiant -->
        <div class="student-zone w-50 pe-2">
          <h5 class="zone-header">ğŸ‘¨â€ğŸ“ Ã‰tudiant</h5>

          <!-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ¼ -->
          <div *ngIf="userRole === 'student' || userRole === 'teacher'" class="input-group mb-2">
            <input type="text" [(ngModel)]="newStudentTask" placeholder="Ajouter une tÃ¢che" class="form-control"
              (keyup.enter)="addStudentTask()" />
            <button class="btn btn-outline-primary" (click)="addStudentTask()">â•</button>
          </div>

          <div *ngIf="userRole === 'student' || userRole === 'teacher'" class="input-group mb-2">
            <input type="text" [(ngModel)]="newStudentQuestion" placeholder="Ajouter une question" class="form-control"
              (keyup.enter)="addStudentQuestion()" />
            <button class="btn btn-outline-info" (click)="addStudentQuestion()">â•</button>
          </div>

          <!-- ğŸ’¼ Bloc devoirs -->
          <div *ngIf="userRole === 'student' || userRole === 'teacher'" class="input-group mb-2">
            <input type="text" [(ngModel)]="newHomeworkEntry" placeholder="Ajouter un devoir" class="form-control"
              (keyup.enter)="submitHomework()" />
            <button class="btn btn-outline-secondary" (click)="submitHomework()">ğŸ“š</button>
          </div>

          <!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° -->
          <div class="section-header">ğŸ“ TÃ¢ches</div>
          <div *ngFor="let task of currentLesson?.studentTasks" (mouseenter)="onHover(task, $event)"
            (mouseleave)="hoveredItem = null" class="position-relative">

            <div class="task-card student-task">
              <label class="task-label d-flex align-items-center">
                <input type="checkbox" class="me-2" [checked]="isResolved(task)"
                  (change)="toggleResolved(task, 'task')" />
                <span class="task-text">{{ task }}</span>
              </label>

              <!-- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ -->
              <div *ngIf="hoveredItem === task" class="item-actions" [ngClass]="{
                'drop-above': hoveredPosition === 'above',
                'drop-below': hoveredPosition === 'below'
              }">
                <div class="action-item primary" (click)="openNotes('tasks', task, task)">
                  ğŸ“ ĞÑ‚Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ
                </div>
                <!-- Ğ—Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¹ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ -->
                <!--
                <div class="action-item" (click)="postpone(task)">â­ Revoir au prochain cours</div>
                <div class="action-item" (click)="goToMindmap(task)">ğŸ§  Mindmap</div>
                <div class="action-item" (click)="goToDictionary(task)">ğŸ“˜ Dictionnaire</div>
                -->
              </div>
            </div>
          </div>

          <!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° -->
          <div class="section-header">â“ Questions</div>
          <div *ngFor="let question of currentLesson?.studentQuestions" (mouseenter)="onHover(question, $event)"
            (mouseleave)="hoveredItem = null" class="position-relative">

            <div class="question-card student-question">
              <label class="question-label d-flex align-items-center">
                <input type="checkbox" class="me-2" [checked]="isResolved(question)"
                  (change)="toggleResolved(question, 'question')" />
                <span class="question-text">{{ question }}</span>
              </label>

              <!-- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ -->
              <div *ngIf="hoveredItem === question" class="item-actions" [ngClass]="{
                'drop-above': hoveredPosition === 'above',
                'drop-below': hoveredPosition === 'below'
              }">
                <div class="action-item primary" (click)="openNotes('questions', question, question)">
                  â“ ĞÑ‚Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ
                </div>
                <!-- Ğ—Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¹ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ -->
                <!--
                <div class="action-item" (click)="postponeQuestion(question)">â­ Revoir au prochain cours</div>
                <div class="action-item" (click)="goToMindmap(question)">ğŸ§  Mindmap</div>
                <div class="action-item" (click)="goToDictionary(question)">ğŸ“˜ Dictionnaire</div>
                -->
              </div>
            </div>
          </div>

          <!-- ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° -->
          <div class="section-header">ğŸ“š MatÃ©riaux</div>
          <div *ngFor="let material of getStudentMaterials()" 
            (mouseenter)="onHover(material.title, $event)" (mouseleave)="hoveredItem = null" class="position-relative">

            <div class="material-card student-material">
              <div class="material-header">
                <span class="material-icon">{{ getMaterialIcon(material.type) }}</span>
                <span class="material-title">{{ material.title }}</span>
                <span class="material-type">{{ material.type }}</span>
              </div>

              <!-- Content based on material type -->
              <div class="material-content">
                <!-- Text Content -->
                <div *ngIf="material.type === 'text'" class="text-content">
                  <div class="text-preview">{{ material.content | slice:0:100 }}...</div>
                </div>

                <!-- Audio Content -->
                <div *ngIf="material.type === 'audio'" class="audio-content">
                  <audio controls class="audio-player" [src]="material.content" preload="metadata">
                    Votre navigateur ne supporte pas l'Ã©lÃ©ment audio.
                  </audio>
                </div>

                <!-- Video Content -->
                <div *ngIf="material.type === 'video'" class="video-content">
                  <video controls class="video-player" [src]="material.content" preload="metadata">
                    Votre navigateur ne supporte pas l'Ã©lÃ©ment vidÃ©o.
                  </video>
                </div>

                <!-- PDF Content -->
                <div *ngIf="material.type === 'pdf'" class="pdf-content">
                  <a [href]="material.content" target="_blank" class="pdf-link">
                    ğŸ“„ Ouvrir le PDF
                  </a>
                </div>

                <!-- Image Content -->
                <div *ngIf="material.type === 'image'" class="image-content">
                  <img [src]="material.content" [alt]="material.title" class="material-image" loading="lazy">
                </div>
              </div>

              <!-- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ -->
              <div *ngIf="hoveredItem === material.title" class="item-actions" [ngClass]="{
                'drop-above': hoveredPosition === 'above',
                'drop-below': hoveredPosition === 'below'
              }">
                <div class="action-item primary" (click)="openNotes('materials', material.id, material.title)">
                  ğŸ“š ĞÑ‚Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ» Ğ² ĞºĞ¾Ğ½ÑĞ¿ĞµĞºÑ‚Ğµ
                </div>
              </div>
            </div>
          </div>

          <!-- Ğ”Ğ¾Ğ¼Ğ°ÑˆĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ -->
          <div *ngIf="currentLesson?.homework?.length" class="section-header">ğŸ“š Devoirs</div>
          <div *ngIf="currentLesson?.homework?.length" class="homework-list">
            <div *ngFor="let hw of currentLesson.homework" class="homework-item">{{ hw }}</div>
          </div>
        </div>

        <!-- ğŸ‘©â€ğŸ« Enseignant -->
        <div class="teacher-zone w-50 ps-2">
          <h5 class="zone-header">ğŸ‘©â€ğŸ« Enseignant</h5>

          <!-- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ -->
          <div *ngIf="userRole === 'teacher'" class="input-group mb-2">
            <input type="text" [(ngModel)]="newTeacherTask" placeholder="Ajouter une tÃ¢che Ğ´Ğ»Ñ ÑĞµĞ±Ñ"
              class="form-control" (keyup.enter)="addTeacherTask()" />
            <button class="btn btn-outline-warning" (click)="addTeacherTask()">â•</button>
          </div>

          <!-- Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»Ñ -->
          <div class="section-header">ğŸ“ TÃ¢ches</div>
          <div *ngFor="let task of currentLesson?.teacherTasks" (mouseenter)="onHover(task, $event)"
            (mouseleave)="hoveredItem = null" class="position-relative">

            <div class="task-card teacher-task">
              <label class="task-label d-flex align-items-center">
                <input type="checkbox" class="me-2" [checked]="isResolved(task)" (change)="toggleResolved(task, 'task')"
                  [disabled]="userRole === 'student'" />
                <span class="task-text">{{ task }}</span>
              </label>

              <!-- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ -->
              <div *ngIf="hoveredItem === task && userRole === 'teacher'" class="item-actions" [ngClass]="{
                'drop-above': hoveredPosition === 'above',
                'drop-below': hoveredPosition === 'below'
              }">
                <div class="action-item primary" (click)="openNotes('tasks', task, task)">
                  ğŸ“ ĞÑ‚Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ
                </div>
                <div class="action-item" (click)="addToHomework(task)">ğŸ“š Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Ğ´Ğ¾Ğ¼Ğ°ÑˆĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ</div>
                <!-- Ğ—Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¹ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ -->
                <!--
                <div class="action-item" (click)="postpone(task)">â­ Revoir au prochain cours</div>
                <div class="action-item" (click)="goToMindmap(task)">ğŸ§  Mindmap</div>
                <div class="action-item" (click)="goToDictionary(task)">ğŸ“˜ Dictionnaire</div>
                -->
              </div>
            </div>
          </div>

          <!-- Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»Ñ -->
          <div class="section-header">â“ Questions</div>
          <div *ngFor="let question of currentLesson?.teacherQuestions" (mouseenter)="onHover(question, $event)"
            (mouseleave)="hoveredItem = null" class="position-relative">

            <div class="question-card teacher-question">
              <label class="question-label d-flex align-items-center">
                <input type="checkbox" class="me-2" [checked]="isResolved(question)"
                  (change)="toggleResolved(question, 'question')" [disabled]="userRole === 'student'" />
                <span class="question-text">{{ question }}</span>
              </label>

              <!-- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ -->
              <div *ngIf="hoveredItem === question && userRole === 'teacher'" class="item-actions" [ngClass]="{
                'drop-above': hoveredPosition === 'above',
                'drop-below': hoveredPosition === 'below'
              }">
                <div class="action-item primary" (click)="openNotes('questions', question, question)">
                  â“ ĞÑ‚Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ
                </div>
                <!-- Ğ—Ğ°ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¹ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ -->
                <!--
                <div class="action-item" (click)="postponeQuestion(question)">â­ Revoir au prochain cours</div>
                <div class="action-item" (click)="goToMindmap(question)">ğŸ§  Mindmap</div>
                <div class="action-item" (click)="goToDictionary(question)">ğŸ“˜ Dictionnaire</div>
                -->
              </div>
            </div>
          </div>

          <!-- ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹ Ğ¿Ñ€ĞµĞ¿Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ĞµĞ»Ñ -->
          <div class="section-header">ğŸ“š MatÃ©riaux</div>
          <div *ngFor="let material of getTeacherMaterials()" 
            (mouseenter)="onHover(material.title, $event)" (mouseleave)="hoveredItem = null" class="position-relative">

            <div class="material-card teacher-material">
              <div class="material-header">
                <span class="material-icon">{{ getMaterialIcon(material.type) }}</span>
                <span class="material-title">{{ material.title }}</span>
                <span class="material-type">{{ material.type }}</span>
              </div>

              <!-- Content based on material type -->
              <div class="material-content">
                <!-- Text Content -->
                <div *ngIf="material.type === 'text'" class="text-content">
                  <div class="text-preview">{{ material.content | slice:0:100 }}...</div>
                </div>

                <!-- Audio Content -->
                <div *ngIf="material.type === 'audio'" class="audio-content">
                  <audio controls class="audio-player" [src]="material.content" preload="metadata">
                    Votre navigateur ne supporte pas l'Ã©lÃ©ment audio.
                  </audio>
                </div>

                <!-- Video Content -->
                <div *ngIf="material.type === 'video'" class="video-content">
                  <video controls class="video-player" [src]="material.content" preload="metadata">
                    Votre navigateur ne supporte pas l'Ã©lÃ©ment vidÃ©o.
                  </video>
                </div>

                <!-- PDF Content -->
                <div *ngIf="material.type === 'pdf'" class="pdf-content">
                  <a [href]="material.content" target="_blank" class="pdf-link">
                    ğŸ“„ Ouvrir le PDF
                  </a>
                </div>

                <!-- Image Content -->
                <div *ngIf="material.type === 'image'" class="image-content">
                  <img [src]="material.content" [alt]="material.title" class="material-image" loading="lazy">
                </div>
              </div>

              <!-- Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ -->
              <div *ngIf="hoveredItem === material.title" class="item-actions" [ngClass]="{
                'drop-above': hoveredPosition === 'above',
                'drop-below': hoveredPosition === 'below'
              }">
                <div class="action-item primary" (click)="openNotes('materials', material.id, material.title)">
                  ğŸ“š ĞÑ‚Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ» Ğ² ĞºĞ¾Ğ½ÑĞ¿ĞµĞºÑ‚Ğµ
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>
