<div class="lesson-notes-modal">
  <div class="modal-header">
    <h2 class="modal-title">
      <span class="section-icon">ğŸ“‹</span>
      Notes de cours
    </h2>
    <button mat-icon-button (click)="onClose()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="modal-content">
    <div class="item-info">
      <h4>{{ data.itemText }}</h4>
      <small class="text-muted">{{ getSectionTitle() }}</small>
    </div>

    <!-- on affiche toujours 3 sections -->
    <div class="sections-container">
      
      <!-- section des tÃ¢ches -->
      <div class="notes-section" [class.blur]="data.section !== 'tasks'">
        <h5 class="section-header" [class.active]="data.section === 'tasks'">
          ğŸ“ TÃ¢ches
        </h5>
        
        <!-- liste des tÃ¢ches Ã©tudiant -->
        <div class="items-list" *ngIf="data.lessonData?.studentTasks?.length">
          <h6 class="subsection-title">ğŸ‘©â€ğŸ“ TÃ¢ches de l'Ã©tudiant</h6>
          <div class="item-container" *ngFor="let task of (data.lessonData?.studentTasks || []); let i = index"
               [class.highlighted]="data.section === 'tasks' && isCurrentItem('student-task-' + i)">
            <div class="item-title">{{ task }}</div>
            <mat-form-field class="item-textarea" appearance="outline" *ngIf="data.section === 'tasks' && isCurrentItem('student-task-' + i)">
              <mat-label>Notes sur cette tÃ¢che</mat-label>
              <textarea 
                matInput 
                [(ngModel)]="tasksContent"
                (ngModelChange)="onTasksContentChange($event)"
                placeholder="Notes sur la rÃ©solution de cette tÃ¢che..."
                rows="3">
              </textarea>
            </mat-form-field>
          </div>
        </div>

        <!-- liste des tÃ¢ches professeur -->
        <div class="items-list" *ngIf="data.lessonData?.teacherTasks?.length">
          <h6 class="subsection-title">ğŸ‘©â€ğŸ« TÃ¢ches du professeur</h6>
          <div class="item-container" *ngFor="let task of (data.lessonData?.teacherTasks || []); let i = index"
               [class.highlighted]="data.section === 'tasks' && isCurrentItem('teacher-task-' + i)">
            <div class="item-title">{{ task }}</div>
            <mat-form-field class="item-textarea" appearance="outline" *ngIf="data.section === 'tasks' && isCurrentItem('teacher-task-' + i)">
              <mat-label>Notes sur cette tÃ¢che</mat-label>
              <textarea 
                matInput 
                [(ngModel)]="tasksContent"
                (ngModelChange)="onTasksContentChange($event)"
                placeholder="Notes sur la rÃ©solution de cette tÃ¢che..."
                rows="3">
              </textarea>
            </mat-form-field>
          </div>
        </div>

        <!-- fallback pour notes gÃ©nÃ©rales sur les tÃ¢ches -->
        <mat-form-field class="full-width" appearance="outline" *ngIf="data.section !== 'tasks' || (!data.lessonData?.studentTasks?.length && !data.lessonData?.teacherTasks?.length)">
          <mat-label>Notes gÃ©nÃ©rales sur les tÃ¢ches</mat-label>
          <textarea 
            matInput 
            [(ngModel)]="tasksContent"
            [disabled]="data.section !== 'tasks'"
            placeholder="Notes gÃ©nÃ©rales sur les tÃ¢ches..."
            rows="4">
          </textarea>
        </mat-form-field>
      </div>

      <!-- section des questions -->
      <div class="notes-section" [class.blur]="data.section !== 'questions'">
        <h5 class="section-header" [class.active]="data.section === 'questions'">
          â“ Questions
        </h5>
        
        <!-- liste des questions Ã©tudiant -->
        <div class="items-list" *ngIf="data.lessonData?.studentQuestions?.length">
          <h6 class="subsection-title">ğŸ‘©â€ğŸ“ Questions de l'Ã©tudiant</h6>
          <div class="item-container" *ngFor="let question of (data.lessonData?.studentQuestions || []); let i = index"
               [class.highlighted]="data.section === 'questions' && isCurrentItem('student-question-' + i)">
            <div class="item-title">{{ question }}</div>
            <mat-form-field class="item-textarea" appearance="outline" *ngIf="data.section === 'questions' && isCurrentItem('student-question-' + i)">
              <mat-label>RÃ©ponse Ã  cette question</mat-label>
              <textarea 
                matInput 
                [(ngModel)]="questionsContent"
                (ngModelChange)="onQuestionsContentChange($event)"
                placeholder="RÃ©ponse et explications pour cette question..."
                rows="3">
              </textarea>
            </mat-form-field>
          </div>
        </div>

        <!-- liste des questions professeur -->
        <div class="items-list" *ngIf="data.lessonData?.teacherQuestions?.length">
          <h6 class="subsection-title">ğŸ‘©â€ğŸ« Questions du professeur</h6>
          <div class="item-container" *ngFor="let question of (data.lessonData?.teacherQuestions || []); let i = index"
               [class.highlighted]="data.section === 'questions' && isCurrentItem('teacher-question-' + i)">
            <div class="item-title">{{ question }}</div>
            <mat-form-field class="item-textarea" appearance="outline" *ngIf="data.section === 'questions' && isCurrentItem('teacher-question-' + i)">
              <mat-label>RÃ©ponse Ã  cette question</mat-label>
              <textarea 
                matInput 
                [(ngModel)]="questionsContent"
                (ngModelChange)="onQuestionsContentChange($event)"
                placeholder="RÃ©ponse et explications pour cette question..."
                rows="3">
              </textarea>
            </mat-form-field>
          </div>
        </div>

        <!-- fallback pour notes gÃ©nÃ©rales sur les questions -->
        <mat-form-field class="full-width" appearance="outline" *ngIf="data.section !== 'questions' || (!data.lessonData?.studentQuestions?.length && !data.lessonData?.teacherQuestions?.length)">
          <mat-label>Notes gÃ©nÃ©rales sur les questions</mat-label>
          <textarea 
            matInput 
            [(ngModel)]="questionsContent"
            [disabled]="data.section !== 'questions'"
            placeholder="Notes gÃ©nÃ©rales sur les questions..."
            rows="4">
          </textarea>
        </mat-form-field>
      </div>

      <!-- section des matÃ©riaux -->
      <div class="notes-section" [class.blur]="data.section !== 'materials'">
        <h5 class="section-header" [class.active]="data.section === 'materials'">
          ğŸ“š MatÃ©riaux
        </h5>
        
        <!-- liste des matÃ©riaux -->
        <div class="items-list" *ngIf="data.lessonData?.materials?.length">
          <div class="item-container" *ngFor="let material of (data.lessonData?.materials || []); let i = index"
               [class.highlighted]="data.section === 'materials' && isCurrentItem(getMaterialId(material))">
            <div class="item-title">
              <span class="material-icon">{{ getMaterialTypeIcon(material?.type || 'text') }}</span>
              {{ material?.title || 'MatÃ©riau' }}
              <span class="material-type-badge">{{ material?.type || 'text' }}</span>
            </div>
            <mat-form-field class="item-textarea" appearance="outline" *ngIf="data.section === 'materials' && isCurrentItem(getMaterialId(material))">
              <mat-label>Notes sur ce matÃ©riau</mat-label>
              <textarea 
                matInput 
                [(ngModel)]="materialsContent"
                (ngModelChange)="onMaterialsContentChange($event)"
                placeholder="Notes sur ce matÃ©riau, points clÃ©s, conclusions..."
                rows="3">
              </textarea>
            </mat-form-field>
          </div>
        </div>

        <!-- fallback pour notes gÃ©nÃ©rales sur les matÃ©riaux -->
        <mat-form-field class="full-width" appearance="outline" *ngIf="data.section !== 'materials' || !data.lessonData?.materials?.length">
          <mat-label>Notes gÃ©nÃ©rales sur les matÃ©riaux</mat-label>
        <textarea 
          matInput 
            [(ngModel)]="materialsContent"
            [disabled]="data.section !== 'materials'"
            placeholder="Notes gÃ©nÃ©rales sur les matÃ©riaux..."
            rows="4">
        </textarea>
      </mat-form-field>
      </div>

    </div>

    <div class="save-status" *ngIf="lastSaved || isSaving">
      <mat-icon *ngIf="isSaving" class="saving-icon spin">sync</mat-icon>
      <mat-icon *ngIf="!isSaving && lastSaved" class="saved-icon">check_circle</mat-icon>
      <span *ngIf="isSaving">Sauvegarde...</span>
      <span *ngIf="!isSaving && lastSaved">
        SauvegardÃ© {{ getFormattedDate() }}
      </span>
    </div>
  </div>

  <div class="modal-actions">
    <button mat-button (click)="onClose()" class="cancel-btn">
      Fermer
    </button>
    <button mat-raised-button color="primary" (click)="onSave()" class="save-btn">
      <mat-icon>save</mat-icon>
      Sauvegarder
    </button>
  </div>
</div> 